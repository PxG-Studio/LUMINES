name: Quality Gates

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      # Quality Gate 1: Test Coverage
      - name: Run tests with coverage
        id: test-coverage
        run: |
          npm run test:coverage
          
          # Extract coverage percentage
          COVERAGE=$(npm run test:coverage 2>&1 | grep -oP 'All files\s+\|\s+\d+\.\d+%' | grep -oP '\d+\.\d+' | head -1 || echo "0")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          
          # Check if coverage meets threshold (80%)
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "❌ Test coverage ($COVERAGE%) is below threshold (80%)"
            exit 1
          else
            echo "✅ Test coverage ($COVERAGE%) meets threshold (80%)"
          fi
        continue-on-error: false
      
      # Quality Gate 2: Security Scan
      - name: Run security audit
        id: security-audit
        run: |
          npm audit --audit-level=moderate || true
          
          # Check for critical vulnerabilities
          CRITICAL=$(npm audit --audit-level=critical --json 2>/dev/null | jq -r '.metadata.vulnerabilities.critical // 0')
          HIGH=$(npm audit --audit-level=high --json 2>/dev/null | jq -r '.metadata.vulnerabilities.high // 0')
          
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 10 ]; then
            echo "❌ Security audit failed: $CRITICAL critical, $HIGH high vulnerabilities"
            exit 1
          else
            echo "✅ Security audit passed: $CRITICAL critical, $HIGH high vulnerabilities"
          fi
        continue-on-error: false
      
      # Quality Gate 3: Code Quality
      - name: Run linting
        id: lint
        run: |
          npm run lint:eslint || {
            echo "❌ Linting failed"
            exit 1
          }
          echo "✅ Linting passed"
        continue-on-error: false
      
      - name: Check formatting
        id: format
        run: |
          npm run format || {
            echo "❌ Formatting check failed"
            exit 1
          }
          echo "✅ Formatting check passed"
        continue-on-error: false
      
      # Quality Gate 4: Type Checking
      - name: Run type check
        id: typecheck
        run: |
          npm run typecheck || {
            echo "❌ Type checking failed"
            exit 1
          }
          echo "✅ Type checking passed"
        continue-on-error: false
      
      # Quality Gate 5: Build Success
      - name: Build application
        id: build
        run: |
          npm run build || {
            echo "❌ Build failed"
            exit 1
          }
          echo "✅ Build passed"
        continue-on-error: false
      
      # Quality Gate 6: Performance Benchmarks
      - name: Check bundle size
        id: bundle-size
        run: |
          npm run build
          
          # Check Next.js build output size
          BUILD_SIZE=$(du -sh .next 2>/dev/null | cut -f1 || echo "0")
          echo "build_size=$BUILD_SIZE" >> $GITHUB_OUTPUT
          
          # Check if build size is reasonable (less than 50MB)
          BUILD_SIZE_BYTES=$(du -sb .next 2>/dev/null | cut -f1 || echo "0")
          MAX_SIZE=$((50 * 1024 * 1024)) # 50MB
          
          if [ "$BUILD_SIZE_BYTES" -gt "$MAX_SIZE" ]; then
            echo "⚠️  Build size ($BUILD_SIZE) exceeds recommended size (50MB)"
            # Warning only, not blocking
          else
            echo "✅ Build size ($BUILD_SIZE) is acceptable"
          fi
        continue-on-error: true
      
      # Summary
      - name: Quality Gates Summary
        if: always()
        run: |
          echo "## Quality Gates Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test Coverage | ${{ steps.test-coverage.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ${{ steps.security-audit.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linting | ${{ steps.lint.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Formatting | ${{ steps.format.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ${{ steps.typecheck.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.build.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.test-coverage.outcome }}" != "success" ] || \
             [ "${{ steps.security-audit.outcome }}" != "success" ] || \
             [ "${{ steps.lint.outcome }}" != "success" ] || \
             [ "${{ steps.format.outcome }}" != "success" ] || \
             [ "${{ steps.typecheck.outcome }}" != "success" ] || \
             [ "${{ steps.build.outcome }}" != "success" ]; then
            echo "❌ **Quality gates failed. Please fix the issues above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ **All quality gates passed!**" >> $GITHUB_STEP_SUMMARY
          fi


