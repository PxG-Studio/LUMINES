"use strict";(()=>{var e={};e.id=7535,e.ids=[7535],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},66083:e=>{e.exports=require("stream/web")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},20863:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>S,requestAsyncStorage:()=>j,routeModule:()=>v,serverHooks:()=>b,staticGenerationAsyncStorage:()=>w});var s={};r.r(s),r.d(s,{GET:()=>g,POST:()=>x});var n=r(49303),a=r(88716),o=r(60670),i=r(87070),l=r(41567),d=r(86420),c=r(97875),u=r(27793),p=r(68367),m=r(89708),f=r(91585),h=r(26033);let y=f.Ry({projectId:f.Z_(),userId:f.Z_(),buildId:f.Z_().optional(),environment:f.Km(["staging","production"]).default("staging"),version:f.Z_().min(1)});async function g(e){let t=await (0,c.mk)(e);if(t.error)return i.NextResponse.json({error:t.error.message},{status:t.error.status});let s=await (0,c.rateLimit)(e,t.request.user?.id);if(s.error)return i.NextResponse.json({error:s.error.message},{status:s.error.status,headers:s.error.headers});try{let t=e.nextUrl.searchParams,s=t.get("projectId"),n=t.get("userId");if(s&&!t.has("page")&&!t.has("sort")){let e=await l.SX.findByProjectId(s),t=i.NextResponse.json(e);return(0,m.vm)(t)}if(n&&!t.has("page")&&!t.has("sort")){let e=await l.SX.findByUserId(n),t=i.NextResponse.json(e);return(0,m.vm)(t)}let a=(0,u.dr)(e),o=(0,p.ik)(e),d=(0,p.gX)(e);s&&(o.projectId=s),n&&(o.userId=n);let c=(0,p.Ye)(o,["projectId","userId","status","environment","version","createdAt","updatedAt","deployedAt"]);if(!c.valid){let e=i.NextResponse.json({error:"Invalid filter parameters",details:c.errors},{status:400});return(0,m.vm)(e)}let f=(0,p.M1)(o),h=(0,p.SI)(d,{field:"createdAt",direction:"desc"}),{prisma:y}=await Promise.resolve().then(r.bind(r,64199)),g=await y.deployment.count({where:f}),x=await y.deployment.findMany({where:f,orderBy:h,skip:a.offset,take:a.limit,include:{project:{select:{id:!0,name:!0,slug:!0}},user:{select:{id:!0,email:!0,name:!0}}}}),v=(0,u.q6)(x,g,a),j=i.NextResponse.json(v);return(0,u.jM)(j,a,g),(0,m.vm)(j)}catch(t){console.error("Error fetching deployments:",t);let e=i.NextResponse.json({error:"Internal server error"},{status:500});return(0,m.vm)(e)}}async function x(e){let t=await (0,c.mk)(e);if(t.error)return i.NextResponse.json({error:t.error.message},{status:t.error.status});let r=await (0,c.rateLimit)(e,t.request.user?.id);if(r.error)return i.NextResponse.json({error:r.error.message},{status:r.error.status,headers:r.error.headers});try{let t=await e.json(),r=y.parse(t);if(!await l.WJ.findById(r.projectId))return i.NextResponse.json({error:"Project not found"},{status:404});if(r.buildId&&!await l.Gi.findById(r.buildId))return i.NextResponse.json({error:"Build not found"},{status:404});let s=await l.SX.create({project:{connect:{id:r.projectId}},user:{connect:{id:r.userId}},build:r.buildId?{connect:{id:r.buildId}}:void 0,environment:r.environment,version:r.version,status:"pending"});await d.O4.started({deploymentId:s.id,projectId:r.projectId}),await l.nI.create({type:"deployment.started",subsystem:"waypoint",userId:r.userId,projectId:r.projectId,deploymentId:s.id,payload:{environment:r.environment,version:r.version}});let n=i.NextResponse.json(s,{status:201});return(0,m.vm)(n)}catch(t){if(t instanceof h.jm){let e=i.NextResponse.json({error:"Validation error",details:t.errors},{status:400});return(0,m.vm)(e)}console.error("Error creating deployment:",t);let e=i.NextResponse.json({error:"Internal server error"},{status:500});return(0,m.vm)(e)}}f.Ry({status:f.Km(["pending","deploying","live","failed","rolled_back"]).optional(),url:f.Z_().url().optional(),error:f.Z_().optional()});let v=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/deployments/route",pathname:"/api/deployments",filename:"route",bundlePath:"app/api/deployments/route"},resolvedPagePath:"/home/cursor-dev/Documents/Lumines/src/app/api/deployments/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:j,staticGenerationAsyncStorage:w,serverHooks:b}=v,I="/api/deployments/route";function S(){return(0,o.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:w})}},68367:(e,t,r)=>{function s(e){let t=e.nextUrl.searchParams,r={};for(let[e,s]of t.entries())if("page"!==e&&"limit"!==e&&"sort"!==e&&"order"!==e){if(r[e]){let t=r[e];Array.isArray(t)?t.push(s):r[e]=[t,s]}else r[e]=s}return r}function n(e){let t=e.nextUrl.searchParams,r=t.get("sort"),s=t.get("order")||"asc";return r?{field:r,direction:"desc"===s.toLowerCase()?"desc":"asc"}:null}function a(e){let t={};for(let[r,s]of Object.entries(e))if(null!=s){if(Array.isArray(s))t[r]={in:s};else if(r.endsWith("_from")){let e=r.replace("_from","");t[e]||(t[e]={}),t[e].gte=new Date(s)}else if(r.endsWith("_to")){let e=r.replace("_to","");t[e]||(t[e]={}),t[e].lte=new Date(s)}else r.endsWith("_search")?t[r.replace("_search","")]={contains:s,mode:"insensitive"}:t[r]=s}return t}function o(e,t){if(!e&&!t)return{createdAt:"desc"};let r=e||t;return r?{[r.field]:r.direction}:{}}function i(e,t){let r=[];for(let s of Object.keys(e)){let e=s.replace(/_from$|_to$|_search$/,"");t.includes(e)||r.push(`Invalid filter field: ${s}`)}return{valid:0===r.length,errors:r}}r.d(t,{M1:()=>a,SI:()=>o,Ye:()=>i,gX:()=>n,ik:()=>s})},89708:(e,t,r)=>{r.d(t,{af:()=>a,vm:()=>o});let s={"X-Content-Type-Options":"nosniff","X-Frame-Options":"DENY","X-XSS-Protection":"1; mode=block","Referrer-Policy":"strict-origin-when-cross-origin","Permissions-Policy":"geolocation=(), microphone=(), camera=()"},n={...s,"Strict-Transport-Security":"max-age=31536000; includeSubDomains","Content-Security-Policy":"default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"};function a(e,t=3600,r=!1,s=!1){let n=[];return r?n.push("public"):n.push("private"),n.push(`max-age=${t}`),s&&n.push("must-revalidate"),e.headers.set("Cache-Control",n.join(", ")),e}function o(e,t={}){let{isProduction:r=!0,version:o="1.0.0",noCache:i=!0,cacheMaxAge:l=0}=t;return(function(e,t=!1){for(let[r,a]of Object.entries(t?n:s))a&&e.headers.set(r,a)}(e,r),function(e,t="1.0.0"){e.headers.set("X-API-Version",t)}(e,o),i)?(e.headers.set("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate"),e.headers.set("Pragma","no-cache"),e.headers.set("Expires","0")):l>0&&a(e,l,!1,!0),e}},27793:(e,t,r)=>{function s(e){let t=e.nextUrl.searchParams,r=t.get("page")?parseInt(t.get("page"),10):1,s=t.get("limit")?parseInt(t.get("limit"),10):20,n=Math.max(1,r),a=Math.min(100,Math.max(1,s));return{page:n,limit:a,offset:(n-1)*a}}function n(e,t,r){let s=Math.ceil(t/r.limit);return{data:e,pagination:{page:r.page,limit:r.limit,total:t,totalPages:s,hasNext:r.page<s,hasPrev:r.page>1}}}function a(e,t,r){let s=Math.ceil(r/t.limit);e.headers.set("X-Page",t.page.toString()),e.headers.set("X-Limit",t.limit.toString()),e.headers.set("X-Total",r.toString()),e.headers.set("X-Total-Pages",s.toString()),e.headers.set("X-Has-Next",(t.page<s).toString()),e.headers.set("X-Has-Prev",(t.page>1).toString())}r.d(t,{dr:()=>s,jM:()=>a,q6:()=>n})},86420:(e,t,r)=>{let s,n;r.d(t,{HS:()=>y,Os:()=>f,O4:()=>h,aN:()=>g});var a={};r.r(a),r.d(a,{j:()=>l});var o=r(51870),i=r(60114);let l={url:(0,i.xw)(),host:i.OB.NATS_HOST,port:i.OB.NATS_PORT,cluster:i.OB.NATS_CLUSTER,user:i.OB.NATS_USER,password:i.OB.NATS_PASSWORD,reconnect:!0,maxReconnectAttempts:10,reconnectTimeWait:2e3,jetstream:{maxPending:1024,ackWait:3e4}},d=globalThis;(0,o.StringCodec)();let c=(0,o.JSONCodec)();async function u(){if(d.nc&&d.js)return{connection:d.nc,jetstream:d.js};try{let e=(0,a.getNatsUrl)();new URL(e);let t={servers:[e],reconnect:l.reconnect,maxReconnectAttempts:l.maxReconnectAttempts,reconnectTimeWait:l.reconnectTimeWait};return l.user&&l.password&&(t.user=l.user,t.pass=l.password),n=(s=await (0,o.connect)(t)).jetstream(),s.closed().then(()=>{}),{connection:s,jetstream:n}}catch(e){throw console.error("âŒ NATS connection failed:",e),e}}async function p(){return s&&n?{nc:s,js:n}:d.nc&&d.js?(s=d.nc,n=d.js,{nc:s,js:n}):await u()}let m={publish:async(e,t)=>{try{let{js:r}=await p(),s=c.encode(t);await r.publish(e,s)}catch(t){throw console.error(`NATS publish error for subject ${e}:`,t),t}}},f={created:async e=>{await m.publish("component.created",e)},updated:async e=>{await m.publish("component.updated",e)},deleted:async e=>{await m.publish("component.deleted",e)}},h={started:async e=>{await m.publish("deployment.started",e)},completed:async e=>{await m.publish("deployment.completed",e)},failed:async e=>{await m.publish("deployment.failed",e)},rolledBack:async e=>{await m.publish("deployment.rolledBack",e)}},y={started:async e=>{await m.publish("build.started",e)},progress:async e=>{await m.publish("build.progress",e)},completed:async e=>{await m.publish("build.completed",e)},failed:async e=>{await m.publish("build.failed",e)}},g={updated:async e=>{await m.publish("token.updated",e)},synced:async e=>{await m.publish("token.synced",e)}}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9276,5972,1585,9766,2197,1870,7176,7875],()=>r(20863));module.exports=s})();