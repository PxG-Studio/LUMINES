"use strict";exports.id=691,exports.ids=[691],exports.modules={80691:(e,t,r)=>{let s,i;r.d(t,{cZ:()=>M});let n=new Uint8Array(0),o=new TextEncoder,a=new TextDecoder;function h(...e){let t=[];for(let r=0;r<e.length;r++)t.push(o.encode(e[r]));return 0===t.length?n:1===t.length?t[0]:function(...e){let t=0;for(let r=0;r<e.length;r++)t+=e[r].length;let r=new Uint8Array(t),s=0;for(let t=0;t<e.length;t++)r.set(e[t],s),s+=e[t].length;return r}(...t)}function c(e){return e&&0!==e.length?a.decode(e):""}let u="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";class l{buf;seq;inc;inited;constructor(){this.buf=new Uint8Array(22),this.inited=!1}init(){this.inited=!0,this.setPre(),this.initSeqAndInc(),this.fillSeq()}initSeqAndInc(){this.seq=Math.floor(0xcfd41b9100000*Math.random()),this.inc=Math.floor(300*Math.random()+33)}setPre(){let e=new Uint8Array(12);globalThis?.crypto?.getRandomValues?globalThis.crypto.getRandomValues(e):function(e){for(let t=0;t<e.length;t++)e[t]=Math.floor(255*Math.random())}(e);for(let t=0;t<12;t++){let r=e[t]%36;this.buf[t]=u.charCodeAt(r)}}fillSeq(){let e=this.seq;for(let t=21;t>=12;t--)this.buf[t]=u.charCodeAt(e%36),e=Math.floor(e/36)}next(){return this.inited||this.init(),this.seq+=this.inc,this.seq>0xcfd41b9100000&&(this.setPre(),this.initSeqAndInc()),this.fillSeq(),String.fromCharCode.apply(String,this.buf)}reset(){this.init()}}let d=new l;(function(e){e.Disconnect="disconnect",e.Reconnect="reconnect",e.Update="update",e.LDM="ldm",e.Error="error"})(ep||(ep={})),function(e){e.Reconnecting="reconnecting",e.PingTimer="pingTimer",e.StaleConnection="staleConnection",e.ClientInitiatedReconnect="client initiated reconnect"}(em||(em={})),function(e){e.ApiError="BAD API",e.BadAuthentication="BAD_AUTHENTICATION",e.BadCreds="BAD_CREDS",e.BadHeader="BAD_HEADER",e.BadJson="BAD_JSON",e.BadPayload="BAD_PAYLOAD",e.BadSubject="BAD_SUBJECT",e.Cancelled="CANCELLED",e.ConnectionClosed="CONNECTION_CLOSED",e.ConnectionDraining="CONNECTION_DRAINING",e.ConnectionRefused="CONNECTION_REFUSED",e.ConnectionTimeout="CONNECTION_TIMEOUT",e.Disconnect="DISCONNECT",e.InvalidOption="INVALID_OPTION",e.InvalidPayload="INVALID_PAYLOAD",e.MaxPayloadExceeded="MAX_PAYLOAD_EXCEEDED",e.NoResponders="503",e.NotFunction="NOT_FUNC",e.RequestError="REQUEST_ERROR",e.ServerOptionNotAvailable="SERVER_OPT_NA",e.SubClosed="SUB_CLOSED",e.SubDraining="SUB_DRAINING",e.Timeout="TIMEOUT",e.Tls="TLS",e.Unknown="UNKNOWN_ERROR",e.WssRequired="WSS_REQUIRED",e.JetStreamInvalidAck="JESTREAM_INVALID_ACK",e.JetStream404NoMessages="404",e.JetStream408RequestTimeout="408",e.JetStream409MaxAckPendingExceeded="409",e.JetStream409="409",e.JetStreamNotEnabled="503",e.JetStreamIdleHeartBeat="IDLE_HEARTBEAT",e.AuthorizationViolation="AUTHORIZATION_VIOLATION",e.AuthenticationExpired="AUTHENTICATION_EXPIRED",e.ProtocolError="NATS_PROTOCOL_ERR",e.PermissionsViolation="PERMISSIONS_VIOLATION",e.AuthenticationTimeout="AUTHENTICATION_TIMEOUT",e.AccountExpired="ACCOUNT_EXPIRED"}(eg||(eg={}));class f{messages;constructor(){this.messages=new Map,this.messages.set(eg.InvalidPayload,"Invalid payload type - payloads can be 'binary', 'string', or 'json'"),this.messages.set(eg.BadJson,"Bad JSON"),this.messages.set(eg.WssRequired,"TLS is required, therefore a secure websocket connection is also required")}static getMessage(e){return p.getMessage(e)}getMessage(e){return this.messages.get(e)||e}}let p=new f;class m extends Error{name;message;code;permissionContext;chainedError;api_error;constructor(e,t,r){super(e),this.name="NatsError",this.message=e,this.code=t,this.chainedError=r}static errorForCode(e,t){return new m(f.getMessage(e),e,t)}isAuthError(){return this.code===eg.AuthenticationExpired||this.code===eg.AuthorizationViolation||this.code===eg.AccountExpired}isAuthTimeout(){return this.code===eg.AuthenticationTimeout}isPermissionError(){return this.code===eg.PermissionsViolation}isProtocolError(){return this.code===eg.ProtocolError}isJetStreamError(){return void 0!==this.api_error}jsError(){return this.api_error?this.api_error:null}}(function(e){e[e.Exact=0]="Exact",e[e.CanonicalMIME=1]="CanonicalMIME",e[e.IgnoreCase=2]="IgnoreCase"})(eb||(eb={})),function(e){e.Timer="timer",e.Count="count",e.JitterTimer="jitterTimer",e.SentinelMsg="sentinelMsg"}(e_||(e_={})),function(e){e.STATS="io.nats.micro.v1.stats_response",e.INFO="io.nats.micro.v1.info_response",e.PING="io.nats.micro.v1.ping_response"}(ey||(ey={}));let g="Nats-Service-Error",b="Nats-Service-Error-Code";class _ extends Error{code;constructor(e,t){super(t),this.code=e}static isServiceError(e){return null!==_.toServiceError(e)}static toServiceError(e){let t=e?.headers?.get(b)||"";if(""!==t){let r=parseInt(t)||400,s=e?.headers?.get(g)||"";return new _(r,s.length?s:t)}return null}}function y(e=""){if("string"!=typeof(e=e||"_INBOX"))throw Error("prefix must be a string");return e.split(".").forEach(t=>{if("*"===t||">"===t)throw Error(`inbox prefixes cannot have wildcards '${e}'`)}),`${e}.${d.next()}`}let w="127.0.0.1";function S(e,...t){for(let r=0;r<t.length;r++){let s=t[r];Object.keys(s).forEach(function(t){e[t]=s[t]})}return e}function v(e,t=!0){let r,s;let i=t?m.errorForCode(eg.Timeout):null;return Object.assign(new Promise((t,n)=>{r={cancel:()=>{s&&clearTimeout(s)}},s=setTimeout(()=>{null===i?n(m.errorForCode(eg.Timeout)):n(i)},e)}),r)}function E(e=0){let t;return Object.assign(new Promise(r=>{let s=setTimeout(()=>{r()},e);t={cancel:()=>{s&&clearTimeout(s)}}}),t)}function x(){let e={};return Object.assign(new Promise((t,r)=>{e={resolve:t,reject:r}}),e)}function A(e){for(let t=e.length-1;t>0;t--){let r=Math.floor(Math.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}return e}function P(e=[0,250,250,500,500,3e3,5e3]){Array.isArray(e)||(e=[0,250,250,500,500,3e3,5e3]);let t=e.length-1;return{backoff:r=>{var s;return 0===(s=r>t?e[t]:e[r])?0:Math.floor(s/2+Math.random()*s)}}}function O(e){return 1e6*e}function k(e){return Math.floor(e/1e6)}function C(e){let t=!0,r=Array(e.length);for(let s=0;s<e.length;s++){let i=e.charCodeAt(s);if(58===i||i<33||i>126)throw new m(`'${e[s]}' is not a valid character for a header key`,eg.BadHeader);t&&97<=i&&i<=122?i-=32:!t&&65<=i&&i<=90&&(i+=32),r[s]=i,t=45==i}return String.fromCharCode(...r)}function j(e=0,t=""){if(0===e&&""!==t||e>0&&""===t)throw Error("setting status requires both code and description");return new N(e,t)}!function(e){e.PING="PING",e.STATS="STATS",e.INFO="INFO"}(ew||(ew={}));let I="NATS/1.0";class N{_code;headers;_description;constructor(e=0,t=""){this._code=e,this._description=t,this.headers=new Map}[Symbol.iterator](){return this.headers.entries()}size(){return this.headers.size}equals(e){if(e&&this.headers.size===e.headers.size&&this._code===e._code){for(let[t,r]of this.headers){let s=e.values(t);if(r.length!==s.length)return!1;let i=[...r].sort(),n=[...s].sort();for(let e=0;e<i.length;e++)if(i[e]!==n[e])return!1}return!0}return!1}static decode(e){let t=new N,r=a.decode(e).split("\r\n"),s=r[0];if(s!==I){let e=s.replace(I,"").trim();if(e.length>0){t._code=parseInt(e,10),isNaN(t._code)&&(t._code=0);let r=t._code.toString();e=e.replace(r,""),t._description=e.trim()}}return r.length>=1&&r.slice(1).map(e=>{if(e){let r=e.indexOf(":");if(r>-1){let s=e.slice(0,r),i=e.slice(r+1).trim();t.append(s,i)}}}),t}toString(){if(0===this.headers.size&&0===this._code)return"";let e=I;for(let[t,r]of(this._code>0&&""!==this._description&&(e+=` ${this._code} ${this._description}`),this.headers))for(let s=0;s<r.length;s++)e=`${e}\r
${t}: ${r[s]}`;return`${e}\r
\r
`}encode(){return o.encode(this.toString())}static validHeaderValue(e){if(/[\r\n]/.test(e))throw new m("invalid header value - \\r and \\n are not allowed.",eg.BadHeader);return e.trim()}keys(){let e=[];for(let t of this.headers.keys())e.push(t);return e}findKeys(e,t=eb.Exact){let r=this.keys();switch(t){case eb.Exact:return r.filter(t=>t===e);case eb.CanonicalMIME:return e=C(e),r.filter(t=>t===e);default:{let t=e.toLowerCase();return r.filter(e=>t===e.toLowerCase())}}}get(e,t=eb.Exact){let r=this.findKeys(e,t);if(r.length){let e=this.headers.get(r[0]);if(e)return Array.isArray(e)?e[0]:e}return""}last(e,t=eb.Exact){let r=this.findKeys(e,t);if(r.length){let e=this.headers.get(r[0]);if(e)return Array.isArray(e)?e[e.length-1]:e}return""}has(e,t=eb.Exact){return this.findKeys(e,t).length>0}set(e,t,r=eb.Exact){this.delete(e,r),this.append(e,t,r)}append(e,t,r=eb.Exact){let s=C(e);r===eb.CanonicalMIME&&(e=s);let i=this.findKeys(e,r);e=i.length>0?i[0]:e;let n=N.validHeaderValue(t),o=this.headers.get(e);o||(o=[],this.headers.set(e,o)),o.push(n)}values(e,t=eb.Exact){let r=[];return this.findKeys(e,t).forEach(e=>{let t=this.headers.get(e);t&&r.push(...t)}),r}delete(e,t=eb.Exact){this.findKeys(e,t).forEach(e=>{this.headers.delete(e)})}get hasError(){return this._code>=300}get status(){return`${this._code} ${this._description}`.trim()}toRecord(){let e={};return this.keys().forEach(t=>{e[t]=this.values(t)}),e}get code(){return this._code}get description(){return this._description}static fromRecord(e){let t=new N;for(let r in e)t.headers.set(r,e[r]);return t}}function M(){return{encode:e=>o.encode(e),decode:e=>a.decode(e)}}function R(e){return{encode(e){try{return void 0===e&&(e=null),o.encode(JSON.stringify(e))}catch(e){throw m.errorForCode(eg.BadJson,e)}},decode(t){try{return JSON.parse(a.decode(t),e)}catch(e){throw m.errorForCode(eg.BadJson,e)}}}}function T(e){return e&&0===e.data.length&&e.headers?.code===503?m.errorForCode(eg.NoResponders):null}class ${_headers;_msg;_rdata;_reply;_subject;publisher;static jc;constructor(e,t,r){this._msg=e,this._rdata=t,this.publisher=r}get subject(){return this._subject||(this._subject=a.decode(this._msg.subject)),this._subject}get reply(){return this._reply||(this._reply=a.decode(this._msg.reply)),this._reply}get sid(){return this._msg.sid}get headers(){if(this._msg.hdr>-1&&!this._headers){let e=this._rdata.subarray(0,this._msg.hdr);this._headers=N.decode(e)}return this._headers}get data(){return this._rdata?this._msg.hdr>-1?this._rdata.subarray(this._msg.hdr):this._rdata:new Uint8Array(0)}respond(e=n,t){return!!this.reply&&(this.publisher.publish(this.reply,e,t),!0)}size(){return this._msg.subject.length+(this._msg.reply?.length||0)+(-1===this._msg.size?0:this._msg.size)}json(e){return R(e).decode(this.data)}string(){return a.decode(this.data)}requestInfo(){let e=this.headers?.get("Nats-Request-Info");return e?JSON.parse(e,function(e,t){return("start"===e||"stop"===e)&&""!==t?new Date(Date.parse(t)):t}):null}}function U(e){return F("durable",e)}function q(e){return F("stream",e)}function F(e,t=""){if(""===t)throw Error(`${e} name required`);return[".","*",">","/","\\"," ","	","\n","\r"].forEach(r=>{if(-1!==t.indexOf(r)){switch(r){case"\n":r="\\n";break;case"\r":r="\\r";break;case"	":r="\\t"}throw Error(`invalid ${e} name - ${e} name cannot contain '${r}'`)}}),""}function L(e,t=""){if(""===t)throw Error(`${e} name required`);let r=function(e=""){if(""===e)throw Error("name required");let t=/^[-\w]+$/g;if(null===e.match(t)){for(let r of e.split(""))if(null===r.match(t))return`cannot contain '${r}'`}return""}(t);if(r.length)throw Error(`invalid ${e} name - ${e} name ${r}`)}function B(e){if(e.data.length>0)return!1;let t=e.headers;return!!t&&t.code>=100&&t.code<200}function D(e){return B(e)&&e.headers?.description==="Idle Heartbeat"}function H(e){if(0!==e.data.length)return null;let t=e.headers;return t?J(t.code,t.description):null}function J(e,t=""){if(e<300)return null;switch(t=t.toLowerCase(),e){case 404:return new m(t,eg.JetStream404NoMessages);case 408:return new m(t,eg.JetStream408RequestTimeout);case 409:{let e=t.startsWith(eS.IdleHeartbeatMissed)?eg.JetStreamIdleHeartBeat:eg.JetStream409;return new m(t,e)}case 503:return m.errorForCode(eg.JetStreamNotEnabled,Error(t));default:return""===t&&(t=eg.Unknown),new m(t,`${e}`)}}!function(e){e.MaxBatchExceeded="exceeded maxrequestbatch of",e.MaxExpiresExceeded="exceeded maxrequestexpires of",e.MaxBytesExceeded="exceeded maxrequestmaxbytes of",e.MaxMessageSizeExceeded="message size exceeds maxbytes",e.PushConsumer="consumer is push based",e.MaxWaitingExceeded="exceeded maxwaiting",e.IdleHeartbeatMissed="idle heartbeats missed",e.ConsumerDeleted="consumer deleted"}(eS||(eS={}));class z{inflight;processed;received;noIterator;iterClosed;done;signal;yields;filtered;pendingFiltered;ingestionFilterFn;protocolFilterFn;dispatchedFn;ctx;_data;err;time;yielding;constructor(){this.inflight=0,this.filtered=0,this.pendingFiltered=0,this.processed=0,this.received=0,this.noIterator=!1,this.done=!1,this.signal=x(),this.yields=[],this.iterClosed=x(),this.time=0,this.yielding=!1}[Symbol.asyncIterator](){return this.iterate()}push(e){if(this.done)return;if("function"==typeof e){this.yields.push(e),this.signal.resolve();return}let{ingest:t,protocol:r}=this.ingestionFilterFn?this.ingestionFilterFn(e,this.ctx||this):{ingest:!0,protocol:!1};t&&(r&&(this.filtered++,this.pendingFiltered++),this.yields.push(e),this.signal.resolve())}async *iterate(){if(this.noIterator)throw new m("unsupported iterator",eg.ApiError);if(this.yielding)throw new m("already yielding",eg.ApiError);this.yielding=!0;try{for(;;){if(0===this.yields.length&&await this.signal,this.err)throw this.err;let e=this.yields;this.inflight=e.length,this.yields=[];for(let t=0;t<e.length;t++){if("function"==typeof e[t]){let r=e[t];try{r()}catch(e){throw e}if(this.err)throw this.err;continue}if(!this.protocolFilterFn||this.protocolFilterFn(e[t])){this.processed++;let r=Date.now();yield e[t],this.time=Date.now()-r,this.dispatchedFn&&e[t]&&this.dispatchedFn(e[t])}else this.pendingFiltered--;this.inflight--}if(this.done)break;0===this.yields.length&&(e.length=0,this.yields=e,this.signal=x())}}finally{this.stop()}}stop(e){this.done||(this.err=e,this.done=!0,this.signal.resolve(),this.iterClosed.resolve(e))}getProcessed(){return this.noIterator?this.received:this.processed}getPending(){return this.yields.length+this.inflight-this.pendingFiltered}getReceived(){return this.received-this.filtered}}class G{interval;maxOut;cancelAfter;timer;autoCancelTimer;last;missed;count;callback;constructor(e,t,r={maxOut:2}){this.interval=e,this.maxOut=r?.maxOut||2,this.cancelAfter=r?.cancelAfter||0,this.last=Date.now(),this.missed=0,this.count=0,this.callback=t,this._schedule()}cancel(){this.autoCancelTimer&&clearTimeout(this.autoCancelTimer),this.timer&&clearInterval(this.timer),this.timer=0,this.autoCancelTimer=0,this.missed=0}work(){this.last=Date.now(),this.missed=0}_change(e,t=0,r=2){this.interval=e,this.maxOut=r,this.cancelAfter=t,this.restart()}restart(){this.cancel(),this._schedule()}_schedule(){this.cancelAfter>0&&(this.autoCancelTimer=setTimeout(()=>{this.cancel()},this.cancelAfter)),this.timer=setInterval(()=>{if(this.count++,Date.now()-this.last>this.interval&&this.missed++,this.missed>=this.maxOut)try{!0===this.callback(this.missed)&&this.cancel()}catch(e){console.log(e)}},this.interval)}}(function(e){e.Limits="limits",e.Interest="interest",e.Workqueue="workqueue"})(ev||(ev={})),function(e){e.Old="old",e.New="new"}(eE||(eE={})),function(e){e.File="file",e.Memory="memory"}(ex||(ex={})),function(e){e.All="all",e.Last="last",e.New="new",e.StartSequence="by_start_sequence",e.StartTime="by_start_time",e.LastPerSubject="last_per_subject"}(eA||(eA={})),function(e){e.None="none",e.All="all",e.Explicit="explicit",e.NotSet=""}(eP||(eP={})),function(e){e.Instant="instant",e.Original="original"}(eO||(eO={})),function(e){e.None="none",e.S2="s2"}(ek||(ek={})),function(e){e.CreateOrUpdate="",e.Update="update",e.Create="create"}(eC||(eC={})),function(e){e.API="api_audit",e.StreamAction="stream_action",e.ConsumerAction="consumer_action",e.SnapshotCreate="snapshot_create",e.SnapshotComplete="snapshot_complete",e.RestoreCreate="restore_create",e.RestoreComplete="restore_complete",e.MaxDeliver="max_deliver",e.Terminated="terminated",e.Ack="consumer_ack",e.StreamLeaderElected="stream_leader_elected",e.StreamQuorumLost="stream_quorum_lost",e.ConsumerLeaderElected="consumer_leader_elected",e.ConsumerQuorumLost="consumer_quorum_lost"}(ej||(ej={})),function(e){e.StreamSourceHdr="Nats-Stream-Source",e.LastConsumerSeqHdr="Nats-Last-Consumer",e.LastStreamSeqHdr="Nats-Last-Stream",e.ConsumerStalledHdr="Nats-Consumer-Stalled",e.MessageSizeHdr="Nats-Msg-Size",e.RollupHdr="Nats-Rollup",e.RollupValueSubject="sub",e.RollupValueAll="all",e.PendingMessagesHdr="Nats-Pending-Messages",e.PendingBytesHdr="Nats-Pending-Bytes"}(eI||(eI={})),function(e){e.LastValue="",e.AllHistory="history",e.UpdatesOnly="updates"}(eN||(eN={})),function(e){e.Stream="Nats-Stream",e.Sequence="Nats-Sequence",e.TimeStamp="Nats-Time-Stamp",e.Subject="Nats-Subject"}(eM||(eM={})),function(e){e.Stream="Nats-Stream",e.Subject="Nats-Subject",e.Sequence="Nats-Sequence",e.LastSequence="Nats-Last-Sequence",e.Size="Nats-Msg-Size"}(eR||(eR={}));class K{config;ordered;mack;stream;callbackFn;max;qname;isBind;filters;constructor(e){this.stream="",this.mack=!1,this.ordered=!1,this.config=function(e,t={}){return Object.assign({name:"",deliver_policy:eA.All,ack_policy:eP.Explicit,ack_wait:O(3e4),replay_policy:eO.Instant},t)}(0,e||{})}getOpts(){let e={};if(e.config=Object.assign({},this.config),e.config.filter_subject&&(this.filterSubject(e.config.filter_subject),e.config.filter_subject=void 0),e.config.filter_subjects&&(e.config.filter_subjects?.forEach(e=>{this.filterSubject(e)}),e.config.filter_subjects=void 0),e.mack=this.mack,e.stream=this.stream,e.callbackFn=this.callbackFn,e.max=this.max,e.queue=this.qname,e.ordered=this.ordered,e.config.ack_policy=e.ordered?eP.None:e.config.ack_policy,e.isBind=e.isBind||!1,this.filters)switch(this.filters.length){case 0:break;case 1:e.config.filter_subject=this.filters[0];break;default:e.config.filter_subjects=this.filters}return e}description(e){return this.config.description=e,this}deliverTo(e){return this.config.deliver_subject=e,this}durable(e){return U(e),this.config.durable_name=e,this}startSequence(e){if(e<=0)throw Error("sequence must be greater than 0");return this.config.deliver_policy=eA.StartSequence,this.config.opt_start_seq=e,this}startTime(e){return this.config.deliver_policy=eA.StartTime,this.config.opt_start_time=e.toISOString(),this}deliverAll(){return this.config.deliver_policy=eA.All,this}deliverLastPerSubject(){return this.config.deliver_policy=eA.LastPerSubject,this}deliverLast(){return this.config.deliver_policy=eA.Last,this}deliverNew(){return this.config.deliver_policy=eA.New,this}startAtTimeDelta(e){return this.startTime(new Date(Date.now()-e)),this}headersOnly(){return this.config.headers_only=!0,this}ackNone(){return this.config.ack_policy=eP.None,this}ackAll(){return this.config.ack_policy=eP.All,this}ackExplicit(){return this.config.ack_policy=eP.Explicit,this}ackWait(e){return this.config.ack_wait=O(e),this}maxDeliver(e){return this.config.max_deliver=e,this}filterSubject(e){return this.filters=this.filters||[],this.filters.push(e),this}replayInstantly(){return this.config.replay_policy=eO.Instant,this}replayOriginal(){return this.config.replay_policy=eO.Original,this}sample(e){if((e=Math.trunc(e))<0||e>100)throw Error("value must be between 0-100");return this.config.sample_freq=`${e}%`,this}limit(e){return this.config.rate_limit_bps=e,this}maxWaiting(e){return this.config.max_waiting=e,this}maxAckPending(e){return this.config.max_ack_pending=e,this}idleHeartbeat(e){return this.config.idle_heartbeat=O(e),this}flowControl(){return this.config.flow_control=!0,this}deliverGroup(e){return this.queue(e),this}manualAck(){return this.mack=!0,this}maxMessages(e){return this.max=e,this}callback(e){return this.callbackFn=e,this}queue(e){return this.qname=e,this.config.deliver_group=e,this}orderedConsumer(){return this.ordered=!0,this}bind(e,t){return this.stream=e,this.config.durable_name=t,this.isBind=!0,this}bindStream(e){return this.stream=e,this}inactiveEphemeralThreshold(e){return this.config.inactive_threshold=O(e),this}maxPullBatch(e){return this.config.max_batch=e,this}maxPullRequestExpires(e){return this.config.max_expires=O(e),this}memory(){return this.config.mem_storage=!0,this}numReplicas(e){return this.config.num_replicas=e,this}consumerName(e){return this.config.name=e,this}}function V(e){return new K(e)}function W(e){return"function"==typeof e.getOpts}class Y{static encode(e){return"string"==typeof e?btoa(e):btoa(String.fromCharCode(...Array.from(e)))}static decode(e,t=!1){let r=atob(e);return t?Uint8Array.from(r,e=>e.charCodeAt(0)):r}}class X{static encode(e){return X.toB64URLEncoding(Y.encode(e))}static decode(e,t=!1){return X.decode(X.fromB64URLEncoding(e),t)}static toB64URLEncoding(e){return e.replace(/\+/g,"-").replace(/\//g,"_")}static fromB64URLEncoding(e){return e.replace(/_/g,"/").replace(/-/g,"+")}}class Z{buffers;byteLength;constructor(){this.buffers=[],this.byteLength=0}static concat(...e){let t=0;for(let r=0;r<e.length;r++)t+=e[r].length;let r=new Uint8Array(t),s=0;for(let t=0;t<e.length;t++)r.set(e[t],s),s+=e[t].length;return r}static fromAscii(e){return e||(e=""),o.encode(e)}static toAscii(e){return a.decode(e)}reset(){this.buffers.length=0,this.byteLength=0}pack(){if(this.buffers.length>1){let e=new Uint8Array(this.byteLength),t=0;for(let r=0;r<this.buffers.length;r++)e.set(this.buffers[r],t),t+=this.buffers[r].length;this.buffers.length=0,this.buffers.push(e)}}shift(){if(this.buffers.length){let e=this.buffers.shift();if(e)return this.byteLength-=e.length,e}return new Uint8Array(0)}drain(e){if(this.buffers.length){this.pack();let t=this.buffers.pop();if(t){let r=this.byteLength;(void 0===e||e>r)&&(e=r);let s=t.subarray(0,e);return r>e&&this.buffers.push(t.subarray(e)),this.byteLength=r-e,s}}return new Uint8Array(0)}fill(e,...t){e&&(this.buffers.push(e),this.byteLength+=e.length);for(let e=0;e<t.length;e++)t[e]&&t[e].length&&(this.buffers.push(t[e]),this.byteLength+=t[e].length)}peek(){return this.buffers.length?(this.pack(),this.buffers[0]):new Uint8Array(0)}size(){return this.byteLength}length(){return this.buffers.length}}var Q,ee,et,er,es,ei,en,eo,ea,eh,ec="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function eu(){throw Error("setTimeout has not been defined")}function el(){throw Error("clearTimeout has not been defined")}var ed=eu,ef=el;"function"==typeof ec.setTimeout&&(ed=setTimeout),"function"==typeof ec.clearTimeout&&(ef=clearTimeout);var ep,em,eg,eb,e_,ey,ew,eS,ev,eE,ex,eA,eP,eO,ek,eC,ej,eI,eN,eM,eR,eT,e$=[],eU=!1,eq=-1;function eF(){eU&&eT&&(eU=!1,eT.length?e$=eT.concat(e$):eq=-1,e$.length&&function(){if(!eU){var e=function(e){if(ed===setTimeout)return setTimeout(e,0);if((ed===eu||!ed)&&setTimeout)return ed=setTimeout,setTimeout(e,0);try{return ed(e,0)}catch(t){try{return ed.call(null,e,0)}catch(t){return ed.call(this,e,0)}}}(eF);eU=!0;for(var t=e$.length;t;){for(eT=e$,e$=[];++eq<t;)eT&&eT[eq].run();eq=-1,t=e$.length}eT=null,eU=!1,function(e){if(ef===clearTimeout)return clearTimeout(e);if((ef===el||!ef)&&clearTimeout)return ef=clearTimeout,clearTimeout(e);try{ef(e)}catch(t){try{return ef.call(null,e)}catch(t){return ef.call(this,e)}}}(e)}}())}(function(e,t){this.fun=e,this.array=t}).prototype.run=function(){this.fun.apply(null,this.array)};var eL=ec.performance||{},eB=(eL.now||eL.mozNow||eL.msNow||eL.oNow||eL.webkitNow,{versions:{}}),eD="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},eH={exports:{}},eJ={},ez=function(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach(function(r){var s=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,s.get?s:{enumerable:!0,get:function(){return e[r]}})}),t}(function(e,t){return t.forEach(function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach(function(r){if("default"!==r&&!(r in e)){var s=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,s.get?s:{enumerable:!0,get:function(){return t[r]}})}})}),Object.freeze(e)}({__proto__:null,default:eJ},[eJ]));(function(){var e="input is invalid type",t="object"==typeof window,r=t?window:{};r.JS_SHA256_NO_WINDOW&&(t=!1);var s=!t&&"object"==typeof self,i=!r.JS_SHA256_NO_NODE_JS&&eB.versions&&eB.versions.node;i?r=eD:s&&(r=self);var n=!r.JS_SHA256_NO_COMMON_JS&&eH.exports,o=!r.JS_SHA256_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,a="0123456789abcdef".split(""),h=[-2147483648,8388608,32768,128],c=[24,16,8,0],u=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],l=["hex","array","digest","arrayBuffer"],d=[];!r.JS_SHA256_NO_NODE_JS&&Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),o&&(r.JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW||!ArrayBuffer.isView)&&(ArrayBuffer.isView=function(e){return"object"==typeof e&&e.buffer&&e.buffer.constructor===ArrayBuffer});var f=function(e,t){return function(r){return new _(t,!0).update(r)[e]()}},p=function(e){var t=f("hex",e);i&&(t=m(t,e)),t.create=function(){return new _(e)},t.update=function(e){return t.create().update(e)};for(var r=0;r<l.length;++r){var s=l[r];t[s]=f(s,e)}return t},m=function(t,s){var i,n=ez.Buffer,o=s?"sha224":"sha256";return i=n.from&&!r.JS_SHA256_NO_BUFFER_FROM?n.from:function(e){return new n(e)},function(r){if("string"==typeof r)return ez.createHash(o).update(r,"utf8").digest("hex");if(null==r)throw Error(e);return r.constructor===ArrayBuffer&&(r=new Uint8Array(r)),Array.isArray(r)||ArrayBuffer.isView(r)||r.constructor===n?ez.createHash(o).update(i(r)).digest("hex"):t(r)}},g=function(e,t){return function(r,s){return new y(r,t,!0).update(s)[e]()}},b=function(e){var t=g("hex",e);t.create=function(t){return new y(t,e)},t.update=function(e,r){return t.create(e).update(r)};for(var r=0;r<l.length;++r){var s=l[r];t[s]=g(s,e)}return t};function _(e,t){t?(d[0]=d[16]=d[1]=d[2]=d[3]=d[4]=d[5]=d[6]=d[7]=d[8]=d[9]=d[10]=d[11]=d[12]=d[13]=d[14]=d[15]=0,this.blocks=d):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=e}function y(t,r,s){var i,n=typeof t;if("string"===n){var a,h=[],c=t.length,u=0;for(i=0;i<c;++i)(a=t.charCodeAt(i))<128?h[u++]=a:(a<2048?h[u++]=192|a>>>6:(a<55296||a>=57344?h[u++]=224|a>>>12:(a=65536+((1023&a)<<10|1023&t.charCodeAt(++i)),h[u++]=240|a>>>18,h[u++]=128|a>>>12&63),h[u++]=128|a>>>6&63),h[u++]=128|63&a);t=h}else{if("object"!==n||null===t)throw Error(e);if(o&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||o&&ArrayBuffer.isView(t)))throw Error(e)}t.length>64&&(t=new _(r,!0).update(t).array());var l=[],d=[];for(i=0;i<64;++i){var f=t[i]||0;l[i]=92^f,d[i]=54^f}_.call(this,r,s),this.update(d),this.oKeyPad=l,this.inner=!0,this.sharedMemory=s}_.prototype.update=function(t){if(!this.finalized){var r,s=typeof t;if("string"!==s){if("object"!==s||null===t)throw Error(e);if(o&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||o&&ArrayBuffer.isView(t)))throw Error(e);r=!0}for(var i,n,a=0,h=t.length,u=this.blocks;a<h;){if(this.hashed&&(this.hashed=!1,u[0]=this.block,this.block=u[16]=u[1]=u[2]=u[3]=u[4]=u[5]=u[6]=u[7]=u[8]=u[9]=u[10]=u[11]=u[12]=u[13]=u[14]=u[15]=0),r)for(n=this.start;a<h&&n<64;++a)u[n>>>2]|=t[a]<<c[3&n++];else for(n=this.start;a<h&&n<64;++a)(i=t.charCodeAt(a))<128?u[n>>>2]|=i<<c[3&n++]:(i<2048?u[n>>>2]|=(192|i>>>6)<<c[3&n++]:(i<55296||i>=57344?u[n>>>2]|=(224|i>>>12)<<c[3&n++]:(i=65536+((1023&i)<<10|1023&t.charCodeAt(++a)),u[n>>>2]|=(240|i>>>18)<<c[3&n++],u[n>>>2]|=(128|i>>>12&63)<<c[3&n++]),u[n>>>2]|=(128|i>>>6&63)<<c[3&n++]),u[n>>>2]|=(128|63&i)<<c[3&n++]);this.lastByteIndex=n,this.bytes+=n-this.start,n>=64?(this.block=u[16],this.start=n-64,this.hash(),this.hashed=!0):this.start=n}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},_.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>>2]|=h[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},_.prototype.hash=function(){var e,t,r,s,i,n,o,a,h,c=this.h0,l=this.h1,d=this.h2,f=this.h3,p=this.h4,m=this.h5,g=this.h6,b=this.h7,_=this.blocks;for(e=16;e<64;++e)t=((i=_[e-15])>>>7|i<<25)^(i>>>18|i<<14)^i>>>3,r=((i=_[e-2])>>>17|i<<15)^(i>>>19|i<<13)^i>>>10,_[e]=_[e-16]+t+_[e-7]+r|0;for(h=l&d,e=0;e<64;e+=4)this.first?(this.is224?(n=300032,b=(i=_[0]-1413257819)-150054599|0,f=i+24177077|0):(n=704751109,b=(i=_[0]-210244248)-1521486534|0,f=i+143694565|0),this.first=!1):(t=(c>>>2|c<<30)^(c>>>13|c<<19)^(c>>>22|c<<10),s=(n=c&l)^c&d^h,b=f+(i=b+(r=(p>>>6|p<<26)^(p>>>11|p<<21)^(p>>>25|p<<7))+(p&m^~p&g)+u[e]+_[e])|0,f=i+(t+s)|0),t=(f>>>2|f<<30)^(f>>>13|f<<19)^(f>>>22|f<<10),s=(o=f&c)^f&l^n,g=d+(i=g+(r=(b>>>6|b<<26)^(b>>>11|b<<21)^(b>>>25|b<<7))+(b&p^~b&m)+u[e+1]+_[e+1])|0,t=((d=i+(t+s)|0)>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),s=(a=d&f)^d&c^o,m=l+(i=m+(r=(g>>>6|g<<26)^(g>>>11|g<<21)^(g>>>25|g<<7))+(g&b^~g&p)+u[e+2]+_[e+2])|0,t=((l=i+(t+s)|0)>>>2|l<<30)^(l>>>13|l<<19)^(l>>>22|l<<10),s=(h=l&d)^l&f^a,p=c+(i=p+(r=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7))+(m&g^~m&b)+u[e+3]+_[e+3])|0,c=i+(t+s)|0,this.chromeBugWorkAround=!0;this.h0=this.h0+c|0,this.h1=this.h1+l|0,this.h2=this.h2+d|0,this.h3=this.h3+f|0,this.h4=this.h4+p|0,this.h5=this.h5+m|0,this.h6=this.h6+g|0,this.h7=this.h7+b|0},_.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,s=this.h3,i=this.h4,n=this.h5,o=this.h6,h=this.h7,c=a[e>>>28&15]+a[e>>>24&15]+a[e>>>20&15]+a[e>>>16&15]+a[e>>>12&15]+a[e>>>8&15]+a[e>>>4&15]+a[15&e]+a[t>>>28&15]+a[t>>>24&15]+a[t>>>20&15]+a[t>>>16&15]+a[t>>>12&15]+a[t>>>8&15]+a[t>>>4&15]+a[15&t]+a[r>>>28&15]+a[r>>>24&15]+a[r>>>20&15]+a[r>>>16&15]+a[r>>>12&15]+a[r>>>8&15]+a[r>>>4&15]+a[15&r]+a[s>>>28&15]+a[s>>>24&15]+a[s>>>20&15]+a[s>>>16&15]+a[s>>>12&15]+a[s>>>8&15]+a[s>>>4&15]+a[15&s]+a[i>>>28&15]+a[i>>>24&15]+a[i>>>20&15]+a[i>>>16&15]+a[i>>>12&15]+a[i>>>8&15]+a[i>>>4&15]+a[15&i]+a[n>>>28&15]+a[n>>>24&15]+a[n>>>20&15]+a[n>>>16&15]+a[n>>>12&15]+a[n>>>8&15]+a[n>>>4&15]+a[15&n]+a[o>>>28&15]+a[o>>>24&15]+a[o>>>20&15]+a[o>>>16&15]+a[o>>>12&15]+a[o>>>8&15]+a[o>>>4&15]+a[15&o];return this.is224||(c+=a[h>>>28&15]+a[h>>>24&15]+a[h>>>20&15]+a[h>>>16&15]+a[h>>>12&15]+a[h>>>8&15]+a[h>>>4&15]+a[15&h]),c},_.prototype.toString=_.prototype.hex,_.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,s=this.h3,i=this.h4,n=this.h5,o=this.h6,a=this.h7,h=[e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,r>>>24&255,r>>>16&255,r>>>8&255,255&r,s>>>24&255,s>>>16&255,s>>>8&255,255&s,i>>>24&255,i>>>16&255,i>>>8&255,255&i,n>>>24&255,n>>>16&255,n>>>8&255,255&n,o>>>24&255,o>>>16&255,o>>>8&255,255&o];return this.is224||h.push(a>>>24&255,a>>>16&255,a>>>8&255,255&a),h},_.prototype.array=_.prototype.digest,_.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(this.is224?28:32),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),t.setUint32(20,this.h5),t.setUint32(24,this.h6),this.is224||t.setUint32(28,this.h7),e},y.prototype=new _,y.prototype.finalize=function(){if(_.prototype.finalize.call(this),this.inner){this.inner=!1;var e=this.array();_.call(this,this.is224,this.sharedMemory),this.update(this.oKeyPad),this.update(e),_.prototype.finalize.call(this)}};var w=p();w.sha256=w,w.sha224=p(!0),w.sha256.hmac=b(),w.sha224.hmac=b(!0),n?eH.exports=w:(r.sha256=w.sha256,r.sha224=w.sha224)})(),eH.exports,eH.exports.sha224;var eG=eH.exports.sha256;function eK(e){var t;switch(!function(e){if(!/^[0-9A-Fa-f]+$/.test(e))return!1;let t=/^[0-9A-F]+$/.test(e),r=/^[0-9a-f]+$/.test(e);return(!!t||!!r)&&e.length%2==0}(t=e)?/^[A-Za-z0-9\-_]*(={0,2})?$/.test(t)||/^[A-Za-z0-9+/]*(={0,2})?$/.test(t)?"b64":"":"hex"){case"hex":return function(e){if(e.length%2!=0)throw Error("hex string must have an even length");let t=new Uint8Array(e.length/2);for(let r=0;r<e.length;r+=2)t[r/2]=parseInt(e.substring(r,r+2),16);return t}(e);case"b64":return function(e){let t=atob(e=(e=e.replace(/-/g,"+")).replace(/_/g,"/"));return Uint8Array.from(t,e=>e.charCodeAt(0))}(e)}return null}class eV{token;received;ctx;requestSubject;mux;constructor(e,t,r=!0){this.mux=e,this.requestSubject=t,this.received=0,this.token=d.next(),r&&(this.ctx=Error())}}class eW extends eV{callback;done;timer;max;opts;constructor(e,t,r={maxWait:1e3}){if(super(e,t),this.opts=r,"function"!=typeof this.opts.callback)throw Error("callback is required");this.callback=this.opts.callback,this.max="number"==typeof r.maxMessages&&r.maxMessages>0?r.maxMessages:-1,this.done=x(),this.done.then(()=>{this.callback(null,null)}),this.timer=setTimeout(()=>{this.cancel()},r.maxWait)}cancel(e){e&&this.callback(e,null),clearTimeout(this.timer),this.mux.cancel(this),this.done.resolve()}resolver(e,t){e?(this.ctx&&(e.stack+=`

${this.ctx.stack}`),this.cancel(e)):(this.callback(null,t),this.opts.strategy===e_.Count&&(this.max--,0===this.max&&this.cancel()),this.opts.strategy===e_.JitterTimer&&(clearTimeout(this.timer),this.timer=setTimeout(()=>{this.cancel()},this.opts.jitter||300)),this.opts.strategy===e_.SentinelMsg&&t&&0===t.data.length&&this.cancel())}}class eY extends eV{deferred;timer;constructor(e,t,r={timeout:1e3},s=!0){super(e,t,s),this.deferred=x(),this.timer=v(r.timeout,s)}resolver(e,t){this.timer&&this.timer.cancel(),e?(this.ctx&&(e.stack+=`

${this.ctx.stack}`),this.deferred.reject(e)):this.deferred.resolve(t),this.cancel()}cancel(e){this.timer&&this.timer.cancel(),this.mux.cancel(this),this.deferred.reject(e||m.errorForCode(eg.Cancelled))}}class eX{nc;opts;prefix;timeout;jc;constructor(e,t){this.nc=e,this.opts=function(e){return(e=e||{}).domain&&(e.apiPrefix=`$JS.${e.domain}.API`,delete e.domain),S({apiPrefix:"$JS.API",timeout:5e3},e)}(t),this._parseOpts(),this.prefix=this.opts.apiPrefix,this.timeout=this.opts.timeout,this.jc=R()}getOptions(){return Object.assign({},this.opts)}_parseOpts(){let e=this.opts.apiPrefix;if(!e||0===e.length)throw Error("invalid empty prefix");"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),this.opts.apiPrefix=e}async _request(e,t=null,r){(r=r||{}).timeout=this.timeout;let s=n;t&&(s=this.jc.encode(t));let{retries:i}=r;i=-1===(i=i||1)?Number.MAX_SAFE_INTEGER:i;let o=P();for(let t=0;t<i;t++)try{let t=await this.nc.request(e,s,r);return this.parseJsResponse(t)}catch(e){if(("503"===e.code||e.code===eg.Timeout)&&t+1<i)await E(o.backoff(t));else throw e}}async findStream(e){let t=await this._request(`${this.prefix}.STREAM.NAMES`,{subject:e});if(!t.streams||1!==t.streams.length)throw Error("no stream matches subject");return t.streams[0]}getConnection(){return this.nc}parseJsResponse(e){let t=this.jc.decode(e.data);if(t.error){let e=J(t.error.code,t.error.description);if(null!==e)throw e.api_error=t.error,e}return t}}class eZ{err;offset;pageInfo;subject;jsm;filter;payload;constructor(e,t,r,s){if(!e)throw Error("subject is required");this.subject=e,this.jsm=r,this.offset=0,this.pageInfo={},this.filter=t,this.payload=s||{}}async next(){if(this.err||this.pageInfo&&this.offset>=this.pageInfo.total)return[];let e={offset:this.offset};this.payload&&Object.assign(e,this.payload);try{let t=await this.jsm._request(this.subject,e,{timeout:this.jsm.timeout});this.pageInfo=t;let r=this.countResponse(t);if(0===r)return[];return this.offset+=r,this.filter(t)}catch(e){throw this.err=e,e}}countResponse(e){switch(e?.type){case"io.nats.jetstream.api.v1.stream_names_response":case"io.nats.jetstream.api.v1.stream_list_response":return e.streams?.length||0;case"io.nats.jetstream.api.v1.consumer_list_response":return e.consumers?.length||0;default:return console.error(`jslister.ts: unknown API response for paged output: ${e?.type}`),e.streams?.length||0}return 0}async *[Symbol.asyncIterator](){let e=await this.next();for(;e.length>0;){for(let t of e)yield t;e=await this.next()}}}function eQ(e=""){let t=e.match(/(\d+).(\d+).(\d+)/);if(t)return{major:parseInt(t[1]),minor:parseInt(t[2]),micro:parseInt(t[3])};throw Error(`'${e}' is not a semver value`)}function e0(e,t){return e.major<t.major?-1:e.major>t.major?1:e.minor<t.minor?-1:e.minor>t.minor?1:e.micro<t.micro?-1:e.micro>t.micro?1:0}!function(e){e.JS_KV="js_kv",e.JS_OBJECTSTORE="js_objectstore",e.JS_PULL_MAX_BYTES="js_pull_max_bytes",e.JS_NEW_CONSUMER_CREATE_API="js_new_consumer_create",e.JS_ALLOW_DIRECT="js_allow_direct",e.JS_MULTIPLE_CONSUMER_FILTER="js_multiple_consumer_filter",e.JS_SIMPLIFICATION="js_simplification",e.JS_STREAM_CONSUMER_METADATA="js_stream_consumer_metadata",e.JS_CONSUMER_FILTER_SUBJECTS="js_consumer_filter_subjects",e.JS_STREAM_FIRST_SEQ="js_stream_first_seq",e.JS_STREAM_SUBJECT_TRANSFORM="js_stream_subject_transform",e.JS_STREAM_SOURCE_SUBJECT_TRANSFORM="js_stream_source_subject_transform",e.JS_STREAM_COMPRESSION="js_stream_compression",e.JS_DEFAULT_CONSUMER_LIMITS="js_default_consumer_limits",e.JS_BATCH_DIRECT_GET="js_batch_direct_get"}(Q||(Q={}));class e1{server;features;disabled;constructor(e){this.features=new Map,this.disabled=[],this.update(e)}resetDisabled(){this.disabled.length=0,this.update(this.server)}disable(e){this.disabled.push(e),this.update(this.server)}isDisabled(e){return -1!==this.disabled.indexOf(e)}update(e){"string"==typeof e&&(e=eQ(e)),this.server=e,this.set(Q.JS_KV,"2.6.2"),this.set(Q.JS_OBJECTSTORE,"2.6.3"),this.set(Q.JS_PULL_MAX_BYTES,"2.8.3"),this.set(Q.JS_NEW_CONSUMER_CREATE_API,"2.9.0"),this.set(Q.JS_ALLOW_DIRECT,"2.9.0"),this.set(Q.JS_MULTIPLE_CONSUMER_FILTER,"2.10.0"),this.set(Q.JS_SIMPLIFICATION,"2.9.4"),this.set(Q.JS_STREAM_CONSUMER_METADATA,"2.10.0"),this.set(Q.JS_CONSUMER_FILTER_SUBJECTS,"2.10.0"),this.set(Q.JS_STREAM_FIRST_SEQ,"2.10.0"),this.set(Q.JS_STREAM_SUBJECT_TRANSFORM,"2.10.0"),this.set(Q.JS_STREAM_SOURCE_SUBJECT_TRANSFORM,"2.10.0"),this.set(Q.JS_STREAM_COMPRESSION,"2.10.0"),this.set(Q.JS_DEFAULT_CONSUMER_LIMITS,"2.10.0"),this.set(Q.JS_BATCH_DIRECT_GET,"2.11.0"),this.disabled.forEach(e=>{this.features.delete(e)})}set(e,t){this.features.set(e,{min:t,ok:e0(this.server,eQ(t))>=0})}get(e){return this.features.get(e)||{min:"unknown",ok:!1}}supports(e){return this.get(e)?.ok||!1}require(e){return"string"==typeof e&&(e=eQ(e)),e0(this.server,e)>=0}}class e2 extends eX{constructor(e,t){super(e,t)}async add(e,t,r=eC.Create){let s;if(q(e),t.deliver_group&&t.flow_control)throw Error("jetstream flow control is not supported with queue groups");if(t.deliver_group&&t.idle_heartbeat)throw Error("jetstream idle heartbeat is not supported with queue groups");let i={};i.config=t,i.stream_name=e,i.action=r,i.config.durable_name&&U(i.config.durable_name);let n=this.nc,{min:o,ok:a}=n.features.get(Q.JS_NEW_CONSUMER_CREATE_API),h=""===t.name?void 0:t.name;if(h&&!a)throw Error(`consumer 'name' requires server ${o}`);if(h)try{F("name",h)}catch(r){let e=r.message,t=e.indexOf("cannot contain");if(-1!==t)throw Error(`consumer 'name' ${e.substring(t)}`);throw r}let c="";if(Array.isArray(t.filter_subjects)){let{min:e,ok:t}=n.features.get(Q.JS_MULTIPLE_CONSUMER_FILTER);if(!t)throw Error(`consumer 'filter_subjects' requires server ${e}`);a=!1}if(t.metadata){let{min:e,ok:t}=n.features.get(Q.JS_STREAM_CONSUMER_METADATA);if(!t)throw Error(`consumer 'metadata' requires server ${e}`)}if(a&&(c=t.name??t.durable_name??""),""!==c){let r=t.filter_subject??void 0;">"===r&&(r=void 0),s=void 0!==r?`${this.prefix}.CONSUMER.CREATE.${e}.${c}.${r}`:`${this.prefix}.CONSUMER.CREATE.${e}.${c}`}else s=t.durable_name?`${this.prefix}.CONSUMER.DURABLE.CREATE.${e}.${t.durable_name}`:`${this.prefix}.CONSUMER.CREATE.${e}`;return await this._request(s,i)}async update(e,t,r){let s=await this.info(e,t);return this.add(e,Object.assign(s.config,r),eC.Update)}async info(e,t){return q(e),U(t),await this._request(`${this.prefix}.CONSUMER.INFO.${e}.${t}`)}async delete(e,t){return q(e),U(t),(await this._request(`${this.prefix}.CONSUMER.DELETE.${e}.${t}`)).success}list(e){return q(e),new eZ(`${this.prefix}.CONSUMER.LIST.${e}`,e=>e.consumers,this)}pause(e,t,r){let s=`${this.prefix}.CONSUMER.PAUSE.${e}.${t}`,i={pause_until:r.toISOString()};return this._request(s,i)}resume(e,t){return this.pause(e,t,new Date(0))}}function e3(e,t,r=!1){if(!0===r&&!e||e&&"function"!=typeof e)throw m.errorForCode(eg.ApiError,Error(`${t} is not a function`))}class e5 extends z{sub;adapter;subIterDone;constructor(e,t,r){super(),e3(r.adapter,"adapter",!0),this.adapter=r.adapter,r.callback&&e3(r.callback,"callback"),this.noIterator="function"==typeof r.callback,r.ingestionFilterFn&&(e3(r.ingestionFilterFn,"ingestionFilterFn"),this.ingestionFilterFn=r.ingestionFilterFn),r.protocolFilterFn&&(e3(r.protocolFilterFn,"protocolFilterFn"),this.protocolFilterFn=r.protocolFilterFn),r.dispatchedFn&&(e3(r.dispatchedFn,"dispatchedFn"),this.dispatchedFn=r.dispatchedFn),r.cleanupFn&&e3(r.cleanupFn,"cleanupFn");let s=(e,t)=>{this.callback(e,t)};if(r.callback){let e=r.callback;s=(t,r)=>{let[s,i]=this.adapter(t,r);if(s){e(s,null);return}let{ingest:n}=this.ingestionFilterFn?this.ingestionFilterFn(i,this):{ingest:!0};n&&(!this.protocolFilterFn||this.protocolFilterFn(i))&&(e(s,i),this.dispatchedFn&&i&&this.dispatchedFn(i))}}let{max:i,queue:n,timeout:o}=r,a={queue:n,timeout:o,callback:s};i&&i>0&&(a.max=i),this.sub=e.subscribe(t,a),r.cleanupFn&&(this.sub.cleanupFn=r.cleanupFn),this.noIterator||this.iterClosed.then(()=>{this.unsubscribe()}),this.subIterDone=x(),Promise.all([this.sub.closed,this.iterClosed]).then(()=>{this.subIterDone.resolve()}).catch(()=>{this.subIterDone.resolve()}),(async e=>{await e.closed,this.stop()})(this.sub).then().catch()}unsubscribe(e){this.sub.unsubscribe(e)}drain(){return this.sub.drain()}isDraining(){return this.sub.isDraining()}isClosed(){return this.sub.isClosed()}callback(e,t){this.sub.cancelTimeout();let[r,s]=this.adapter(e,t);r&&this.stop(r),s&&this.push(s)}getSubject(){return this.sub.getSubject()}getReceived(){return this.sub.getReceived()}getProcessed(){return this.sub.getProcessed()}getPending(){return this.sub.getPending()}getID(){return this.sub.getID()}getMax(){return this.sub.getMax()}get closed(){return this.sub.closed}}function e4(){return void 0!==s&&void 0!==s.defaultPort?s.defaultPort:4222}function e6(){return void 0!==s&&s.urlParseFn?s.urlParseFn:void 0}function e8(){return void 0!==s&&s.dnsResolveFn?s.dnsResolveFn:void 0}let e7=Z.fromAscii("\r\n");function e9(e){return void 0!==function(e){for(let t=0;t<e.length;t++)switch(e[t]){case".":return te(e);case":":return function(e){let t=new Uint8Array(16),r=-1;if(e.length>=2&&":"===e[0]&&":"===e[1]&&(r=0,0===(e=e.substring(2)).length))return t;let s=0;for(;s<16;){let{n:i,c:n,ok:o}=function(e){let t=0,r=0;for(r=0;r<e.length;r++){if(48<=e.charCodeAt(r)&&57>=e.charCodeAt(r))t*=16,t+=e.charCodeAt(r)-48;else if(97<=e.charCodeAt(r)&&102>=e.charCodeAt(r))t*=16,t+=e.charCodeAt(r)-97+10;else if(65<=e.charCodeAt(r)&&70>=e.charCodeAt(r))t*=16,t+=e.charCodeAt(r)-65+10;else break;if(t>=16777215)return{n:0,c:r,ok:!1}}return 0===r?{n:0,c:r,ok:!1}:{n:t,c:r,ok:!0}}(e);if(!o||i>65535)return;if(n<e.length&&"."===e[n]){if(r<0&&12!=s||s+4>16)return;let i=te(e);if(void 0===i)return;t[s]=i[12],t[s+1]=i[13],t[s+2]=i[14],t[s+3]=i[15],e="",s+=4;break}if(t[s]=i>>8,t[s+1]=i,s+=2,0===(e=e.substring(n)).length)break;if(":"!==e[0]||1==e.length)return;if(":"===(e=e.substring(1))[0]){if(r>=0)return;if(r=s,0===(e=e.substring(1)).length)break}}if(0===e.length){if(s<16){if(r<0)return;let e=16-s;for(let i=s-1;i>=r;i--)t[i+e]=t[i];for(let s=r+e-1;s>=r;s--)t[s]=0}else if(r>=0)return;return t}}(e)}}(e)}function te(e){let t=new Uint8Array(4);for(let r=0;r<4;r++){if(0===e.length)return;if(r>0){if("."!==e[0])return;e=e.substring(1)}let{n:s,c:i,ok:n}=function(e){let t=0,r=0;for(t=0;t<e.length&&48<=e.charCodeAt(t)&&57>=e.charCodeAt(t);t++)if((r=10*r+(e.charCodeAt(t)-48))>=16777215)return{n:16777215,c:t,ok:!1};return 0===t?{n:0,c:0,ok:!1}:{n:r,c:t,ok:!0}}(e);if(!n||s>255)return;e=e.substring(i),t[r]=s}return function(e,t,r,s){let i=new Uint8Array(16);return[0,0,0,0,0,0,0,0,0,0,255,255].forEach((e,t)=>{i[t]=e}),i[12]=e,i[13]=t,i[14]=r,i[15]=s,i}(t[0],t[1],t[2],t[3])}function tt(e){return!(-1===e.indexOf("[")&&-1===e.indexOf("::")&&(-1!==e.indexOf(".")||e.split(":").length<=2))}new Uint8Array(e7)[0],new Uint8Array(e7)[1];class tr{src;listen;hostname;port;didConnect;reconnects;lastConnect;gossiped;tlsName;resolves;constructor(e,t=!1){this.src=e,this.tlsName="";let r=function(e){(e=e.trim()).match(/^(.*:\/\/)(.*)/m)&&(e=e.replace(/^(.*:\/\/)(.*)/gm,"$2")),tt(e=function(e){let t="::FFFF:",r=e.toUpperCase().indexOf(t);if(-1!==r&&-1!==e.indexOf(".")){let s=e.substring(r+t.length);return(s=s.replace("[","")).replace("]","")}return e}(e))&&-1===e.indexOf("[")&&(e=`[${e}]`);let t=tt(e)?e.match(/(]:)(\d+)/):e.match(/(:)(\d+)/),r=t&&3===t.length&&t[1]&&t[2]?parseInt(t[2]):4222,s=new URL(`${80===r?"https":"http"}://${e}`);s.port=`${r}`;let i=s.hostname;return"["===i.charAt(0)&&(i=i.substring(1,i.length-1)),{listen:s.host,hostname:i,port:r}}(e);this.listen=r.listen,this.hostname=r.hostname,this.port=r.port,this.didConnect=!1,this.reconnects=0,this.lastConnect=0,this.gossiped=t}toString(){return this.listen}async resolve(e){if(!e.fn||!1===e.resolve)return[this];let t=[];if(e9(this.hostname))return[this];{let r=await e.fn(this.hostname);for(let s of(e.debug&&console.log(`resolve ${this.hostname} = ${r.join(",")}`),r)){let e=80===this.port?"https":"http",r=new URL(`${e}://${tt(s)?"["+s+"]":s}`);r.port=`${this.port}`;let i=new tr(r.host,!1);i.tlsName=this.hostname,t.push(i)}}return e.randomize&&A(t),this.resolves=t,t}}class ts{firstSelect;servers;currentServer;tlsName;randomize;constructor(e=[],t={}){this.firstSelect=!0,this.servers=[],this.tlsName="",this.randomize=t.randomize||!1;let r=e6();e&&(e.forEach(e=>{e=r?r(e):e,this.servers.push(new tr(e))}),this.randomize&&(this.servers=A(this.servers))),0===this.servers.length&&this.addServer(`${w}:${e4()}`,!1),this.currentServer=this.servers[0]}clear(){this.servers.length=0}updateTLSName(){let e=this.getCurrentServer();e9(e.hostname)||(this.tlsName=e.hostname,this.servers.forEach(e=>{e.gossiped&&(e.tlsName=this.tlsName)}))}getCurrentServer(){return this.currentServer}addServer(e,t=!1){let r=e6(),s=new tr(e=r?r(e):e,t);e9(s.hostname)&&(s.tlsName=this.tlsName),this.servers.push(s)}selectServer(){if(this.firstSelect)return this.firstSelect=!1,this.currentServer;let e=this.servers.shift();return e&&(this.servers.push(e),this.currentServer=e),e}removeCurrentServer(){this.removeServer(this.currentServer)}removeServer(e){if(e){let t=this.servers.indexOf(e);this.servers.splice(t,1)}}length(){return this.servers.length}next(){return this.servers.length?this.servers[0]:void 0}getServers(){return this.servers}update(e,t){let r=[],s=[],i=e6(),n=new Map;e.connect_urls&&e.connect_urls.length>0&&e.connect_urls.forEach(e=>{let r=new tr(e=i?i(e,t):e,!0);n.set(e,r)});let o=[];return this.servers.forEach((e,t)=>{let r=e.listen;e.gossiped&&this.currentServer.listen!==r&&void 0===n.get(r)&&o.push(t),n.delete(r)}),o.reverse(),o.forEach(e=>{let t=this.servers.splice(e,1);s=s.concat(t[0].listen)}),n.forEach((e,t)=>{this.servers.push(e),r.push(t)}),{added:r,deleted:s}}}class ti{baseInbox;reqs;constructor(){this.reqs=new Map}size(){return this.reqs.size}init(e){return this.baseInbox=`${y(e)}.`,this.baseInbox}add(e){isNaN(e.received)||(e.received=0),this.reqs.set(e.token,e)}get(e){return this.reqs.get(e)}cancel(e){this.reqs.delete(e.token)}getToken(e){let t=e.subject||"";return 0===t.indexOf(this.baseInbox)?t.substring(this.baseInbox.length):null}all(){return Array.from(this.reqs.values())}handleError(e,t){if(t&&t.permissionContext){if(e)return this.all().forEach(e=>{e.resolver(t,{})}),!0;let r=t.permissionContext;if("publish"===r.operation){let e=this.all().find(e=>e.requestSubject===r.subject);if(e)return e.resolver(t,{}),!0}}return!1}dispatcher(){return(e,t)=>{let r=this.getToken(t);if(r){let s=this.get(r);s&&(null===e&&t.headers&&(e=T(t)),s.resolver(e,t))}}}close(){let e=m.errorForCode(eg.Timeout);this.reqs.forEach(t=>{t.resolver(e,{})})}}class tn{ph;interval;maxOut;timer;pendings;constructor(e,t,r){this.ph=e,this.interval=t,this.maxOut=r,this.pendings=[]}start(){this.cancel(),this._schedule()}cancel(e){this.timer&&(clearTimeout(this.timer),this.timer=void 0),this._reset(),e&&this.ph.disconnect()}_schedule(){this.timer=setTimeout(()=>{if(this.ph.dispatchStatus({type:em.PingTimer,data:`${this.pendings.length+1}`}),this.pendings.length===this.maxOut){this.cancel(!0);return}let e=x();this.ph.flush(e).then(()=>{this._reset()}).catch(()=>{this.cancel()}),this.pendings.push(e),this._schedule()},this.interval)}_reset(){this.pendings=this.pendings.filter(e=>(e.resolve(),!1))}}class to extends Error{constructor(e){super(e),this.name="AssertionError"}}function ta(e,t,r=0){let s=t.byteLength-r;return e.byteLength>s&&(e=e.subarray(0,s)),t.set(e,r),e.byteLength}class th{_buf;_off;constructor(e){if(this._off=0,null==e){this._buf=new Uint8Array(0);return}this._buf=new Uint8Array(e)}bytes(e={copy:!0}){return!1===e.copy?this._buf.subarray(this._off):this._buf.slice(this._off)}empty(){return this._buf.byteLength<=this._off}get length(){return this._buf.byteLength-this._off}get capacity(){return this._buf.buffer.byteLength}truncate(e){if(0===e){this.reset();return}if(e<0||e>this.length)throw Error("bytes.Buffer: truncation out of range");this._reslice(this._off+e)}reset(){this._reslice(0),this._off=0}_tryGrowByReslice(e){let t=this._buf.byteLength;return e<=this.capacity-t?(this._reslice(t+e),t):-1}_reslice(e){(function(e,t="Assertion failed."){if(!e)throw new to(t)})(e<=this._buf.buffer.byteLength),this._buf=new Uint8Array(this._buf.buffer,0,e)}readByte(){let e=new Uint8Array(1);return this.read(e)?e[0]:null}read(e){if(this.empty())return(this.reset(),0===e.byteLength)?0:null;let t=ta(this._buf.subarray(this._off),e);return this._off+=t,t}writeByte(e){return this.write(Uint8Array.of(e))}writeString(e){return this.write(o.encode(e))}write(e){let t=this._grow(e.byteLength);return ta(e,this._buf,t)}_grow(e){let t=this.length;0===t&&0!==this._off&&this.reset();let r=this._tryGrowByReslice(e);if(r>=0)return r;let s=this.capacity;if(e<=Math.floor(s/2)-t)ta(this._buf.subarray(this._off),this._buf);else if(s+e>null)throw Error("The buffer cannot be grown beyond the maximum size.");else{let t=new Uint8Array(Math.min(2*s+e,null));ta(this._buf.subarray(this._off),t),this._buf=t}return this._off=0,this._reslice(Math.min(t+e,null)),t}grow(e){if(e<0)throw Error("Buffer._grow: negative count");let t=this._grow(e);this._reslice(t)}readFrom(e){let t=0,r=new Uint8Array(null);for(;;){let s=this.capacity-this.length<null,i=s?r:new Uint8Array(this._buf.buffer,this.length),n=e.read(i);if(null===n)return t;s?this.write(i.subarray(0,n)):this._reslice(this.length+n),t+=n}}}function tc(){let e={};return e.sid=-1,e.hdr=-1,e.size=-1,e}!function(e){e[e.OK=0]="OK",e[e.ERR=1]="ERR",e[e.MSG=2]="MSG",e[e.INFO=3]="INFO",e[e.PING=4]="PING",e[e.PONG=5]="PONG"}(ee||(ee={}));class tu{dispatcher;state;as;drop;hdr;ma;argBuf;msgBuf;constructor(e){this.dispatcher=e,this.state=et.OP_START,this.as=0,this.drop=0,this.hdr=0}parse(e){let t;for(t=0;t<e.length;t++){let r=e[t];switch(this.state){case et.OP_START:switch(r){case er.M:case er.m:this.state=et.OP_M,this.hdr=-1,this.ma=tc();break;case er.H:case er.h:this.state=et.OP_H,this.hdr=0,this.ma=tc();break;case er.P:case er.p:this.state=et.OP_P;break;case er.PLUS:this.state=et.OP_PLUS;break;case er.MINUS:this.state=et.OP_MINUS;break;case er.I:case er.i:this.state=et.OP_I;break;default:throw this.fail(e.subarray(t))}break;case et.OP_H:switch(r){case er.M:case er.m:this.state=et.OP_M;break;default:throw this.fail(e.subarray(t))}break;case et.OP_M:switch(r){case er.S:case er.s:this.state=et.OP_MS;break;default:throw this.fail(e.subarray(t))}break;case et.OP_MS:switch(r){case er.G:case er.g:this.state=et.OP_MSG;break;default:throw this.fail(e.subarray(t))}break;case et.OP_MSG:switch(r){case er.SPACE:case er.TAB:this.state=et.OP_MSG_SPC;break;default:throw this.fail(e.subarray(t))}break;case et.OP_MSG_SPC:switch(r){case er.SPACE:case er.TAB:continue;default:this.state=et.MSG_ARG,this.as=t}break;case et.MSG_ARG:switch(r){case er.CR:this.drop=1;break;case er.NL:{let r=this.argBuf?this.argBuf.bytes():e.subarray(this.as,t-this.drop);this.processMsgArgs(r),this.drop=0,this.as=t+1,this.state=et.MSG_PAYLOAD,t=this.as+this.ma.size-1;break}default:this.argBuf&&this.argBuf.writeByte(r)}break;case et.MSG_PAYLOAD:if(this.msgBuf){if(this.msgBuf.length>=this.ma.size){let e=this.msgBuf.bytes({copy:!1});this.dispatcher.push({kind:ee.MSG,msg:this.ma,data:e}),this.argBuf=void 0,this.msgBuf=void 0,this.state=et.MSG_END}else{let s=this.ma.size-this.msgBuf.length,i=e.length-t;i<s&&(s=i),s>0?(this.msgBuf.write(e.subarray(t,t+s)),t=t+s-1):this.msgBuf.writeByte(r)}}else t-this.as>=this.ma.size&&(this.dispatcher.push({kind:ee.MSG,msg:this.ma,data:e.subarray(this.as,t)}),this.argBuf=void 0,this.msgBuf=void 0,this.state=et.MSG_END);break;case et.MSG_END:if(r!==er.NL)continue;this.drop=0,this.as=t+1,this.state=et.OP_START;break;case et.OP_PLUS:switch(r){case er.O:case er.o:this.state=et.OP_PLUS_O;break;default:throw this.fail(e.subarray(t))}break;case et.OP_PLUS_O:switch(r){case er.K:case er.k:this.state=et.OP_PLUS_OK;break;default:throw this.fail(e.subarray(t))}break;case et.OP_PLUS_OK:r===er.NL&&(this.dispatcher.push({kind:ee.OK}),this.drop=0,this.state=et.OP_START);break;case et.OP_MINUS:switch(r){case er.E:case er.e:this.state=et.OP_MINUS_E;break;default:throw this.fail(e.subarray(t))}break;case et.OP_MINUS_E:switch(r){case er.R:case er.r:this.state=et.OP_MINUS_ER;break;default:throw this.fail(e.subarray(t))}break;case et.OP_MINUS_ER:switch(r){case er.R:case er.r:this.state=et.OP_MINUS_ERR;break;default:throw this.fail(e.subarray(t))}break;case et.OP_MINUS_ERR:switch(r){case er.SPACE:case er.TAB:this.state=et.OP_MINUS_ERR_SPC;break;default:throw this.fail(e.subarray(t))}break;case et.OP_MINUS_ERR_SPC:switch(r){case er.SPACE:case er.TAB:continue;default:this.state=et.MINUS_ERR_ARG,this.as=t}break;case et.MINUS_ERR_ARG:switch(r){case er.CR:this.drop=1;break;case er.NL:{let r;this.argBuf?(r=this.argBuf.bytes(),this.argBuf=void 0):r=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:ee.ERR,data:r}),this.drop=0,this.as=t+1,this.state=et.OP_START;break}default:this.argBuf&&this.argBuf.write(Uint8Array.of(r))}break;case et.OP_P:switch(r){case er.I:case er.i:this.state=et.OP_PI;break;case er.O:case er.o:this.state=et.OP_PO;break;default:throw this.fail(e.subarray(t))}break;case et.OP_PO:switch(r){case er.N:case er.n:this.state=et.OP_PON;break;default:throw this.fail(e.subarray(t))}break;case et.OP_PON:switch(r){case er.G:case er.g:this.state=et.OP_PONG;break;default:throw this.fail(e.subarray(t))}break;case et.OP_PONG:r===er.NL&&(this.dispatcher.push({kind:ee.PONG}),this.drop=0,this.state=et.OP_START);break;case et.OP_PI:switch(r){case er.N:case er.n:this.state=et.OP_PIN;break;default:throw this.fail(e.subarray(t))}break;case et.OP_PIN:switch(r){case er.G:case er.g:this.state=et.OP_PING;break;default:throw this.fail(e.subarray(t))}break;case et.OP_PING:r===er.NL&&(this.dispatcher.push({kind:ee.PING}),this.drop=0,this.state=et.OP_START);break;case et.OP_I:switch(r){case er.N:case er.n:this.state=et.OP_IN;break;default:throw this.fail(e.subarray(t))}break;case et.OP_IN:switch(r){case er.F:case er.f:this.state=et.OP_INF;break;default:throw this.fail(e.subarray(t))}break;case et.OP_INF:switch(r){case er.O:case er.o:this.state=et.OP_INFO;break;default:throw this.fail(e.subarray(t))}break;case et.OP_INFO:switch(r){case er.SPACE:case er.TAB:this.state=et.OP_INFO_SPC;break;default:throw this.fail(e.subarray(t))}break;case et.OP_INFO_SPC:switch(r){case er.SPACE:case er.TAB:continue;default:this.state=et.INFO_ARG,this.as=t}break;case et.INFO_ARG:switch(r){case er.CR:this.drop=1;break;case er.NL:{let r;this.argBuf?(r=this.argBuf.bytes(),this.argBuf=void 0):r=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:ee.INFO,data:r}),this.drop=0,this.as=t+1,this.state=et.OP_START;break}default:this.argBuf&&this.argBuf.writeByte(r)}break;default:throw this.fail(e.subarray(t))}}this.state!==et.MSG_ARG&&this.state!==et.MINUS_ERR_ARG&&this.state!==et.INFO_ARG||this.argBuf||(this.argBuf=new th(e.subarray(this.as,t-this.drop))),this.state!==et.MSG_PAYLOAD||this.msgBuf||(this.argBuf||this.cloneMsgArg(),this.msgBuf=new th(e.subarray(this.as)))}cloneMsgArg(){let e=this.ma.subject.length,t=new Uint8Array(e+(this.ma.reply?this.ma.reply.length:0));t.set(this.ma.subject),this.ma.reply&&t.set(this.ma.reply,e),this.argBuf=new th(t),this.ma.subject=t.subarray(0,e),this.ma.reply&&(this.ma.reply=t.subarray(e))}processMsgArgs(e){if(this.hdr>=0)return this.processHeaderMsgArgs(e);let t=[],r=-1;for(let s=0;s<e.length;s++)switch(e[s]){case er.SPACE:case er.TAB:case er.CR:case er.NL:r>=0&&(t.push(e.subarray(r,s)),r=-1);break;default:r<0&&(r=s)}switch(r>=0&&t.push(e.subarray(r)),t.length){case 3:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.size=this.protoParseInt(t[2]);break;case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.size=this.protoParseInt(t[3]);break;default:throw this.fail(e,"processMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processMsgArgs Bad or Missing Sid Error");if(this.ma.size<0)throw this.fail(e,"processMsgArgs Bad or Missing Size Error")}fail(e,t=""){return t=t?`${t} [${this.state}]`:`parse error [${this.state}]`,Error(`${t}: ${a.decode(e)}`)}processHeaderMsgArgs(e){let t=[],r=-1;for(let s=0;s<e.length;s++)switch(e[s]){case er.SPACE:case er.TAB:case er.CR:case er.NL:r>=0&&(t.push(e.subarray(r,s)),r=-1);break;default:r<0&&(r=s)}switch(r>=0&&t.push(e.subarray(r)),t.length){case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.hdr=this.protoParseInt(t[2]),this.ma.size=this.protoParseInt(t[3]);break;case 5:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.hdr=this.protoParseInt(t[3]),this.ma.size=this.protoParseInt(t[4]);break;default:throw this.fail(e,"processHeaderMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Sid Error");if(this.ma.hdr<0||this.ma.hdr>this.ma.size)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Header Size Error");if(this.ma.size<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Size Error")}protoParseInt(e){if(0===e.length)return -1;let t=0;for(let r=0;r<e.length;r++){if(e[r]<48||e[r]>57)return -1;t=10*t+(e[r]-48)}return t}}(function(e){e[e.OP_START=0]="OP_START",e[e.OP_PLUS=1]="OP_PLUS",e[e.OP_PLUS_O=2]="OP_PLUS_O",e[e.OP_PLUS_OK=3]="OP_PLUS_OK",e[e.OP_MINUS=4]="OP_MINUS",e[e.OP_MINUS_E=5]="OP_MINUS_E",e[e.OP_MINUS_ER=6]="OP_MINUS_ER",e[e.OP_MINUS_ERR=7]="OP_MINUS_ERR",e[e.OP_MINUS_ERR_SPC=8]="OP_MINUS_ERR_SPC",e[e.MINUS_ERR_ARG=9]="MINUS_ERR_ARG",e[e.OP_M=10]="OP_M",e[e.OP_MS=11]="OP_MS",e[e.OP_MSG=12]="OP_MSG",e[e.OP_MSG_SPC=13]="OP_MSG_SPC",e[e.MSG_ARG=14]="MSG_ARG",e[e.MSG_PAYLOAD=15]="MSG_PAYLOAD",e[e.MSG_END=16]="MSG_END",e[e.OP_H=17]="OP_H",e[e.OP_P=18]="OP_P",e[e.OP_PI=19]="OP_PI",e[e.OP_PIN=20]="OP_PIN",e[e.OP_PING=21]="OP_PING",e[e.OP_PO=22]="OP_PO",e[e.OP_PON=23]="OP_PON",e[e.OP_PONG=24]="OP_PONG",e[e.OP_I=25]="OP_I",e[e.OP_IN=26]="OP_IN",e[e.OP_INF=27]="OP_INF",e[e.OP_INFO=28]="OP_INFO",e[e.OP_INFO_SPC=29]="OP_INFO_SPC",e[e.INFO_ARG=30]="INFO_ARG"})(et||(et={})),function(e){e[e.CR="\r".charCodeAt(0)]="CR",e[e.E="E".charCodeAt(0)]="E",e[e.e="e".charCodeAt(0)]="e",e[e.F="F".charCodeAt(0)]="F",e[e.f="f".charCodeAt(0)]="f",e[e.G="G".charCodeAt(0)]="G",e[e.g="g".charCodeAt(0)]="g",e[e.H="H".charCodeAt(0)]="H",e[e.h="h".charCodeAt(0)]="h",e[e.I="I".charCodeAt(0)]="I",e[e.i="i".charCodeAt(0)]="i",e[e.K="K".charCodeAt(0)]="K",e[e.k="k".charCodeAt(0)]="k",e[e.M="M".charCodeAt(0)]="M",e[e.m="m".charCodeAt(0)]="m",e[e.MINUS="-".charCodeAt(0)]="MINUS",e[e.N="N".charCodeAt(0)]="N",e[e.n="n".charCodeAt(0)]="n",e[e.NL="\n".charCodeAt(0)]="NL",e[e.O="O".charCodeAt(0)]="O",e[e.o="o".charCodeAt(0)]="o",e[e.P="P".charCodeAt(0)]="P",e[e.p="p".charCodeAt(0)]="p",e[e.PLUS="+".charCodeAt(0)]="PLUS",e[e.R="R".charCodeAt(0)]="R",e[e.r="r".charCodeAt(0)]="r",e[e.S="S".charCodeAt(0)]="S",e[e.s="s".charCodeAt(0)]="s",e[e.SPACE=" ".charCodeAt(0)]="SPACE",e[e.TAB="	".charCodeAt(0)]="TAB"}(er||(er={})),function(e){var t,r=function(e,t){this.hi=0|e,this.lo=0|t},s=function(e){var t,r=new Float64Array(16);if(e)for(t=0;t<e.length;t++)r[t]=e[t];return r},i=function(){throw Error("no PRNG")},n=new Uint8Array(16),o=new Uint8Array(32);o[0]=9;var a=s(),h=s([1]),c=s([56129,1]),u=s([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),l=s([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),d=s([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),f=s([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),p=s([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function m(e,t){return e<<t|e>>>32-t}function g(e,t){var r=255&e[t+3];return(r=(r=r<<8|255&e[t+2])<<8|255&e[t+1])<<8|255&e[t+0]}function b(e,t){return new r(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],e[t+4]<<24|e[t+5]<<16|e[t+6]<<8|e[t+7])}function _(e,t,r){var s;for(s=0;s<4;s++)e[t+s]=255&r,r>>>=8}function y(e,t,r){e[t]=r.hi>>24&255,e[t+1]=r.hi>>16&255,e[t+2]=r.hi>>8&255,e[t+3]=255&r.hi,e[t+4]=r.lo>>24&255,e[t+5]=r.lo>>16&255,e[t+6]=r.lo>>8&255,e[t+7]=255&r.lo}function w(e,t,r,s,i){var n,o=0;for(n=0;n<i;n++)o|=e[t+n]^r[s+n];return(1&o-1>>>8)-1}function S(e,t,r,s){return w(e,t,r,s,16)}function v(e,t,r,s){return w(e,t,r,s,32)}function E(e,t,r,s,i){var n,o,a,h=new Uint32Array(16),c=new Uint32Array(16),u=new Uint32Array(16),l=new Uint32Array(4);for(n=0;n<4;n++)c[5*n]=g(s,4*n),c[1+n]=g(r,4*n),c[6+n]=g(t,4*n),c[11+n]=g(r,16+4*n);for(n=0;n<16;n++)u[n]=c[n];for(n=0;n<20;n++){for(o=0;o<4;o++){for(a=0;a<4;a++)l[a]=c[(5*o+4*a)%16];for(l[1]^=m(l[0]+l[3]|0,7),l[2]^=m(l[1]+l[0]|0,9),l[3]^=m(l[2]+l[1]|0,13),l[0]^=m(l[3]+l[2]|0,18),a=0;a<4;a++)h[4*o+(o+a)%4]=l[a]}for(a=0;a<16;a++)c[a]=h[a]}if(i){for(n=0;n<16;n++)c[n]=c[n]+u[n]|0;for(n=0;n<4;n++)c[5*n]=c[5*n]-g(s,4*n)|0,c[6+n]=c[6+n]-g(t,4*n)|0;for(n=0;n<4;n++)_(e,4*n,c[5*n]),_(e,16+4*n,c[6+n])}else for(n=0;n<16;n++)_(e,4*n,c[n]+u[n]|0)}function x(e,t,r,s){return E(e,t,r,s,!0),0}var A=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function P(e,t,r,s,i,n,o){var a,h,c=new Uint8Array(16),u=new Uint8Array(64);if(!i)return 0;for(h=0;h<16;h++)c[h]=0;for(h=0;h<8;h++)c[h]=n[h];for(;i>=64;){for(E(u,c,o,A,!1),h=0;h<64;h++)e[t+h]=(r?r[s+h]:0)^u[h];for(h=8,a=1;h<16;h++)a=a+(255&c[h])|0,c[h]=255&a,a>>>=8;i-=64,t+=64,r&&(s+=64)}if(i>0)for(E(u,c,o,A,!1),h=0;h<i;h++)e[t+h]=(r?r[s+h]:0)^u[h];return 0}function O(e,t,r,s,i){return P(e,t,null,0,r,s,i)}function k(e,t,r,s,i){var n=new Uint8Array(32);return x(n,s,i,A),O(e,t,r,s.subarray(16),n)}function C(e,t,r,s,i,n,o){var a=new Uint8Array(32);return x(a,n,o,A),P(e,t,r,s,i,n.subarray(16),a)}function j(e,t){var r,s=0;for(r=0;r<17;r++)s=s+(e[r]+t[r]|0)|0,e[r]=255&s,s>>>=8}var I=new Uint32Array([5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,252]);function N(e,t,r,s,i,n){var o,a,h,c,u=new Uint32Array(17),l=new Uint32Array(17),d=new Uint32Array(17),f=new Uint32Array(17),p=new Uint32Array(17);for(h=0;h<17;h++)l[h]=d[h]=0;for(h=0;h<16;h++)l[h]=n[h];for(l[3]&=15,l[4]&=252,l[7]&=15,l[8]&=252,l[11]&=15,l[12]&=252,l[15]&=15;i>0;){for(h=0;h<17;h++)f[h]=0;for(h=0;h<16&&h<i;++h)f[h]=r[s+h];for(f[h]=1,s+=h,i-=h,j(d,f),a=0;a<17;a++)for(h=0,u[a]=0;h<17;h++)u[a]=u[a]+d[h]*(h<=a?l[a-h]:320*l[a+17-h]|0)|0;for(a=0;a<17;a++)d[a]=u[a];for(h=0,c=0;h<16;h++)c=c+d[h]|0,d[h]=255&c,c>>>=8;for(h=0,c=c+d[16]|0,d[16]=3&c,c=5*(c>>>2)|0;h<16;h++)c=c+d[h]|0,d[h]=255&c,c>>>=8;c=c+d[16]|0,d[16]=c}for(h=0;h<17;h++)p[h]=d[h];for(j(d,I),o=0|-(d[16]>>>7),h=0;h<17;h++)d[h]^=o&(p[h]^d[h]);for(h=0;h<16;h++)f[h]=n[h+16];for(f[16]=0,j(d,f),h=0;h<16;h++)e[t+h]=d[h];return 0}function M(e,t,r,s,i,n){var o=new Uint8Array(16);return N(o,0,r,s,i,n),S(e,t,o,0)}function R(e,t,r,s,i){var n;if(r<32)return -1;for(C(e,0,t,0,r,s,i),N(e,16,e,32,r-32,e),n=0;n<16;n++)e[n]=0;return 0}function T(e,t,r,s,i){var n,o=new Uint8Array(32);if(r<32||(k(o,0,32,s,i),0!==M(t,16,t,32,r-32,o)))return -1;for(C(e,0,t,0,r,s,i),n=0;n<32;n++)e[n]=0;return 0}function $(e,t){var r;for(r=0;r<16;r++)e[r]=0|t[r]}function U(e){var t,r;for(r=0;r<16;r++)e[r]+=65536,t=Math.floor(e[r]/65536),e[(r+1)*(r<15?1:0)]+=t-1+37*(t-1)*(15===r?1:0),e[r]-=65536*t}function q(e,t,r){for(var s,i=~(r-1),n=0;n<16;n++)s=i&(e[n]^t[n]),e[n]^=s,t[n]^=s}function F(e,t){var r,i,n,o=s(),a=s();for(r=0;r<16;r++)a[r]=t[r];for(U(a),U(a),U(a),i=0;i<2;i++){for(r=1,o[0]=a[0]-65517;r<15;r++)o[r]=a[r]-65535-(o[r-1]>>16&1),o[r-1]&=65535;o[15]=a[15]-32767-(o[14]>>16&1),n=o[15]>>16&1,o[14]&=65535,q(a,o,1-n)}for(r=0;r<16;r++)e[2*r]=255&a[r],e[2*r+1]=a[r]>>8}function L(e,t){var r=new Uint8Array(32),s=new Uint8Array(32);return F(r,e),F(s,t),v(r,0,s,0)}function B(e){var t=new Uint8Array(32);return F(t,e),1&t[0]}function D(e,t){var r;for(r=0;r<16;r++)e[r]=t[2*r]+(t[2*r+1]<<8);e[15]&=32767}function H(e,t,r){var s;for(s=0;s<16;s++)e[s]=t[s]+r[s]|0}function J(e,t,r){var s;for(s=0;s<16;s++)e[s]=t[s]-r[s]|0}function z(e,t,r){var s,i,n=new Float64Array(31);for(s=0;s<31;s++)n[s]=0;for(s=0;s<16;s++)for(i=0;i<16;i++)n[s+i]+=t[s]*r[i];for(s=0;s<15;s++)n[s]+=38*n[s+16];for(s=0;s<16;s++)e[s]=n[s];U(e),U(e)}function G(e,t){z(e,t,t)}function K(e,t){var r,i=s();for(r=0;r<16;r++)i[r]=t[r];for(r=253;r>=0;r--)G(i,i),2!==r&&4!==r&&z(i,i,t);for(r=0;r<16;r++)e[r]=i[r]}function V(e,t){var r,i=s();for(r=0;r<16;r++)i[r]=t[r];for(r=250;r>=0;r--)G(i,i),1!==r&&z(i,i,t);for(r=0;r<16;r++)e[r]=i[r]}function W(e,t,r){var i,n,o=new Uint8Array(32),a=new Float64Array(80),h=s(),u=s(),l=s(),d=s(),f=s(),p=s();for(n=0;n<31;n++)o[n]=t[n];for(o[31]=127&t[31]|64,o[0]&=248,D(a,r),n=0;n<16;n++)u[n]=a[n],d[n]=h[n]=l[n]=0;for(n=254,h[0]=d[0]=1;n>=0;--n)q(h,u,i=o[n>>>3]>>>(7&n)&1),q(l,d,i),H(f,h,l),J(h,h,l),H(l,u,d),J(u,u,d),G(d,f),G(p,h),z(h,l,h),z(l,u,f),H(f,h,l),J(h,h,l),G(u,h),J(l,d,p),z(h,l,c),H(h,h,d),z(l,l,h),z(h,d,p),z(d,u,a),G(u,f),q(h,u,i),q(l,d,i);for(n=0;n<16;n++)a[n+16]=h[n],a[n+32]=l[n],a[n+48]=u[n],a[n+64]=d[n];var m=a.subarray(32),g=a.subarray(16);return K(m,m),z(g,g,m),F(e,g),0}function Y(e,t){return W(e,t,o)}function X(e,t){return i(t,32),Y(e,t)}function Z(e,t,r){var s=new Uint8Array(32);return W(s,r,t),x(e,n,s,A)}function Q(){var e,t,s,i=0,n=0,o=0,a=0;for(s=0;s<arguments.length;s++)e=arguments[s].lo,t=arguments[s].hi,i+=65535&e,n+=e>>>16,o+=65535&t,a+=t>>>16;return n+=i>>>16,o+=n>>>16,a+=o>>>16,new r(65535&o|a<<16,65535&i|n<<16)}function ee(e,t){return new r(e.hi>>>t,e.lo>>>t|e.hi<<32-t)}function et(){var e,t=0,s=0;for(e=0;e<arguments.length;e++)t^=arguments[e].lo,s^=arguments[e].hi;return new r(s,t)}function er(e,t){var s,i,n=32-t;return t<32?(s=e.hi>>>t|e.lo<<n,i=e.lo>>>t|e.hi<<n):t<64&&(s=e.lo>>>t|e.hi<<n,i=e.hi>>>t|e.lo<<n),new r(s,i)}var es=[new r(1116352408,3609767458),new r(1899447441,602891725),new r(3049323471,3964484399),new r(3921009573,2173295548),new r(961987163,4081628472),new r(1508970993,3053834265),new r(2453635748,2937671579),new r(2870763221,3664609560),new r(3624381080,2734883394),new r(310598401,1164996542),new r(607225278,1323610764),new r(1426881987,3590304994),new r(1925078388,4068182383),new r(2162078206,991336113),new r(2614888103,633803317),new r(3248222580,3479774868),new r(3835390401,2666613458),new r(4022224774,944711139),new r(264347078,2341262773),new r(604807628,2007800933),new r(770255983,1495990901),new r(1249150122,1856431235),new r(1555081692,3175218132),new r(1996064986,2198950837),new r(2554220882,3999719339),new r(2821834349,766784016),new r(2952996808,2566594879),new r(3210313671,3203337956),new r(3336571891,1034457026),new r(3584528711,2466948901),new r(113926993,3758326383),new r(338241895,168717936),new r(666307205,1188179964),new r(773529912,1546045734),new r(1294757372,1522805485),new r(1396182291,2643833823),new r(1695183700,2343527390),new r(1986661051,1014477480),new r(2177026350,1206759142),new r(2456956037,344077627),new r(2730485921,1290863460),new r(2820302411,3158454273),new r(3259730800,3505952657),new r(3345764771,106217008),new r(3516065817,3606008344),new r(3600352804,1432725776),new r(4094571909,1467031594),new r(275423344,851169720),new r(430227734,3100823752),new r(506948616,1363258195),new r(659060556,3750685593),new r(883997877,3785050280),new r(958139571,3318307427),new r(1322822218,3812723403),new r(1537002063,2003034995),new r(1747873779,3602036899),new r(1955562222,1575990012),new r(2024104815,1125592928),new r(2227730452,2716904306),new r(2361852424,442776044),new r(2428436474,593698344),new r(2756734187,3733110249),new r(3204031479,2999351573),new r(3329325298,3815920427),new r(3391569614,3928383900),new r(3515267271,566280711),new r(3940187606,3454069534),new r(4118630271,4000239992),new r(116418474,1914138554),new r(174292421,2731055270),new r(289380356,3203993006),new r(460393269,320620315),new r(685471733,587496836),new r(852142971,1086792851),new r(1017036298,365543100),new r(1126000580,2618297676),new r(1288033470,3409855158),new r(1501505948,4234509866),new r(1607167915,987167468),new r(1816402316,1246189591)];function ei(e,t,s){var i,n,o,a,h,c,u,l,d,f,p,m,g,_=[],w=[],S=[],v=[];for(m=0;m<8;m++)_[m]=S[m]=b(e,8*m);for(var E=0;s>=128;){for(m=0;m<16;m++)v[m]=b(t,8*m+E);for(m=0;m<80;m++){for(g=0;g<8;g++)w[g]=S[g];for(g=0,p=Q(S[7],et(er(i=S[4],14),er(i,18),er(i,41)),(n=S[4],o=S[5],a=S[6],new r(n.hi&o.hi^~n.hi&a.hi,n.lo&o.lo^~n.lo&a.lo)),es[m],v[m%16]),w[7]=Q(p,et(er(h=S[0],28),er(h,34),er(h,39)),(c=S[0],u=S[1],l=S[2],new r(c.hi&u.hi^c.hi&l.hi^u.hi&l.hi,c.lo&u.lo^c.lo&l.lo^u.lo&l.lo))),w[3]=Q(w[3],p);g<8;g++)S[(g+1)%8]=w[g];if(m%16==15)for(g=0;g<16;g++)v[g]=Q(v[g],v[(g+9)%16],et(er(d=v[(g+1)%16],1),er(d,8),ee(d,7)),et(er(f=v[(g+14)%16],19),er(f,61),ee(f,6)))}for(m=0;m<8;m++)S[m]=Q(S[m],_[m]),_[m]=S[m];E+=128,s-=128}for(m=0;m<8;m++)y(e,8*m,_[m]);return s}var en=new Uint8Array([106,9,230,103,243,188,201,8,187,103,174,133,132,202,167,59,60,110,243,114,254,148,248,43,165,79,245,58,95,29,54,241,81,14,82,127,173,230,130,209,155,5,104,140,43,62,108,31,31,131,217,171,251,65,189,107,91,224,205,25,19,126,33,121]);function eo(e,t,s){var i,n=new Uint8Array(64),o=new Uint8Array(256),a=s;for(i=0;i<64;i++)n[i]=en[i];for(ei(n,t,s),s%=128,i=0;i<256;i++)o[i]=0;for(i=0;i<s;i++)o[i]=t[a-s+i];for(o[s]=128,o[(s=256-128*(s<112?1:0))-9]=0,y(o,s-8,new r(a/536870912|0,a<<3)),ei(n,o,s),i=0;i<64;i++)e[i]=n[i];return 0}function ea(e,t){var r=s(),i=s(),n=s(),o=s(),a=s(),h=s(),c=s(),u=s(),d=s();J(r,e[1],e[0]),J(d,t[1],t[0]),z(r,r,d),H(i,e[0],e[1]),H(d,t[0],t[1]),z(i,i,d),z(n,e[3],t[3]),z(n,n,l),z(o,e[2],t[2]),H(o,o,o),J(a,i,r),J(h,o,n),H(c,o,n),H(u,i,r),z(e[0],a,h),z(e[1],u,c),z(e[2],c,h),z(e[3],a,u)}function eh(e,t,r){var s;for(s=0;s<4;s++)q(e[s],t[s],r)}function ec(e,t){var r=s(),i=s(),n=s();K(n,t[2]),z(r,t[0],n),z(i,t[1],n),F(e,i),e[31]^=B(r)<<7}function eu(e,t,r){var s,i;for($(e[0],a),$(e[1],h),$(e[2],h),$(e[3],a),i=255;i>=0;--i)eh(e,t,s=r[i/8|0]>>(7&i)&1),ea(t,e),ea(e,e),eh(e,t,s)}function el(e,t){var r=[s(),s(),s(),s()];$(r[0],d),$(r[1],f),$(r[2],h),z(r[3],d,f),eu(e,r,t)}function ed(e,t,r){var n,o=new Uint8Array(64),a=[s(),s(),s(),s()];for(r||i(t,32),eo(o,t,32),o[0]&=248,o[31]&=127,o[31]|=64,el(a,o),ec(e,a),n=0;n<32;n++)t[n+32]=e[n];return 0}var ef=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function ep(e,t){var r,s,i,n;for(s=63;s>=32;--s){for(r=0,i=s-32,n=s-12;i<n;++i)t[i]+=r-16*t[s]*ef[i-(s-32)],r=Math.floor((t[i]+128)/256),t[i]-=256*r;t[i]+=r,t[s]=0}for(i=0,r=0;i<32;i++)t[i]+=r-(t[31]>>4)*ef[i],r=t[i]>>8,t[i]&=255;for(i=0;i<32;i++)t[i]-=r*ef[i];for(s=0;s<32;s++)t[s+1]+=t[s]>>8,e[s]=255&t[s]}function em(e){var t,r=new Float64Array(64);for(t=0;t<64;t++)r[t]=e[t];for(t=0;t<64;t++)e[t]=0;ep(e,r)}function eg(e,t,r,i){var n,o,a=new Uint8Array(64),h=new Uint8Array(64),c=new Uint8Array(64),u=new Float64Array(64),l=[s(),s(),s(),s()];for(eo(a,i,32),a[0]&=248,a[31]&=127,a[31]|=64,n=0;n<r;n++)e[64+n]=t[n];for(n=0;n<32;n++)e[32+n]=a[32+n];for(eo(c,e.subarray(32),r+32),em(c),el(l,c),ec(e,l),n=32;n<64;n++)e[n]=i[n];for(eo(h,e,r+64),em(h),n=0;n<64;n++)u[n]=0;for(n=0;n<32;n++)u[n]=c[n];for(n=0;n<32;n++)for(o=0;o<32;o++)u[n+o]+=h[n]*a[o];return ep(e.subarray(32),u),r+64}function eb(e,t,r,i){var n,o,c,l,d,f,m,g,b=new Uint8Array(32),_=new Uint8Array(64),y=[s(),s(),s(),s()],w=[s(),s(),s(),s()];if(r<64||(n=s(),o=s(),c=s(),l=s(),d=s(),f=s(),m=s(),($(w[2],h),D(w[1],i),G(c,w[1]),z(l,c,u),J(c,c,w[2]),H(l,w[2],l),G(d,l),G(f,d),z(m,f,d),z(n,m,c),z(n,n,l),V(n,n),z(n,n,c),z(n,n,l),z(n,n,l),z(w[0],n,l),G(o,w[0]),z(o,o,l),L(o,c)&&z(w[0],w[0],p),G(o,w[0]),z(o,o,l),L(o,c))?-1:(B(w[0])===i[31]>>7&&J(w[0],a,w[0]),z(w[3],w[0],w[1]),0)))return -1;for(g=0;g<r;g++)e[g]=t[g];for(g=0;g<32;g++)e[g+32]=i[g];if(eo(_,e,r),em(_),eu(y,w,_),el(w,t.subarray(32)),ea(y,w),ec(b,y),r-=64,v(t,0,b,0)){for(g=0;g<r;g++)e[g]=0;return -1}for(g=0;g<r;g++)e[g]=t[g+64];return r}function e_(e,t){if(32!==e.length)throw Error("bad key size");if(24!==t.length)throw Error("bad nonce size")}function ey(){for(var e=0;e<arguments.length;e++)if(!(arguments[e]instanceof Uint8Array))throw TypeError("unexpected type, use Uint8Array")}function ew(e){for(var t=0;t<e.length;t++)e[t]=0}e.lowlevel={crypto_core_hsalsa20:x,crypto_stream_xor:C,crypto_stream:k,crypto_stream_salsa20_xor:P,crypto_stream_salsa20:O,crypto_onetimeauth:N,crypto_onetimeauth_verify:M,crypto_verify_16:S,crypto_verify_32:v,crypto_secretbox:R,crypto_secretbox_open:T,crypto_scalarmult:W,crypto_scalarmult_base:Y,crypto_box_beforenm:Z,crypto_box_afternm:R,crypto_box:function(e,t,r,s,i,n){var o=new Uint8Array(32);return Z(o,i,n),R(e,t,r,s,o)},crypto_box_open:function(e,t,r,s,i,n){var o=new Uint8Array(32);return Z(o,i,n),T(e,t,r,s,o)},crypto_box_keypair:X,crypto_hash:eo,crypto_sign:eg,crypto_sign_keypair:ed,crypto_sign_open:eb,crypto_secretbox_KEYBYTES:32,crypto_secretbox_NONCEBYTES:24,crypto_secretbox_ZEROBYTES:32,crypto_secretbox_BOXZEROBYTES:16,crypto_scalarmult_BYTES:32,crypto_scalarmult_SCALARBYTES:32,crypto_box_PUBLICKEYBYTES:32,crypto_box_SECRETKEYBYTES:32,crypto_box_BEFORENMBYTES:32,crypto_box_NONCEBYTES:24,crypto_box_ZEROBYTES:32,crypto_box_BOXZEROBYTES:16,crypto_sign_BYTES:64,crypto_sign_PUBLICKEYBYTES:32,crypto_sign_SECRETKEYBYTES:64,crypto_sign_SEEDBYTES:32,crypto_hash_BYTES:64,gf:s,D:u,L:ef,pack25519:F,unpack25519:D,M:z,A:H,S:G,Z:J,pow2523:V,add:ea,set25519:$,modL:ep,scalarmult:eu,scalarbase:el},e.randomBytes=function(e){var t=new Uint8Array(e);return i(t,e),t},e.secretbox=function(e,t,r){ey(e,t,r),e_(r,t);for(var s=new Uint8Array(32+e.length),i=new Uint8Array(s.length),n=0;n<e.length;n++)s[n+32]=e[n];return R(i,s,s.length,t,r),i.subarray(16)},e.secretbox.open=function(e,t,r){ey(e,t,r),e_(r,t);for(var s=new Uint8Array(16+e.length),i=new Uint8Array(s.length),n=0;n<e.length;n++)s[n+16]=e[n];return s.length<32||0!==T(i,s,s.length,t,r)?null:i.subarray(32)},e.secretbox.keyLength=32,e.secretbox.nonceLength=24,e.secretbox.overheadLength=16,e.scalarMult=function(e,t){if(ey(e,t),32!==e.length)throw Error("bad n size");if(32!==t.length)throw Error("bad p size");var r=new Uint8Array(32);return W(r,e,t),r},e.scalarMult.base=function(e){if(ey(e),32!==e.length)throw Error("bad n size");var t=new Uint8Array(32);return Y(t,e),t},e.scalarMult.scalarLength=32,e.scalarMult.groupElementLength=32,e.box=function(t,r,s,i){var n=e.box.before(s,i);return e.secretbox(t,r,n)},e.box.before=function(e,t){ey(e,t),function(e,t){if(32!==e.length)throw Error("bad public key size");if(32!==t.length)throw Error("bad secret key size")}(e,t);var r=new Uint8Array(32);return Z(r,e,t),r},e.box.after=e.secretbox,e.box.open=function(t,r,s,i){var n=e.box.before(s,i);return e.secretbox.open(t,r,n)},e.box.open.after=e.secretbox.open,e.box.keyPair=function(){var e=new Uint8Array(32),t=new Uint8Array(32);return X(e,t),{publicKey:e,secretKey:t}},e.box.keyPair.fromSecretKey=function(e){if(ey(e),32!==e.length)throw Error("bad secret key size");var t=new Uint8Array(32);return Y(t,e),{publicKey:t,secretKey:new Uint8Array(e)}},e.box.publicKeyLength=32,e.box.secretKeyLength=32,e.box.sharedKeyLength=32,e.box.nonceLength=24,e.box.overheadLength=e.secretbox.overheadLength,e.sign=function(e,t){if(ey(e,t),64!==t.length)throw Error("bad secret key size");var r=new Uint8Array(64+e.length);return eg(r,e,e.length,t),r},e.sign.open=function(e,t){if(ey(e,t),32!==t.length)throw Error("bad public key size");var r=new Uint8Array(e.length),s=eb(r,e,e.length,t);if(s<0)return null;for(var i=new Uint8Array(s),n=0;n<i.length;n++)i[n]=r[n];return i},e.sign.detached=function(t,r){for(var s=e.sign(t,r),i=new Uint8Array(64),n=0;n<i.length;n++)i[n]=s[n];return i},e.sign.detached.verify=function(e,t,r){if(ey(e,t,r),64!==t.length)throw Error("bad signature size");if(32!==r.length)throw Error("bad public key size");var s,i=new Uint8Array(64+e.length),n=new Uint8Array(64+e.length);for(s=0;s<64;s++)i[s]=t[s];for(s=0;s<e.length;s++)i[s+64]=e[s];return eb(n,i,i.length,r)>=0},e.sign.keyPair=function(){var e=new Uint8Array(32),t=new Uint8Array(64);return ed(e,t),{publicKey:e,secretKey:t}},e.sign.keyPair.fromSecretKey=function(e){if(ey(e),64!==e.length)throw Error("bad secret key size");for(var t=new Uint8Array(32),r=0;r<t.length;r++)t[r]=e[32+r];return{publicKey:t,secretKey:new Uint8Array(e)}},e.sign.keyPair.fromSeed=function(e){if(ey(e),32!==e.length)throw Error("bad seed size");for(var t=new Uint8Array(32),r=new Uint8Array(64),s=0;s<32;s++)r[s]=e[s];return ed(t,r,!0),{publicKey:t,secretKey:r}},e.sign.publicKeyLength=32,e.sign.secretKeyLength=64,e.sign.seedLength=32,e.sign.signatureLength=64,e.hash=function(e){ey(e);var t=new Uint8Array(64);return eo(t,e,e.length),t},e.hash.hashLength=64,e.verify=function(e,t){return ey(e,t),0!==e.length&&0!==t.length&&e.length===t.length&&0===w(e,0,t,0,e.length)},e.setPRNG=function(e){i=e},(t="undefined"!=typeof globalThis?globalThis.crypto||globalThis.msCrypto:null)&&t.getRandomValues?e.setPRNG(function(e,r){var s,i=new Uint8Array(r);for(s=0;s<r;s+=65536)t.getRandomValues(i.subarray(s,s+Math.min(r-s,65536)));for(s=0;s<r;s++)e[s]=i[s];ew(i)}):"undefined"!=typeof require&&(t=require("crypto"))&&t.randomBytes&&e.setPRNG(function(e,r){var s,i=t.randomBytes(r);for(s=0;s<r;s++)e[s]=i[s];ew(i)})}("undefined"!=typeof module&&module.exports?module.exports:globalThis.nacl=globalThis.nacl||{});let tl="undefined"!=typeof module&&module.exports?module.exports:globalThis.nacl,td={fromSeed:tl.sign.keyPair.fromSeed,sign:tl.sign.detached,verify:tl.sign.detached.verify,randomBytes:tl.randomBytes},tf=new Uint16Array([0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920]);class tp{static checksum(e){let t=0;for(let r=0;r<e.byteLength;r++)t=t<<8&65535^tf[(t>>8^e[r])&255];return t}static validate(e,t){return tp.checksum(e)==t}}let tm="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";class tg{static encode(e){let t=0,r=0,s=new Uint8Array(e),i=new Uint8Array(2*e.byteLength),n=0;for(let e=0;e<s.byteLength;e++)for(r=r<<8|s[e],t+=8;t>=5;){let e=r>>>t-5&31;i[n++]=tm.charAt(e).charCodeAt(0),t-=5}if(t>0){let e=r<<5-t&31;i[n++]=tm.charAt(e).charCodeAt(0)}return i.slice(0,n)}static decode(e){let t=0,r=0,s=0,i=new Uint8Array(e),n=new Uint8Array(5*i.byteLength/8|0);for(let e=0;e<i.byteLength;e++){let o=String.fromCharCode(i[e]),a=tm.indexOf(o);if(-1===a)throw Error("Illegal Base32 character: "+i[e]);r=r<<5|a,(t+=5)>=8&&(n[s++]=r>>>t-8&255,t-=8)}return n.slice(0,s)}}class tb extends Error{name;code;chainedError;constructor(e,t){super(e),this.name="NKeysError",this.code=e,this.chainedError=t}}(function(e){e.InvalidPrefixByte="nkeys: invalid prefix byte",e.InvalidKey="nkeys: invalid key",e.InvalidPublicKey="nkeys: invalid public key",e.InvalidSeedLen="nkeys: invalid seed length",e.InvalidSeed="nkeys: invalid seed",e.InvalidEncoding="nkeys: invalid encoded key",e.InvalidSignature="nkeys: signature verification failed",e.CannotSign="nkeys: cannot sign, no private key available",e.PublicKeyOnly="nkeys: no seed or private key available",e.InvalidChecksum="nkeys: invalid checksum",e.SerializationError="nkeys: serialization error",e.ApiError="nkeys: api error",e.ClearedPair="nkeys: pair is cleared"})(es||(es={})),function(e){e[e.Seed=144]="Seed",e[e.Private=120]="Private",e[e.Operator=112]="Operator",e[e.Server=104]="Server",e[e.Cluster=16]="Cluster",e[e.Account=0]="Account",e[e.User=160]="User"}(ei||(ei={}));class t_{static isValidPublicPrefix(e){return e==ei.Server||e==ei.Operator||e==ei.Cluster||e==ei.Account||e==ei.User}static startsWithValidPrefix(e){let t=e[0];return"S"==t||"P"==t||"O"==t||"N"==t||"C"==t||"A"==t||"U"==t}static isValidPrefix(e){return -1!=this.parsePrefix(e)}static parsePrefix(e){switch(e){case ei.Seed:return ei.Seed;case ei.Private:return ei.Private;case ei.Operator:return ei.Operator;case ei.Server:return ei.Server;case ei.Cluster:return ei.Cluster;case ei.Account:return ei.Account;case ei.User:return ei.User;default:return -1}}}class ty{static encode(e,t){if(!t||!(t instanceof Uint8Array))throw new tb(es.SerializationError);if(!t_.isValidPrefix(e))throw new tb(es.InvalidPrefixByte);return ty._encode(!1,e,t)}static encodeSeed(e,t){if(!t)throw new tb(es.ApiError);if(!t_.isValidPublicPrefix(e))throw new tb(es.InvalidPrefixByte);if(32!==t.byteLength)throw new tb(es.InvalidSeedLen);return ty._encode(!0,e,t)}static decode(e,t){if(!t_.isValidPrefix(e))throw new tb(es.InvalidPrefixByte);let r=ty._decode(t);if(r[0]!==e)throw new tb(es.InvalidPrefixByte);return r.slice(1)}static decodeSeed(e){let t=ty._decode(e),r=ty._decodePrefix(t);if(r[0]!=ei.Seed)throw new tb(es.InvalidSeed);if(!t_.isValidPublicPrefix(r[1]))throw new tb(es.InvalidPrefixByte);return{buf:t.slice(2),prefix:r[1]}}static _encode(e,t,r){let s=e?2:1,i=r.byteLength,n=s+i,o=new Uint8Array(s+i+2);if(e){let e=ty._encodePrefix(ei.Seed,t);o.set(e)}else o[0]=t;o.set(r,s);let a=tp.checksum(o.slice(0,n));return new DataView(o.buffer).setUint16(n,a,!0),tg.encode(o)}static _decode(e){let t;if(e.byteLength<4)throw new tb(es.InvalidEncoding);try{t=tg.decode(e)}catch(e){throw new tb(es.InvalidEncoding,e)}let r=t.byteLength-2,s=new DataView(t.buffer).getUint16(r,!0),i=t.slice(0,r);if(!tp.validate(i,s))throw new tb(es.InvalidChecksum);return i}static _encodePrefix(e,t){return new Uint8Array([e|t>>5,(31&t)<<3])}static _decodePrefix(e){return new Uint8Array([248&e[0],(7&e[0])<<5|(248&e[1])>>3])}}i=td;let tw=h("PONG\r\n"),tS=h("PING\r\n");class tv{echo;no_responders;protocol;verbose;pedantic;jwt;nkey;sig;user;pass;auth_token;tls_required;name;lang;version;headers;constructor(e,t,r){this.protocol=1,this.version=e.version,this.lang=e.lang,this.echo=!t.noEcho&&void 0,this.verbose=t.verbose,this.pedantic=t.pedantic,this.tls_required=!!t.tls||void 0,this.name=t.name,S(this,(t&&"function"==typeof t.authenticator?t.authenticator(r):{})||{})}}class tE extends z{sid;queue;draining;max;subject;drained;protocol;timer;info;cleanupFn;closed;requestSubject;constructor(e,t,r={}){super(),S(this,r),this.protocol=e,this.subject=t,this.draining=!1,this.noIterator="function"==typeof r.callback,this.closed=x();let s=!e.options?.noAsyncTraces;r.timeout&&(this.timer=v(r.timeout,s),this.timer.then(()=>{this.timer=void 0}).catch(e=>{this.stop(e),this.noIterator&&this.callback(e,{})})),this.noIterator||this.iterClosed.then(()=>{this.closed.resolve(),this.unsubscribe()})}setPrePostHandlers(e){if(this.noIterator){let t=this.callback,r=e.ingestionFilterFn?e.ingestionFilterFn:()=>({ingest:!0,protocol:!1}),s=e.protocolFilterFn?e.protocolFilterFn:()=>!0,i=e.dispatchedFn?e.dispatchedFn:()=>{};this.callback=(e,n)=>{let{ingest:o}=r(n);o&&s(n)&&(t(e,n),i(n))}}else this.protocolFilterFn=e.protocolFilterFn,this.dispatchedFn=e.dispatchedFn}callback(e,t){this.cancelTimeout(),e?this.stop(e):this.push(t)}close(){if(!this.isClosed()){this.cancelTimeout();let e=()=>{if(this.stop(),this.cleanupFn)try{this.cleanupFn(this,this.info)}catch(e){}this.closed.resolve()};this.noIterator?e():this.push(e)}}unsubscribe(e){this.protocol.unsubscribe(this,e)}cancelTimeout(){this.timer&&(this.timer.cancel(),this.timer=void 0)}drain(){return this.protocol.isClosed()?Promise.reject(m.errorForCode(eg.ConnectionClosed)):this.isClosed()?Promise.reject(m.errorForCode(eg.SubClosed)):(this.drained||(this.draining=!0,this.protocol.unsub(this),this.drained=this.protocol.flush(x()).then(()=>{this.protocol.subscriptions.cancel(this)}).catch(()=>{this.protocol.subscriptions.cancel(this)})),this.drained)}isDraining(){return this.draining}isClosed(){return this.done}getSubject(){return this.subject}getMax(){return this.max}getID(){return this.sid}}class tx{mux;subs;sidCounter;constructor(){this.sidCounter=0,this.mux=null,this.subs=new Map}size(){return this.subs.size}add(e){return this.sidCounter++,e.sid=this.sidCounter,this.subs.set(e.sid,e),e}setMux(e){return this.mux=e,e}getMux(){return this.mux}get(e){return this.subs.get(e)}resub(e){return this.sidCounter++,this.subs.delete(e.sid),e.sid=this.sidCounter,this.subs.set(e.sid,e),e}all(){return Array.from(this.subs.values())}cancel(e){e&&(e.close(),this.subs.delete(e.sid))}handleError(e){if(e&&e.permissionContext){let t;let r=e.permissionContext,s=this.all();if("subscription"===r.operation&&(t=s.find(e=>e.subject===r.subject&&e.queue===r.queue)),"publish"===r.operation&&(t=s.find(e=>e.requestSubject===r.subject)),t)return t.callback(e,{}),t.close(),this.subs.delete(t.sid),t!==this.mux}return!1}close(){this.subs.forEach(e=>{e.close()})}}class tA{connected;connectedOnce;infoReceived;info;muxSubscriptions;options;outbound;pongs;subscriptions;transport;noMorePublishing;connectError;publisher;_closed;closed;listeners;heartbeats;parser;outMsgs;inMsgs;outBytes;inBytes;pendingLimit;lastError;abortReconnect;whyClosed;servers;server;features;connectPromise;constructor(e,t){this._closed=!1,this.connected=!1,this.connectedOnce=!1,this.infoReceived=!1,this.noMorePublishing=!1,this.abortReconnect=!1,this.listeners=[],this.pendingLimit=null,this.outMsgs=0,this.inMsgs=0,this.outBytes=0,this.inBytes=0,this.options=e,this.publisher=t,this.subscriptions=new tx,this.muxSubscriptions=new ti,this.outbound=new Z,this.pongs=[],this.whyClosed="",this.pendingLimit=e.pendingLimit||this.pendingLimit,this.features=new e1({major:0,minor:0,micro:0}),this.connectPromise=null;let r="string"==typeof e.servers?[e.servers]:e.servers;this.servers=new ts(r,{randomize:!e.noRandomize}),this.closed=x(),this.parser=new tu(this),this.heartbeats=new tn(this,this.options.pingInterval||null,this.options.maxPingOut||2)}resetOutbound(){this.outbound.reset();let e=this.pongs;this.pongs=[];let t=m.errorForCode(eg.Disconnect);t.stack="",e.forEach(e=>{e.reject(t)}),this.parser=new tu(this),this.infoReceived=!1}dispatchStatus(e){this.listeners.forEach(t=>{t.push(e)})}status(){let e=new z;return this.listeners.push(e),e}prepare(){this.transport&&this.transport.discard(),this.info=void 0,this.resetOutbound();let e=x();return e.catch(()=>{}),this.pongs.unshift(e),this.connectError=t=>{e.reject(t)},this.transport=function(){if(!s||"function"!=typeof s.factory)throw Error("transport fn is not set");return s.factory()}(),this.transport.closed().then(async e=>{if(this.connected=!1,!this.isClosed()){await this.disconnected(this.transport.closeError||this.lastError);return}}),e}disconnect(){this.dispatchStatus({type:em.StaleConnection,data:""}),this.transport.disconnect()}reconnect(){return this.connected&&(this.dispatchStatus({type:em.ClientInitiatedReconnect,data:""}),this.transport.disconnect()),Promise.resolve()}async disconnected(e){this.dispatchStatus({type:ep.Disconnect,data:this.servers.getCurrentServer().toString()}),this.options.reconnect?await this.dialLoop().then(()=>{this.dispatchStatus({type:ep.Reconnect,data:this.servers.getCurrentServer().toString()}),this.lastError?.code===eg.AuthenticationExpired&&(this.lastError=void 0)}).catch(e=>{this._close(e)}):await this._close(e)}async dial(e){let t;let r=this.prepare();try{t=v(this.options.timeout||2e4);let r=this.transport.connect(e,this.options);await Promise.race([r,t]),(async()=>{try{for await(let e of this.transport)this.parser.parse(e)}catch(e){console.log("reader closed",e)}})().then()}catch(e){r.reject(e)}try{await Promise.race([t,r]),t&&t.cancel(),this.connected=!0,this.connectError=void 0,this.sendSubscriptions(),this.connectedOnce=!0,this.server.didConnect=!0,this.server.reconnects=0,this.flushPending(),this.heartbeats.start()}catch(e){throw t&&t.cancel(),await this.transport.close(e),e}}async _doDial(e){let{resolve:t}=this.options,r=await e.resolve({fn:e8(),debug:this.options.debug,randomize:!this.options.noRandomize,resolve:t}),s=null;for(let e of r)try{s=null,this.dispatchStatus({type:em.Reconnecting,data:e.toString()}),await this.dial(e);return}catch(e){s=e}throw s}dialLoop(){return null===this.connectPromise&&(this.connectPromise=this.dodialLoop(),this.connectPromise.then(()=>{}).catch(()=>{}).finally(()=>{this.connectPromise=null})),this.connectPromise}async dodialLoop(){let e;for(;;){this._closed&&this.servers.clear();let t=this.options.reconnectDelayHandler?this.options.reconnectDelayHandler():null,r=t,s=this.selectServer();if(!s||this.abortReconnect){if(e)throw e;if(this.lastError)throw this.lastError;throw m.errorForCode(eg.ConnectionRefused)}let i=Date.now();if(0===s.lastConnect||s.lastConnect+t<=i){s.lastConnect=Date.now();try{await this._doDial(s);break}catch(r){if(e=r,!this.connectedOnce){if(this.options.waitOnFirstConnect)continue;this.servers.removeCurrentServer()}s.reconnects++;let t=this.options.maxReconnectAttempts||0;-1!==t&&s.reconnects>=t&&this.servers.removeCurrentServer()}}else r=Math.min(r,s.lastConnect+t-i),await E(r)}}static async connect(e,t){let r=new tA(e,t);return await r.dialLoop(),r}static toError(e){let t=e?e.toLowerCase():"";if(-1!==t.indexOf("permissions violation")){let t=new m(e,eg.PermissionsViolation),r=e.match(/(Publish|Subscription) to "(\S+)"/);if(r){t.permissionContext={operation:r[1].toLowerCase(),subject:r[2],queue:void 0};let s=e.match(/using queue "(\S+)"/);s&&(t.permissionContext.queue=s[1])}return t}return -1!==t.indexOf("authorization violation")?new m(e,eg.AuthorizationViolation):-1!==t.indexOf("user authentication expired")?new m(e,eg.AuthenticationExpired):-1!=t.indexOf("account authentication expired")?new m(e,eg.AccountExpired):-1!==t.indexOf("authentication timeout")?new m(e,eg.AuthenticationTimeout):new m(e,eg.ProtocolError)}processMsg(e,t){if(this.inMsgs++,this.inBytes+=t.length,!this.subscriptions.sidCounter)return;let r=this.subscriptions.get(e.sid);r&&(r.received+=1,r.callback&&r.callback(null,new $(e,t,this)),void 0!==r.max&&r.received>=r.max&&r.unsubscribe())}processError(e){let t=c(e),r=tA.toError(t),s={type:ep.Error,data:r.code};if(r.isPermissionError()){let e=!1;if(r.permissionContext){s.permissionContext=r.permissionContext;let t=this.subscriptions.getMux();e=t?.subject===r.permissionContext.subject}this.subscriptions.handleError(r),this.muxSubscriptions.handleError(e,r),e&&this.subscriptions.setMux(null)}this.dispatchStatus(s),this.handleError(r)}handleError(e){e.isAuthError()?this.handleAuthError(e):e.isProtocolError()?this.lastError=e:e.isAuthTimeout()&&(this.lastError=e),e.isPermissionError()||(this.lastError=e)}handleAuthError(e){this.lastError&&e.code===this.lastError.code&&!1===this.options.ignoreAuthErrorAbort&&(this.abortReconnect=!0),this.connectError?this.connectError(e):this.disconnect()}processPing(){this.transport.send(tw)}processPong(){let e=this.pongs.shift();e&&e.resolve()}processInfo(e){let t=JSON.parse(c(e));this.info=t;let r=this.options&&this.options.ignoreClusterUpdates?void 0:this.servers.update(t,this.transport.isEncrypted());if(!this.infoReceived){this.features.update(eQ(t.version)),this.infoReceived=!0,this.transport.isEncrypted()&&this.servers.updateTLSName();let{version:e,lang:r}=this.transport;try{let s=new tv({version:e,lang:r},this.options,t.nonce);t.headers&&(s.headers=!0,s.no_responders=!0);let i=JSON.stringify(s);this.transport.send(h(`CONNECT ${i}\r
`)),this.transport.send(tS)}catch(e){this._close(e)}}r&&this.dispatchStatus({type:ep.Update,data:r}),void 0!==t.ldm&&t.ldm&&this.dispatchStatus({type:ep.LDM,data:this.servers.getCurrentServer().toString()})}push(e){switch(e.kind){case ee.MSG:{let{msg:t,data:r}=e;this.processMsg(t,r);break}case ee.OK:break;case ee.ERR:this.processError(e.data);break;case ee.PING:this.processPing();break;case ee.PONG:this.processPong();break;case ee.INFO:this.processInfo(e.data)}}sendCommand(e,...t){let r;let s=this.outbound.length();r="string"==typeof e?h(e):e,this.outbound.fill(r,...t),0===s?queueMicrotask(()=>{this.flushPending()}):this.outbound.size()>=this.pendingLimit&&this.flushPending()}publish(e,t=n,r){let s,i;if(t instanceof Uint8Array)s=t;else if("string"==typeof t)s=o.encode(t);else throw m.errorForCode(eg.BadPayload);let a=s.length;(r=r||{}).reply=r.reply||"";let h=n,c=0;if(r.headers){if(this.info&&!this.info.headers)throw new m("headers",eg.ServerOptionNotAvailable);c=(h=r.headers.encode()).length,a=s.length+c}if(this.info&&a>this.info.max_payload)throw m.errorForCode(eg.MaxPayloadExceeded);this.outBytes+=a,this.outMsgs++,r.headers?(i=r.reply?`HPUB ${e} ${r.reply} ${c} ${a}\r
`:`HPUB ${e} ${c} ${a}\r
`,this.sendCommand(i,h,s,e7)):(i=r.reply?`PUB ${e} ${r.reply} ${a}\r
`:`PUB ${e} ${a}\r
`,this.sendCommand(i,s,e7))}request(e){return this.initMux(),this.muxSubscriptions.add(e),e}subscribe(e){return this.subscriptions.add(e),this._subunsub(e),e}_sub(e){e.queue?this.sendCommand(`SUB ${e.subject} ${e.queue} ${e.sid}\r
`):this.sendCommand(`SUB ${e.subject} ${e.sid}\r
`)}_subunsub(e){return this._sub(e),e.max&&this.unsubscribe(e,e.max),e}unsubscribe(e,t){this.unsub(e,t),(void 0===e.max||e.received>=e.max)&&this.subscriptions.cancel(e)}unsub(e,t){!e||this.isClosed()||(t?this.sendCommand(`UNSUB ${e.sid} ${t}\r
`):this.sendCommand(`UNSUB ${e.sid}\r
`),e.max=t)}resub(e,t){!e||this.isClosed()||(this.unsub(e),e.subject=t,this.subscriptions.resub(e),this._sub(e))}flush(e){return e||(e=x()),this.pongs.push(e),this.outbound.fill(tS),this.flushPending(),e}sendSubscriptions(){let e=[];this.subscriptions.all().forEach(t=>{t.queue?e.push(`SUB ${t.subject} ${t.queue} ${t.sid}\r
`):e.push(`SUB ${t.subject} ${t.sid}\r
`)}),e.length&&this.transport.send(h(e.join("")))}async _close(e){this._closed||(this.whyClosed=Error("close trace").stack||"",this.heartbeats.cancel(),this.connectError&&(this.connectError(e),this.connectError=void 0),this.muxSubscriptions.close(),this.subscriptions.close(),this.listeners.forEach(e=>{e.stop()}),this._closed=!0,await this.transport.close(e),await this.closed.resolve(e))}close(){return this._close()}isClosed(){return this._closed}drain(){let e=this.subscriptions.all(),t=[];return e.forEach(e=>{t.push(e.drain())}),Promise.all(t).then(async()=>(this.noMorePublishing=!0,await this.flush(),this.close())).catch(()=>{})}flushPending(){if(this.infoReceived&&this.connected&&this.outbound.size()){let e=this.outbound.drain();this.transport.send(e)}}initMux(){if(!this.subscriptions.getMux()){let e=this.muxSubscriptions.init(this.options.inboxPrefix),t=new tE(this,`${e}*`);t.callback=this.muxSubscriptions.dispatcher(),this.subscriptions.setMux(t),this.subscribe(t)}}selectServer(){let e=this.servers.selectServer();if(void 0!==e)return this.server=e,this.server}getServer(){return this.server}}class tP{msg;constructor(e){this.msg=e}get data(){return this.msg.data}get sid(){return this.msg.sid}get subject(){return this.msg.subject}get reply(){return this.msg.reply||""}get headers(){return this.msg.headers}respond(e,t){return this.msg.respond(e,t)}respondError(e,t,r,s){return(s=s||{}).headers=s.headers||j(),s.headers?.set(b,`${e}`),s.headers?.set(g,t),this.msg.respond(r,s)}json(e){return this.msg.json(e)}string(){return this.msg.string()}}class tO{subject;queue;srv;constructor(e,t="",r=""){""!==t&&function(e,t){if(-1!==t.indexOf(" "))throw Error(`${e} cannot contain spaces: '${t}'`);t.split(".").forEach(r=>{if(">"===r)throw Error(`${e} name cannot contain internal '>': '${t}'`)})}("service group",t);let s="";if(e instanceof tk)this.srv=e,s="";else if(e instanceof tO)this.srv=e.srv,""===r&&""!==e.queue&&(r=e.queue),s=e.subject;else throw Error("unknown ServiceGroup type");this.subject=this.calcSubject(s,t),this.queue=r}calcSubject(e,t=""){return""===t?e:""!==e?`${e}.${t}`:t}addEndpoint(e="",t){let r="function"==typeof(t=t||{subject:e})?{handler:t,subject:e}:t;L("endpoint",e);let{subject:s,handler:i,metadata:n,queue:o}=r;s=s||e,o=o||this.queue,function(e,t){if(""===t)throw Error(`${e} cannot be empty`);if(-1!==t.indexOf(" "))throw Error(`${e} cannot contain spaces: '${t}'`);let r=t.split(".");r.forEach((s,i)=>{if(">"===s&&i!==r.length-1)throw Error(`${e} cannot have internal '>': '${t}'`)})}("endpoint subject",s);let a={name:e,subject:s=this.calcSubject(this.subject,s),queue:o,handler:i,metadata:n};return this.srv._addEndpoint(a)}addGroup(e="",t=""){return new tO(this,e,t)}}class tk{nc;_id;config;handlers;internal;_stopped;_done;started;static controlSubject(e,t="",r="",s){let i=s??"$SRV";return""===t&&""===r?`${i}.${e}`:(L("control subject name",t),""!==r)?(L("control subject id",r),`${i}.${e}.${t}.${r}`):`${i}.${e}.${t}`}constructor(e,t={name:"",version:""}){this.nc=e,this.config=Object.assign({},t),this.config.queue||(this.config.queue="q"),L("name",this.config.name),L("queue",this.config.queue),eQ(this.config.version),this._id=d.next(),this.internal=[],this._done=x(),this._stopped=!1,this.handlers=[],this.started=new Date().toISOString(),this.reset(),this.nc.closed().then(()=>{this.close().catch()}).catch(e=>{this.close(e).catch()})}get subjects(){return this.handlers.filter(e=>!1===e.internal).map(e=>e.subject)}get id(){return this._id}get name(){return this.config.name}get description(){return this.config.description??""}get version(){return this.config.version}get metadata(){return this.config.metadata}errorToHeader(e){let t=j();return e instanceof _?(t.set(g,e.message),t.set(b,`${e.code}`)):(t.set(g,e.message),t.set(b,"500")),t}setupHandler(e,t=!1){let r=t?"":e.queue?e.queue:this.config.queue,{name:s,subject:i,handler:o}=e;e.internal=t,t&&this.internal.push(e),e.stats=new tC(s,i,r),e.queue=r;let a=o?(t,r)=>{if(t){this.close(t);return}let s=Date.now();try{o(t,new tP(r))}catch(t){e.stats.countError(t),r?.respond(n,{headers:this.errorToHeader(t)})}finally{e.stats.countLatency(s)}}:void 0;return e.sub=this.nc.subscribe(i,{callback:a,queue:r}),e.sub.closed.then(()=>{this._stopped||this.close(Error(`required subscription ${e.subject} stopped`)).catch()}).catch(t=>{if(!this._stopped){let r=Error(`required subscription ${e.subject} errored: ${t.message}`);r.stack=t.stack,this.close(r).catch()}}),e}info(){return{type:ey.INFO,name:this.name,id:this.id,version:this.version,description:this.description,metadata:this.metadata,endpoints:this.endpoints()}}endpoints(){return this.handlers.map(e=>{let{subject:t,metadata:r,name:s,queue:i}=e;return{subject:t,metadata:r,name:s,queue_group:i}})}async stats(){let e=[];for(let t of this.handlers){if("function"==typeof this.config.statsHandler)try{t.stats.data=await this.config.statsHandler(t)}catch(e){t.stats.countError(e)}e.push(t.stats.stats(t.qi))}return{type:ey.STATS,name:this.name,id:this.id,version:this.version,started:this.started,metadata:this.metadata,endpoints:e}}addInternalHandler(e,t){let r=`${e}`.toUpperCase();this._doAddInternalHandler(`${r}-all`,e,t),this._doAddInternalHandler(`${r}-kind`,e,t,this.name),this._doAddInternalHandler(`${r}`,e,t,this.name,this.id)}_doAddInternalHandler(e,t,r,s="",i=""){let n={};n.name=e,n.subject=tk.controlSubject(t,s,i),n.handler=r,this.setupHandler(n,!0)}start(){let e=R(),t=e.encode(this.ping());return this.addInternalHandler(ew.PING,(e,r)=>e?(this.close(e).then().catch(),Promise.reject(e)):(r.respond(t),Promise.resolve())),this.addInternalHandler(ew.STATS,(t,r)=>t?(this.close(t),Promise.reject(t)):this.stats().then(t=>(r?.respond(e.encode(t)),Promise.resolve()))),this.addInternalHandler(ew.INFO,(t,r)=>t?(this.close(t),Promise.reject(t)):(r?.respond(e.encode(this.info())),Promise.resolve())),this.handlers.forEach(e=>{let{subject:t}=e;"string"==typeof t&&null!==e.handler&&this.setupHandler(e)}),Promise.resolve(this)}close(e){if(this._stopped)return this._done;this._stopped=!0;let t=[];return this.nc.isClosed()||(t=this.handlers.concat(this.internal).map(e=>e.sub.drain())),Promise.allSettled(t).then(()=>{this._done.resolve(e||null)}),this._done}get stopped(){return this._done}get isStopped(){return this._stopped}stop(e){return this.close(e)}ping(){return{type:ey.PING,name:this.name,id:this.id,version:this.version,metadata:this.metadata}}reset(){if(this.started=new Date().toISOString(),this.handlers)for(let e of this.handlers)e.stats.reset(e.qi)}addGroup(e,t){return new tO(this,e,t)}addEndpoint(e,t){return new tO(this).addEndpoint(e,t)}_addEndpoint(e){let t=new z;t.noIterator="function"==typeof e.handler,t.noIterator||(e.handler=(e,r)=>{e?this.stop(e).catch():t.push(new tP(r))},t.iterClosed.then(()=>{this.close().catch()}));let r=this.setupHandler(e,!1);return r.qi=t,this.handlers.push(r),t}}class tC{name;subject;average_processing_time;num_requests;processing_time;num_errors;last_error;data;metadata;queue;constructor(e,t,r=""){this.name=e,this.subject=t,this.average_processing_time=0,this.num_errors=0,this.num_requests=0,this.processing_time=0,this.queue=r}reset(e){this.num_requests=0,this.processing_time=0,this.average_processing_time=0,this.num_errors=0,this.last_error=void 0,this.data=void 0,e&&(e.time=0,e.processed=0)}countLatency(e){this.num_requests++,this.processing_time+=O(Date.now()-e),this.average_processing_time=Math.round(this.processing_time/this.num_requests)}countError(e){this.num_errors++,this.last_error=e.message}_stats(){let{name:e,subject:t,average_processing_time:r,num_errors:s,num_requests:i,processing_time:n,last_error:o,data:a,queue:h}=this;return{name:e,subject:t,average_processing_time:r,num_errors:s,num_requests:i,processing_time:n,last_error:o,data:a,queue_group:h}}stats(e){return e?.noIterator===!1&&(this.processing_time=O(e.time),this.num_requests=e.processed,this.average_processing_time=this.processing_time>0&&this.num_requests>0?this.processing_time/this.num_requests:0),this._stats()}}class tj{nc;prefix;opts;constructor(e,t={strategy:e_.JitterTimer,maxWait:2e3},r){this.nc=e,this.prefix=r,this.opts=t}ping(e="",t=""){return this.q(ew.PING,e,t)}stats(e="",t=""){return this.q(ew.STATS,e,t)}info(e="",t=""){return this.q(ew.INFO,e,t)}async q(e,t="",r=""){let s=new z,i=R(),o=tk.controlSubject(e,t,r,this.prefix),a=await this.nc.requestMany(o,n,this.opts);return(async()=>{for await(let e of a)try{let t=i.decode(e.data);s.push(t)}catch(e){s.push(()=>{s.stop(e)})}s.push(()=>{s.stop()})})().catch(e=>{s.stop(e)}),s}}function tI(){return{key:{encode:e=>e,decode:e=>e},value:{encode:e=>e,decode:e=>e}}}let tN="KV-Operation",tM=/^[-/=.\w]+$/,tR=/^[-/=.>*\w]+$/,tT=/^[-\w]+$/;function t$(e){if(e.startsWith(".")||e.endsWith(".")||!tM.test(e))throw Error(`invalid key: ${e}`)}function tU(e){if(e.startsWith(".")||e.endsWith(".")||!tR.test(e))throw Error(`invalid key: ${e}`)}function tq(e){if(e.startsWith(".")||e.endsWith("."))throw Error(`invalid key: ${e}`);let t=e.split("."),r=!1;for(let s=0;s<t.length;s++)switch(t[s]){case"*":r=!0;break;case">":if(s!==t.length-1)throw Error(`invalid key: ${e}`);r=!0}return r}function tF(e){if(!tT.test(e))throw Error(`invalid bucket name: ${e}`)}!function(e){e.MsgIdHdr="Nats-Msg-Id",e.ExpectedStreamHdr="Nats-Expected-Stream",e.ExpectedLastSeqHdr="Nats-Expected-Last-Sequence",e.ExpectedLastMsgIdHdr="Nats-Expected-Last-Msg-Id",e.ExpectedLastSubjectSequenceHdr="Nats-Expected-Last-Subject-Sequence"}(en||(en={}));class tL{js;jsm;stream;bucket;direct;codec;prefix;editPrefix;useJsPrefix;_prefixLen;constructor(e,t,r){tF(e),this.js=t,this.jsm=r,this.bucket=e,this.prefix="$KV",this.editPrefix="",this.useJsPrefix=!1,this._prefixLen=0}static async create(e,t,r={}){tF(t);let s=await e.jetstreamManager(),i=new tL(t,e,s);return await i.init(r),i}static async bind(e,t,r={}){let s=await e.jetstreamManager(),i={config:{allow_direct:r.allow_direct}};tF(t);let n=new tL(t,e,s);return i.config.name=r.streamName??n.bucketName(),Object.assign(n,i),n.stream=i.config.name,n.codec=r.codec||tI(),n.direct=i.config.allow_direct??!1,n.initializePrefixes(i),n}async init(e={}){let t;let r=Object.assign({replicas:1,history:1,timeout:2e3,max_bytes:-1,maxValueSize:-1,codec:tI(),storage:ex.File},e);this.codec=r.codec;let s={};this.stream=s.name=e.streamName??this.bucketName(),s.retention=ev.Limits,s.max_msgs_per_subject=r.history,r.maxBucketSize&&(r.max_bytes=r.maxBucketSize),r.max_bytes&&(s.max_bytes=r.max_bytes),s.max_msg_size=r.maxValueSize,s.storage=r.storage;let i=e.placementCluster??"";if(i&&(e.placement={},e.placement.cluster=i,e.placement.tags=[]),e.placement&&(s.placement=e.placement),e.republish&&(s.republish=e.republish),e.description&&(s.description=e.description),e.mirror){let t=Object.assign({},e.mirror);t.name.startsWith("KV_")||(t.name=`KV_${t.name}`),s.mirror=t,s.mirror_direct=!0}else if(e.sources){let t=e.sources.map(e=>{let t=Object.assign({},e),r=t.name.startsWith("KV_")?t.name.substring(3):t.name;return t.name.startsWith("KV_")||(t.name=`KV_${t.name}`),e.external||r===this.bucket||(t.subject_transforms=[{src:`$KV.${r}.>`,dest:`$KV.${this.bucket}.>`}]),t});s.sources=t,s.subjects=[this.subjectForBucket()]}else s.subjects=[this.subjectForBucket()];e.metadata&&(s.metadata=e.metadata),"boolean"==typeof e.compression&&(s.compression=e.compression?ek.S2:ek.None);let n=this.js.nc,o=n.getServerVersion(),a=!!o&&e0(o,eQ("2.7.2"))>=0;s.discard=a?eE.New:eE.Old;let{ok:h,min:c}=n.features.get(Q.JS_ALLOW_DIRECT);if(!h&&!0===e.allow_direct){let e=o?`${o.major}.${o.minor}.${o.micro}`:"unknown";return Promise.reject(Error(`allow_direct is not available on server version ${e} - requires ${c}`))}e.allow_direct="boolean"==typeof e.allow_direct?e.allow_direct:h,s.allow_direct=e.allow_direct,this.direct=s.allow_direct,s.num_replicas=r.replicas,r.ttl&&(s.max_age=O(r.ttl)),s.allow_rollup_hdrs=!0;try{(t=await this.jsm.streams.info(s.name)).config.allow_direct||!0!==this.direct||(this.direct=!1)}catch(e){if("stream not found"===e.message)t=await this.jsm.streams.add(s);else throw e}this.initializePrefixes(t)}initializePrefixes(e){this._prefixLen=0,this.prefix=`$KV.${this.bucket}`,this.useJsPrefix="$JS.API"!==this.js.apiPrefix;let{mirror:t}=e.config;if(t){let e=t.name;if(e.startsWith("KV_")&&(e=e.substring(3)),t.external&&""!==t.external.api){let r=t.name.substring(3);this.useJsPrefix=!1,this.prefix=`$KV.${r}`,this.editPrefix=`${t.external.api}.$KV.${e}`}else this.editPrefix=this.prefix}}bucketName(){return this.stream??`KV_${this.bucket}`}subjectForBucket(){return`${this.prefix}.${this.bucket}.>`}subjectForKey(e,t=!1){let r=[];return t?(this.useJsPrefix&&r.push(this.js.apiPrefix),""!==this.editPrefix?r.push(this.editPrefix):r.push(this.prefix)):this.prefix&&r.push(this.prefix),r.push(e),r.join(".")}fullKeyName(e){return""!==this.prefix?`${this.prefix}.${e}`:`$KV.${this.bucket}.${e}`}get prefixLen(){return 0===this._prefixLen&&(this._prefixLen=this.prefix.length+1),this._prefixLen}encodeKey(e){let t=[];for(let r of e.split("."))switch(r){case">":case"*":t.push(r);break;default:t.push(this.codec.key.encode(r))}return t.join(".")}decodeKey(e){let t=[];for(let r of e.split("."))switch(r){case">":case"*":t.push(r);break;default:t.push(this.codec.key.decode(r))}return t.join(".")}validateKey=t$;validateSearchKey=tU;hasWildcards=tq;close(){return Promise.resolve()}dataLen(e,t){let r=t&&t.get(eI.MessageSizeHdr)||"";return""!==r?parseInt(r,10):e.length}smToEntry(e){return new rh(this.bucket,this.prefixLen,e)}jmToEntry(e){let t=this.decodeKey(e.subject.substring(this.prefixLen));return new rc(this.bucket,t,e)}async create(e,t){let r;try{let r=await this.put(e,t,{previousSeq:0});return Promise.resolve(r)}catch(e){if(r=e,e?.api_error?.err_code!==10071)return Promise.reject(e)}let s=0;try{let i=await this.get(e);if(i?.operation==="DEL"||i?.operation==="PURGE")return s=null!==i?i.revision:0,this.update(e,t,s);return Promise.reject(r)}catch(e){return Promise.reject(e)}}update(e,t,r){if(r<=0)throw Error("version must be greater than 0");return this.put(e,t,{previousSeq:r})}async put(e,t,r={}){let s=this.encodeKey(e);this.validateKey(s);let i={};if(void 0!==r.previousSeq){let e=j();i.headers=e,e.set(en.ExpectedLastSubjectSequenceHdr,`${r.previousSeq}`)}try{return(await this.js.publish(this.subjectForKey(s,!0),t,i)).seq}catch(e){if(e.isJetStreamError())return e.message=e.api_error?.description,e.code=`${e.api_error?.code}`,Promise.reject(e);return Promise.reject(e)}}async get(e,t){let r;let s=this.encodeKey(e);this.validateKey(s);let i={last_by_subj:this.subjectForKey(s)};t&&t.revision>0&&(i={seq:t.revision});try{if(this.direct){let e=this.jsm.direct;r=await e.getMessage(this.bucketName(),i)}else r=await this.jsm.streams.getMessage(this.bucketName(),i);let e=this.smToEntry(r);if(e.key!==s)return null;return e}catch(e){if(e.code===eg.JetStream404NoMessages)return null;throw e}}purge(e,t){return this._deleteOrPurge(e,"PURGE",t)}delete(e,t){return this._deleteOrPurge(e,"DEL",t)}async purgeDeletes(e=18e5){let t=x(),r=[],s=await this.watch({key:">",initializedFn:()=>{t.resolve()}});(async()=>{for await(let e of s)("DEL"===e.operation||"PURGE"===e.operation)&&r.push(e)})().then(),await t,s.stop();let i=Date.now()-e,n=r.map(e=>{let t=this.subjectForKey(e.key);return e.created.getTime()>=i?this.jsm.streams.purge(this.stream,{filter:t,keep:1}):this.jsm.streams.purge(this.stream,{filter:t,keep:0})}),o=await Promise.all(n);return o.unshift({success:!0,purged:0}),o.reduce((e,t)=>(e.purged+=t.purged,e))}async _deleteOrPurge(e,t,r){if(!this.hasWildcards(e))return this._doDeleteOrPurge(e,t,r);let s=await this.keys(e),i=[];for await(let e of s)i.push(this._doDeleteOrPurge(e,t)),100===i.length&&(await Promise.all(i),i.length=0);i.length>0&&await Promise.all(i)}async _doDeleteOrPurge(e,t,r){let s=this.encodeKey(e);this.validateKey(s);let i=j();i.set(tN,t),"PURGE"===t&&i.set(eI.RollupHdr,eI.RollupValueSubject),r?.previousSeq&&i.set(en.ExpectedLastSubjectSequenceHdr,`${r.previousSeq}`),await this.js.publish(this.subjectForKey(s,!0),n,{headers:i})}_buildCC(e,t,r={}){let s,i=(Array.isArray(e)?e:[e]).map(e=>{let t=this.encodeKey(e);return this.validateSearchKey(e),this.fullKeyName(t)}),n=eA.LastPerSubject;return t===eN.AllHistory&&(n=eA.All),t===eN.UpdatesOnly&&(n=eA.New),1===i.length&&(s=i[0],i=void 0),Object.assign({deliver_policy:n,ack_policy:eP.None,filter_subjects:i,filter_subject:s,flow_control:!0,idle_heartbeat:O(5e3)},r)}remove(e){return this.purge(e)}async history(e={}){let t;let r=e.key??">",s=new z,i={};i.headers_only=e.headers_only||!1,t=()=>{s.stop()};let n=0,o=this._buildCC(r,eN.AllHistory,i),a=o.filter_subject,h=V(o);h.bindStream(this.stream),h.orderedConsumer(),h.callback((e,r)=>{if(e){s.stop(e);return}if(r){let e=this.jmToEntry(r);s.push(e),s.received++,(t&&n>0&&s.received>=n||0===r.info.pending)&&(s.push(t),t=void 0)}});let c=await this.js.subscribe(a,h);if(t){let{info:{last:e}}=c,r=e.num_pending+e.delivered.consumer_seq;if(0===r||s.received>=r)try{t()}catch(e){s.stop(e)}finally{t=void 0}else n=r}return s._data=c,s.iterClosed.then(()=>{c.unsubscribe()}),c.closed.then(()=>{s.stop()}).catch(e=>{s.stop(e)}),s}canSetWatcherName(){let{ok:e}=this.js.nc.features.get(Q.JS_NEW_CONSUMER_CREATE_API);return e}async watch(e={}){let t=e.key??">",r=new z,s={};s.headers_only=e.headers_only||!1;let i=eN.LastValue;e.include===eN.AllHistory?i=eN.AllHistory:e.include===eN.UpdatesOnly&&(i=eN.UpdatesOnly);let n=!0===e.ignoreDeletes,o=e.initializedFn,a=0,h=this._buildCC(t,i,s),c=h.filter_subject,u=V(h);this.canSetWatcherName()&&u.consumerName(d.next()),u.bindStream(this.stream),e.resumeFromRevision&&e.resumeFromRevision>0&&u.startSequence(e.resumeFromRevision),u.orderedConsumer(),u.callback((e,t)=>{if(e){r.stop(e);return}if(t){let e=this.jmToEntry(t);if(n&&"DEL"===e.operation)return;r.push(e),r.received++,o&&(a>0&&r.received>=a||0===t.info.pending)&&(r.push(o),o=void 0)}});let l=await this.js.subscribe(c,u);if(o){let{info:{last:e}}=l,t=e.num_pending+e.delivered.consumer_seq;if(0===t||r.received>=t)try{o()}catch(e){r.stop(e)}finally{o=void 0}else a=t}return r._data=l,r.iterClosed.then(()=>{l.unsubscribe()}),l.closed.then(()=>{r.stop()}).catch(e=>{r.stop(e)}),r}async keys(e=">"){let t=new z,r=this._buildCC(e,eN.LastValue,{headers_only:!0}),s=Array.isArray(e)?">":r.filter_subject,i=V(r);i.bindStream(this.stream),i.orderedConsumer();let n=await this.js.subscribe(s,i);return(async()=>{for await(let e of n){let r=e.headers?.get(tN);if("DEL"!==r&&"PURGE"!==r){let r=this.decodeKey(e.subject.substring(this.prefixLen));t.push(r)}0===e.info.pending&&n.unsubscribe()}})().then(()=>{t.stop()}).catch(e=>{t.stop(e)}),0===n.info.last.num_pending&&n.unsubscribe(),t}purgeBucket(e){return this.jsm.streams.purge(this.bucketName(),e)}destroy(){return this.jsm.streams.delete(this.bucketName())}async status(){let e=this.js.nc,t=e.info?.cluster??"",r=this.bucketName();return new tB(await this.jsm.streams.info(r),t)}}class tB{si;cluster;constructor(e,t=""){this.si=e,this.cluster=t}get bucket(){return this.si.config.name.startsWith("KV_")?this.si.config.name.substring(3):this.si.config.name}get values(){return this.si.state.messages}get history(){return this.si.config.max_msgs_per_subject}get ttl(){return k(this.si.config.max_age)}get bucket_location(){return this.cluster}get backingStore(){return this.si.config.storage}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get description(){return this.si.config.description??""}get maxBucketSize(){return this.si.config.max_bytes}get maxValueSize(){return this.si.config.max_msg_size}get max_bytes(){return this.si.config.max_bytes}get placement(){return this.si.config.placement||{cluster:"",tags:[]}}get placementCluster(){return this.si.config.placement?.cluster??""}get republish(){return this.si.config.republish??{src:"",dest:""}}get streamInfo(){return this.si}get size(){return this.si.state.bytes}get metadata(){return this.si.config.metadata??{}}get compression(){return!!this.si.config.compression&&this.si.config.compression!==ek.None}}let tD="OBJ_",tH="SHA-256=";class tJ{si;backingStore;constructor(e){this.si=e,this.backingStore="JetStream"}get bucket(){var e;return(e=this.si.config.name).startsWith(tD)?e.substring(4):e}get description(){return this.si.config.description??""}get ttl(){return this.si.config.max_age}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get sealed(){return this.si.config.sealed}get size(){return this.si.state.bytes}get streamInfo(){return this.si}get metadata(){return this.si.config.metadata}get compression(){return!!this.si.config.compression&&this.si.config.compression!==ek.None}}function tz(e){if(void 0===e)return;let{domain:t}=e;if(void 0===t)return e;let r=Object.assign({},e);if(delete r.domain,""===t)return r;if(r.external)throw Error("domain and external are both set");return r.external={api:`$JS.${t}.API`},r}(function(e){e[e.Unset=-1]="Unset",e[e.Consume=0]="Consume",e[e.Fetch=1]="Fetch"})(eo||(eo={})),function(e){e.HeartbeatsMissed="heartbeats_missed",e.ConsumerNotFound="consumer_not_found",e.StreamNotFound="stream_not_found",e.ConsumerDeleted="consumer_deleted",e.OrderedConsumerRecreated="ordered_consumer_recreated",e.NoResponders="no_responders"}(ea||(ea={})),function(e){e.DebugEvent="debug",e.Discard="discard",e.Reset="reset",e.Next="next"}(eh||(eh={}));let tG=Uint8Array.of(43,65,67,75),tK=Uint8Array.of(45,78,65,75),tV=Uint8Array.of(43,87,80,73),tW=Uint8Array.of(43,78,88,84),tY=Uint8Array.of(43,84,69,82,77),tX=Uint8Array.of(32);function tZ(e,t=5e3){return new rp(e,t)}class tQ extends z{consumer;opts;sub;monitor;pending;inbox;refilling;pong;callback;timeout;cleanupHandler;listeners;statusIterator;forOrderedConsumer;resetHandler;abortOnMissingResource;bind;inBackOff;constructor(e,t,r=!1){super(),this.consumer=e,this.opts=this.parseOptions(t,r),this.callback=t.callback||null,this.noIterator="function"==typeof this.callback,this.monitor=null,this.pong=null,this.pending={msgs:0,bytes:0,requests:0},this.refilling=r,this.timeout=null,this.inbox=y(e.api.nc.options.inboxPrefix),this.listeners=[],this.forOrderedConsumer=!1,this.abortOnMissingResource=!0===t.abort_on_missing_resource,this.bind=!0===t.bind,this.inBackOff=!1,this.start()}start(){let{max_messages:e,max_bytes:t,idle_heartbeat:r,threshold_bytes:s,threshold_messages:i}=this.opts;this.closed().then(e=>{if(this.cleanupHandler)try{this.cleanupHandler(e)}catch(e){}});let{sub:n}=this;n&&n.unsubscribe(),this.sub=this.consumer.api.nc.subscribe(this.inbox,{callback:(r,n)=>{if(r){this.stop(r);return}if(this.monitor?.work(),n.subject===this.inbox){if(D(n))return;let e=n.headers?.code,t=n.headers?.description?.toLowerCase()||"unknown",{msgsLeft:r,bytesLeft:s}=this.parseDiscard(n.headers);if(r>0||s>0)this.pending.msgs-=r,this.pending.bytes-=s,this.pending.requests--,this.notify(eh.Discard,{msgsLeft:r,bytesLeft:s});else{if(400===e){this.stop(new m(t,`${e}`));return}if(409===e&&"consumer deleted"===t){if(this.notify(ea.ConsumerDeleted,`${e} ${t}`),!this.refilling||this.abortOnMissingResource){let r=new m(t,`${e}`);this.stop(r);return}}else if(503===e){if(this.notify(ea.NoResponders,`${e} No Responders`),!this.refilling||this.abortOnMissingResource){let t=new m("no responders",`${e}`);this.stop(t);return}}else this.notify(eh.DebugEvent,`${e} ${t}`)}}else this._push(tZ(n,this.consumer.api.timeout)),this.received++,this.pending.msgs&&this.pending.msgs--,this.pending.bytes&&(this.pending.bytes-=n.size());if(0===this.pending.msgs&&0===this.pending.bytes&&(this.pending.requests=0),this.refilling){if(e&&this.pending.msgs<=i||t&&this.pending.bytes<=s){let e=this.pullOptions();this.pull(e)}}else 0===this.pending.requests&&this._push(()=>{this.stop()})}}),this.sub.closed.then(()=>{this.sub.draining&&this._push(()=>{this.stop()})}),r&&(this.monitor=new G(r,e=>(this.notify(ea.HeartbeatsMissed,e),this.resetPending().then(()=>{}).catch(()=>{}),!1),{maxOut:2})),(async()=>{let e=this.consumer.api.nc.status();for await(let t of(this.statusIterator=e,e))switch(t.type){case ep.Disconnect:this.monitor?.cancel();break;case ep.Reconnect:this.resetPending().then(e=>{e&&this.monitor?.restart()}).catch(()=>{})}})(),this.pull(this.pullOptions())}_push(e){if(this.callback){let t="function"==typeof e?e:null;try{t?t():this.callback(e)}catch(e){this.stop(e)}}else super.push(e)}notify(e,t){this.listeners.length>0&&(()=>{this.listeners.forEach(r=>{r.done||r.push({type:e,data:t})})})()}resetPending(){return this.bind?this.resetPendingNoInfo():this.resetPendingWithInfo()}resetPendingNoInfo(){return this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),Promise.resolve(!0)}async resetPendingWithInfo(){if(this.inBackOff)return!1;let e=0,t=0,r=P([this.opts.expires]),s=0;for(;;){if(this.done)return!1;if(this.consumer.api.nc.isClosed())return console.error("aborting resetPending - connection is closed"),!1;try{return await this.consumer.info(),this.inBackOff=!1,e=0,this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),!0}catch(n){if("stream not found"===n.message){if(t++,this.notify(ea.StreamNotFound,t),!this.refilling||this.abortOnMissingResource)return this.stop(n),!1}else if("consumer not found"===n.message){if(e++,this.notify(ea.ConsumerNotFound,e),this.resetHandler)try{this.resetHandler()}catch(e){}if(!this.refilling||this.abortOnMissingResource)return this.stop(n),!1;if(this.forOrderedConsumer)return!1}else e=0,t=0;this.inBackOff=!0;let i=E(r.backoff(s));await Promise.race([i,this.consumer.api.nc.closed()]),i.cancel(),s++}}}pull(e){this.pending.bytes+=e.max_bytes??0,this.pending.msgs+=e.batch??0,this.pending.requests++;let t=this.consumer.api.nc;this._push(()=>{t.publish(`${this.consumer.api.prefix}.CONSUMER.MSG.NEXT.${this.consumer.stream}.${this.consumer.name}`,this.consumer.api.jc.encode(e),{reply:this.inbox}),this.notify(eh.Next,e)})}pullOptions(){let e=this.opts.max_messages-this.pending.msgs;return{batch:e,max_bytes:this.opts.max_bytes-this.pending.bytes,idle_heartbeat:O(this.opts.idle_heartbeat),expires:O(this.opts.expires)}}parseDiscard(e){let t={msgsLeft:0,bytesLeft:0},r=e?.get(eI.PendingMessagesHdr);r&&(t.msgsLeft=parseInt(r));let s=e?.get(eI.PendingBytesHdr);return s&&(t.bytesLeft=parseInt(s)),t}trackTimeout(e){this.timeout=e}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}clearTimers(){this.monitor?.cancel(),this.monitor=null,this.timeout?.cancel(),this.timeout=null}setCleanupHandler(e){this.cleanupHandler=e}stop(e){this.done||(this.sub?.unsubscribe(),this.clearTimers(),this.statusIterator?.stop(),this._push(()=>{super.stop(e),this.listeners.forEach(e=>{e.stop()})}))}parseOptions(e,t=!1){let r=e||{};if(r.max_messages=r.max_messages||0,r.max_bytes=r.max_bytes||0,0!==r.max_messages&&0!==r.max_bytes)throw Error("only specify one of max_messages or max_bytes");if(0===r.max_messages&&(r.max_messages=100),r.expires=r.expires||3e4,r.expires<1e3)throw Error("expires should be at least 1000ms");if(r.idle_heartbeat=r.idle_heartbeat||r.expires/2,r.idle_heartbeat=r.idle_heartbeat>3e4?3e4:r.idle_heartbeat,t){let e=Math.round(.75*r.max_messages)||1;r.threshold_messages=r.threshold_messages||e;let t=Math.round(.75*r.max_bytes)||1;r.threshold_bytes=r.threshold_bytes||t}return r}status(){let e=new z;return this.listeners.push(e),Promise.resolve(e)}}class t0 extends z{src;listeners;constructor(){super(),this.listeners=[]}setSource(e){this.src&&(this.src.resetHandler=void 0,this.src.setCleanupHandler(),this.src.stop()),this.src=e,this.src.setCleanupHandler(e=>{this.stop(e||void 0)}),(async()=>{for await(let e of(await this.src.status()))this.notify(e.type,e.data)})().catch(()=>{})}notify(e,t){this.listeners.length>0&&(()=>{this.listeners.forEach(r=>{r.done||r.push({type:e,data:t})})})()}stop(e){this.done||(this.src?.stop(e),super.stop(e),this.listeners.forEach(e=>{e.stop()}))}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}status(){let e=new z;return this.listeners.push(e),Promise.resolve(e)}}class t1{api;_info;stream;name;constructor(e,t){this.api=e,this._info=t,this.stream=t.stream_name,this.name=t.name}consume(e={max_messages:100,expires:3e4}){return Promise.resolve(new tQ(this,e,!0))}fetch(e={max_messages:100,expires:3e4}){let t=new tQ(this,e,!1),r=v(Math.round(1.05*t.opts.expires));return t.closed().catch(()=>{}).finally(()=>{r.cancel()}),r.catch(()=>{t.close().catch()}),t.trackTimeout(r),Promise.resolve(t)}next(e={expires:3e4}){let t=x();e.max_messages=1;let r=new tQ(this,e,!1),s=Math.round(1.05*r.opts.expires);s>=6e4&&(async()=>{for await(let e of(await r.status()))if(e.type===ea.HeartbeatsMissed&&e.data>=2){t.reject(Error("consumer missed heartbeats"));break}})().catch(),(async()=>{for await(let e of r){t.resolve(e);break}})().catch(()=>{});let i=v(s);return r.closed().then(e=>{e?t.reject(e):t.resolve(null)}).catch(e=>{t.reject(e)}).finally(()=>{i.cancel()}),i.catch(e=>{t.resolve(null),r.close().catch()}),r.trackTimeout(i),t}delete(){let{stream_name:e,name:t}=this._info;return this.api.delete(e,t)}info(e=!1){if(e)return Promise.resolve(this._info);let{stream_name:t,name:r}=this._info;return this.api.info(t,r).then(e=>(this._info=e,this._info))}}class t2{api;consumerOpts;consumer;opts;cursor;stream;namePrefix;serial;currentConsumer;userCallback;iter;type;startSeq;maxInitialReset;constructor(e,t,r={}){this.api=e,this.stream=t,this.cursor={stream_seq:1,deliver_seq:0},this.namePrefix=d.next(),"string"==typeof r.name_prefix&&(F("name_prefix",r.name_prefix),this.namePrefix=r.name_prefix+this.namePrefix),this.serial=0,this.currentConsumer=null,this.userCallback=null,this.iter=null,this.type=eo.Unset,this.consumerOpts=r,this.maxInitialReset=30,this.startSeq=this.consumerOpts.opt_start_seq||0,this.cursor.stream_seq=this.startSeq>0?this.startSeq-1:0}getConsumerOpts(e){this.serial++;let t=`${this.namePrefix}_${this.serial}`;e=0===e?1:e;let r={name:t,deliver_policy:eA.StartSequence,opt_start_seq:e,ack_policy:eP.None,inactive_threshold:O(3e5),num_replicas:1};return!0===this.consumerOpts.headers_only&&(r.headers_only=!0),Array.isArray(this.consumerOpts.filterSubjects)&&(r.filter_subjects=this.consumerOpts.filterSubjects),"string"==typeof this.consumerOpts.filterSubjects&&(r.filter_subject=this.consumerOpts.filterSubjects),this.consumerOpts.replay_policy&&(r.replay_policy=this.consumerOpts.replay_policy),e===this.startSeq+1&&(r.deliver_policy=this.consumerOpts.deliver_policy||eA.StartSequence,(this.consumerOpts.deliver_policy===eA.LastPerSubject||this.consumerOpts.deliver_policy===eA.New||this.consumerOpts.deliver_policy===eA.Last)&&(delete r.opt_start_seq,r.deliver_policy=this.consumerOpts.deliver_policy),r.deliver_policy===eA.LastPerSubject&&void 0===r.filter_subjects&&void 0===r.filter_subject&&(r.filter_subject=">"),this.consumerOpts.opt_start_time&&(delete r.opt_start_seq,r.deliver_policy=eA.StartTime,r.opt_start_time=this.consumerOpts.opt_start_time),this.consumerOpts.inactive_threshold&&(r.inactive_threshold=O(this.consumerOpts.inactive_threshold))),r}async resetConsumer(e=0){let t;d.next();let r=0===this.serial;this.consumer?.delete().catch(()=>{}),e=0===e?1:e,this.cursor.deliver_seq=0;let s=this.getConsumerOpts(e);s.max_deliver=1,s.mem_storage=!0;let i=P([this.opts?.expires||3e4]);for(let e=0;;e++)try{t=await this.api.add(this.stream,s),this.iter?.notify(ea.OrderedConsumerRecreated,t.name);break}catch(t){if("stream not found"===t.message&&(this.iter?.notify(ea.StreamNotFound,e),this.type===eo.Fetch||!0===this.opts.abort_on_missing_resource))return this.iter?.stop(t),Promise.reject(t);if(r&&e>=this.maxInitialReset)throw t;await E(i.backoff(e+1))}return t}internalHandler(e){return t=>{if(this.serial!==e)return;let r=t.info.deliverySequence;if(r!==this.cursor.deliver_seq+1){this.notifyOrderedResetAndReset();return}this.cursor.deliver_seq=r,this.cursor.stream_seq=t.info.streamSequence,this.userCallback?this.userCallback(t):this.iter?.push(t)}}async reset(e={max_messages:100,expires:3e4},t){let r=(t=t||{}).fromFetch||!1,s=t.orderedReset||!1;if(this.type===eo.Fetch&&s){this.iter?.src.stop(),await this.iter?.closed(),this.currentConsumer=null;return}(null===this.currentConsumer||s)&&(this.currentConsumer=await this.resetConsumer(this.cursor.stream_seq+1)),(null===this.iter||r)&&(this.iter=new t0),this.consumer=new t1(this.api,this.currentConsumer),e.callback=this.internalHandler(this.serial);let i=null;this.type===eo.Fetch&&r?i=await this.consumer.fetch(e):this.type===eo.Consume&&(i=await this.consumer.consume(e));let n=i;n.forOrderedConsumer=!0,n.resetHandler=()=>{this.notifyOrderedResetAndReset()},this.iter.setSource(n)}notifyOrderedResetAndReset(){this.iter?.notify(eh.Reset,""),this.reset(this.opts,{orderedReset:!0})}async consume(e={max_messages:100,expires:3e4}){if(e.bind)return Promise.reject(Error("bind is not supported"));if(this.type===eo.Fetch)return Promise.reject(Error("ordered consumer initialized as fetch"));if(this.type===eo.Consume)return Promise.reject(Error("ordered consumer doesn't support concurrent consume"));let{callback:t}=e;return t&&(this.userCallback=t),this.type=eo.Consume,this.opts=e,await this.reset(e),this.iter}async fetch(e={max_messages:100,expires:3e4}){if(e.bind)return Promise.reject(Error("bind is not supported"));if(this.type===eo.Consume)return Promise.reject(Error("ordered consumer already initialized as consume"));if(this.iter?.done===!1)return Promise.reject(Error("ordered consumer doesn't support concurrent fetch"));let{callback:t}=e;return t&&(this.userCallback=t),this.type=eo.Fetch,this.opts=e,await this.reset(e,{fromFetch:!0}),this.iter}async next(e={expires:3e4}){if(e.bind)return Promise.reject(Error("bind is not supported"));e.max_messages=1;let t=x();return e.callback=e=>{this.userCallback=null,t.resolve(e)},(await this.fetch(e)).iterClosed.then(e=>{e&&t.reject(e),t.resolve(null)}).catch(e=>{t.reject(e)}),t}delete(){return this.currentConsumer?this.api.delete(this.stream,this.currentConsumer.name).then(e=>Promise.resolve(e)).catch(e=>Promise.reject(e)).finally(()=>{this.currentConsumer=null}):Promise.resolve(!1)}async info(e){return null==this.currentConsumer?(this.currentConsumer=await this.resetConsumer(this.startSeq),Promise.resolve(this.currentConsumer)):e&&this.currentConsumer?Promise.resolve(this.currentConsumer):this.api.info(this.stream,this.currentConsumer.name)}}class t3{api;notified;constructor(e){this.api=e,this.notified=!1}checkVersion(){let e=this.api.nc.features.get(Q.JS_SIMPLIFICATION);return e.ok?Promise.resolve():Promise.reject(Error(`consumers framework is only supported on servers ${e.min} or better`))}getPullConsumerFor(e){if(void 0!==e.config.deliver_subject)throw Error("push consumer not supported");return new t1(this.api,e)}async get(e,t={}){return"object"==typeof t?this.ordered(e,t):(await this.checkVersion(),this.api.info(e,t).then(e=>void 0!==e.config.deliver_subject?Promise.reject(Error("push consumer not supported")):new t1(this.api,e)).catch(e=>Promise.reject(e)))}async ordered(e,t){await this.checkVersion();let r=this.api;return new t4(r.nc,r.opts).info(e).then(r=>Promise.resolve(new t2(this.api,e,t))).catch(e=>Promise.reject(e))}}class t5{api;_info;constructor(e,t){this.api=e,this._info=t}get name(){return this._info.config.name}alternates(){return this.info().then(e=>e.alternates?e.alternates:[])}async best(){if(await this.info(),!this._info.alternates)return this;{let e=await this.api.info(this._info.alternates[0].name);return new t5(this.api,e)}}info(e=!1,t){return e?Promise.resolve(this._info):this.api.info(this.name,t).then(e=>(this._info=e,this._info))}getConsumerFromInfo(e){return new t3(new e2(this.api.nc,this.api.opts)).getPullConsumerFor(e)}getConsumer(e){return new t3(new e2(this.api.nc,this.api.opts)).get(this.name,e)}getMessage(e){return this.api.getMessage(this.name,e)}deleteMessage(e,t){return this.api.deleteMessage(this.name,e,t)}}class t4 extends eX{constructor(e,t){super(e,t)}checkStreamConfigVersions(e){let t=this.nc;if(e.metadata){let{min:e,ok:r}=t.features.get(Q.JS_STREAM_CONSUMER_METADATA);if(!r)throw Error(`stream 'metadata' requires server ${e}`)}if(e.first_seq){let{min:e,ok:r}=t.features.get(Q.JS_STREAM_FIRST_SEQ);if(!r)throw Error(`stream 'first_seq' requires server ${e}`)}if(e.subject_transform){let{min:e,ok:r}=t.features.get(Q.JS_STREAM_SUBJECT_TRANSFORM);if(!r)throw Error(`stream 'subject_transform' requires server ${e}`)}if(e.compression){let{min:e,ok:r}=t.features.get(Q.JS_STREAM_COMPRESSION);if(!r)throw Error(`stream 'compression' requires server ${e}`)}if(e.consumer_limits){let{min:e,ok:r}=t.features.get(Q.JS_DEFAULT_CONSUMER_LIMITS);if(!r)throw Error(`stream 'consumer_limits' requires server ${e}`)}function r(e,r){if((r?.subject_transforms?.length||0)>0){let{min:r,ok:s}=t.features.get(Q.JS_STREAM_SOURCE_SUBJECT_TRANSFORM);if(!s)throw Error(`${e} 'subject_transforms' requires server ${r}`)}}e.sources&&e.sources.forEach(e=>{r("stream sources",e)}),e.mirror&&r("stream mirror",e.mirror)}async add(e={}){this.checkStreamConfigVersions(e),q(e.name),e.mirror=tz(e.mirror),e.sources=e.sources?.map(tz);let t=await this._request(`${this.prefix}.STREAM.CREATE.${e.name}`,e);return this._fixInfo(t),t}async delete(e){return q(e),(await this._request(`${this.prefix}.STREAM.DELETE.${e}`)).success}async update(e,t={}){if("object"==typeof e){let r=e;e=r.name,t=r,console.trace(`\u001B[33m >> streams.update(config: StreamConfig) api changed to streams.update(name: string, config: StreamUpdateConfig) - this shim will be removed - update your code.  \u001B[0m`)}this.checkStreamConfigVersions(t),q(e);let r=Object.assign((await this.info(e)).config,t);r.mirror=tz(r.mirror),r.sources=r.sources?.map(tz);let s=await this._request(`${this.prefix}.STREAM.UPDATE.${e}`,r);return this._fixInfo(s),s}async info(e,t){q(e);let r=`${this.prefix}.STREAM.INFO.${e}`,s=await this._request(r,t),{total:i,limit:n}=s,o=s.state.subjects?Object.getOwnPropertyNames(s.state.subjects).length:1;if(i&&i>o){let e=[s],a=t||{},h=0;for(;i>o;){h++,a.offset=n*h;let t=await this._request(r,a);i=t.total,e.push(t);let s=Object.getOwnPropertyNames(t.state.subjects).length;if(o+=s,s<n)break}let c={};for(let t=0;t<e.length;t++)(s=e[t]).state.subjects&&(c=Object.assign(c,s.state.subjects));s.offset=0,s.total=0,s.limit=0,s.state.subjects=c}return this._fixInfo(s),s}list(e=""){let t=e?.length?{subject:e}:{};return new eZ(`${this.prefix}.STREAM.LIST`,e=>(e.streams.forEach(e=>{this._fixInfo(e)}),e.streams),this,t)}_fixInfo(e){e.config.sealed=e.config.sealed||!1,e.config.deny_delete=e.config.deny_delete||!1,e.config.deny_purge=e.config.deny_purge||!1,e.config.allow_rollup_hdrs=e.config.allow_rollup_hdrs||!1}async purge(e,t){if(t){let{keep:e,seq:r}=t;if("number"==typeof e&&"number"==typeof r)throw Error("can specify one of keep or seq")}return q(e),await this._request(`${this.prefix}.STREAM.PURGE.${e}`,t)}async deleteMessage(e,t,r=!0){q(e);let s={seq:t};return r||(s.no_erase=!0),(await this._request(`${this.prefix}.STREAM.MSG.DELETE.${e}`,s)).success}async getMessage(e,t){return q(e),new t9(await this._request(`${this.prefix}.STREAM.MSG.GET.${e}`,t))}find(e){return this.findStream(e)}listKvs(){return new eZ(`${this.prefix}.STREAM.LIST`,e=>{let t=e.streams.filter(e=>e.config.name.startsWith("KV_"));t.forEach(e=>{this._fixInfo(e)});let r="";return t.length&&(r=this.nc.info?.cluster??""),t.map(e=>new tB(e,r))},this)}listObjectStores(){return new eZ(`${this.prefix}.STREAM.LIST`,e=>{let t=e.streams.filter(e=>e.config.name.startsWith(tD));return t.forEach(e=>{this._fixInfo(e)}),t.map(e=>new tJ(e))},this)}names(e=""){let t=e?.length?{subject:e}:{};return new eZ(`${this.prefix}.STREAM.NAMES`,e=>e.streams,this,t)}async get(e){return Promise.resolve(new t5(this,await this.info(e)))}}class t6 extends eX{constructor(e,t){super(e,t)}async getMessage(e,t){q(e);let r=t,{last_by_subj:s}=r;s&&(r=null);let i=r?this.jc.encode(r):n,o=this.opts.apiPrefix||"$JS.API",a=s?`${o}.DIRECT.GET.${e}.${s}`:`${o}.DIRECT.GET.${e}`,h=await this.nc.request(a,i,{timeout:this.timeout}),c=H(h);return c?Promise.reject(c):Promise.resolve(new t8(h))}async getBatch(e,t){q(e);let r=this.opts.apiPrefix||"$JS.API",s=`${r}.DIRECT.GET.${e}`;if(!Array.isArray(t.multi_last)||0===t.multi_last.length)return Promise.reject("multi_last is required");let i=JSON.stringify(t,(e,t)=>"up_to_time"===e&&t instanceof Date?t.toISOString():t),n=new z,o=await this.nc.requestMany(s,i,{strategy:e_.SentinelMsg});return(async()=>{let e,t=!1,r=!1;for await(let s of o){if(!t){t=!0;let i=s.headers?.code||0;if(0!==i&&i<200||i>299){e=s.headers?.description.toLowerCase();break}if(""===s.headers?.get("Nats-Num-Pending")){r=!0;break}}if(0===s.data.length)break;n.push(new t8(s))}n.push(()=>{if(r)throw Error("batch direct get not supported by the server");if(e)throw Error(`bad request: ${e}`);n.stop()})})(),Promise.resolve(n)}}class t8{data;header;static jc;constructor(e){if(!e.headers)throw Error("headers expected");this.data=e.data,this.header=e.headers}get subject(){return this.header.last(eM.Subject)}get seq(){let e=this.header.last(eM.Sequence);return"string"==typeof e?parseInt(e):0}get time(){return new Date(Date.parse(this.timestamp))}get timestamp(){return this.header.last(eM.TimeStamp)}get stream(){return this.header.last(eM.Stream)}json(e){return R(e).decode(this.data)}string(){return a.decode(this.data)}}class t7 extends eX{streams;consumers;direct;constructor(e,t){super(e,t),this.streams=new t4(e,t),this.consumers=new e2(e,t),this.direct=new t6(e,t)}async getAccountInfo(){return await this._request(`${this.prefix}.INFO`)}jetstream(){return this.nc.jetstream(this.getOptions())}advisories(){let e=new z;return this.nc.subscribe("$JS.EVENT.ADVISORY.>",{callback:(t,r)=>{if(t)throw t;try{let t=this.parseJsResponse(r),s=t.type.split("."),i=s[s.length-1];e.push({kind:i,data:t})}catch(t){e.stop(t)}}}),e}}class t9{_header;smr;static jc;constructor(e){this.smr=e}get subject(){return this.smr.message.subject}get seq(){return this.smr.message.seq}get timestamp(){return this.smr.message.time}get time(){return new Date(Date.parse(this.timestamp))}get data(){return this.smr.message.data?this._parse(this.smr.message.data):n}get header(){if(!this._header){if(this.smr.message.hdrs){let e=this._parse(this.smr.message.hdrs);this._header=N.decode(e)}else this._header=j()}return this._header}_parse(e){let t=atob(e),r=t.length,s=new Uint8Array(r);for(let e=0;e<r;e++)s[e]=t.charCodeAt(e);return s}json(e){return R(e).decode(this.data)}string(){return a.decode(this.data)}}class re{api;constructor(e){this.api=e}get(e){return this.api.info(e).then(e=>new t5(this.api,e))}}class rt{info;hdrs;constructor(e){this.info=e}get name(){return this.info.name}get description(){return this.info.description??""}get headers(){return this.hdrs||(this.hdrs=N.fromRecord(this.info.headers||{})),this.hdrs}get options(){return this.info.options}get bucket(){return this.info.bucket}get chunks(){return this.info.chunks}get deleted(){return this.info.deleted??!1}get digest(){return this.info.digest}get mtime(){return this.info.mtime}get nuid(){return this.info.nuid}get size(){return this.info.size}get revision(){return this.info.revision}get metadata(){return this.info.metadata||{}}isLink(){return this.info.options?.link!==void 0&&this.info.options?.link!==null}}function rr(e){let t={name:e.name,description:e.description??"",options:e.options,metadata:e.metadata};if(e.headers){let r=e.headers;t.headers=r.toRecord()}return t}class rs{jsm;js;stream;name;constructor(e,t,r){this.name=e,this.jsm=t,this.js=r}_checkNotEmpty(e){return e&&0!==e.length?{name:e}:{name:e,error:Error("name cannot be empty")}}async info(e){let t=await this.rawInfo(e);return t?new rt(t):null}async list(){let e=[];for await(let t of(await this.watch({ignoreDeletes:!0,includeHistory:!0}))){if(null===t)break;e.push(t)}return Promise.resolve(e)}async rawInfo(e){let{name:t,error:r}=this._checkNotEmpty(e);if(r)return Promise.reject(r);let s=this._metaSubject(t);try{let e=await this.jsm.streams.getMessage(this.stream,{last_by_subj:s}),t=R().decode(e.data);return t.revision=e.seq,t}catch(e){if("404"===e.code)return null;return Promise.reject(e)}}async _si(e){try{return await this.jsm.streams.info(this.stream,e)}catch(e){if("404"===e.code)return null;return Promise.reject(e)}}async seal(){let e=await this._si();return null===e?Promise.reject(Error("object store not found")):(e.config.sealed=!0,Promise.resolve(new tJ(e=await this.jsm.streams.update(this.stream,e.config))))}async status(e){let t=await this._si(e);return null===t?Promise.reject(Error("object store not found")):Promise.resolve(new tJ(t))}destroy(){return this.jsm.streams.delete(this.stream)}async _put(e,t,r){let s=this.js.getOptions();(r=r||{timeout:s.timeout}).timeout=r.timeout||s.timeout,r.previousRevision=r.previousRevision??void 0;let{timeout:i,previousRevision:n}=r,o=this.js.nc.info,a=o?.max_payload||1024;(e=e||{}).options=e.options||{};let h=e.options?.max_chunk_size||131072;h=h>a?a:h,e.options.max_chunk_size=h;let c=await this.info(e.name),{name:u,error:l}=this._checkNotEmpty(e.name);if(l)return Promise.reject(l);let f=d.next(),p=this._chunkSubject(f),m=this._metaSubject(u),g=Object.assign({bucket:this.name,nuid:f,size:0,chunks:0},rr(e)),b=x(),_=[],y=new Z;try{let r=t?t.getReader():null,s=eG.create();for(;;){let{done:t,value:o}=r?await r.read():{done:!0,value:void 0};if(t){if(y.size()>0){let e=y.drain();s.update(e),g.chunks++,g.size+=e.length,_.push(this.js.publish(p,e,{timeout:i}))}await Promise.all(_),_.length=0,g.mtime=new Date().toISOString();let e=X.encode(s.digest());g.digest=`${tH}${e}`,g.deleted=!1;let t=j();"number"==typeof n&&t.set(en.ExpectedLastSubjectSequenceHdr,`${n}`),t.set(eI.RollupHdr,eI.RollupValueSubject);let r=await this.js.publish(m,R().encode(g),{headers:t,timeout:i});if(g.revision=r.seq,c)try{await this.jsm.streams.purge(this.stream,{filter:`$O.${this.name}.C.${c.nuid}`})}catch(e){}b.resolve(new rt(g));break}if(o)for(y.fill(o);y.size()>h;){g.chunks++,g.size+=h;let t=y.drain(e.options.max_chunk_size);s.update(t),_.push(this.js.publish(p,t,{timeout:i}))}}}catch(e){await this.jsm.streams.purge(this.stream,{filter:p}),b.reject(e)}return b}putBlob(e,t,r){var s;return null===t&&(t=new Uint8Array(0)),this.put(e,(s=t,new ReadableStream({pull(e){e.enqueue(s),e.close()}})),r)}put(e,t,r){return e?.options?.link?Promise.reject(Error("link cannot be set when putting the object in bucket")):this._put(e,t,r)}async getBlob(e){async function t(e){let t=new Z,r=e.getReader();for(;;){let{done:e,value:s}=await r.read();if(e)return t.drain();s&&s.length&&t.fill(s)}}let r=await this.get(e);if(null===r)return Promise.resolve(null);let s=await Promise.all([r.error,t(r.data)]);return s[0]?Promise.reject(s[0]):Promise.resolve(s[1])}async get(e){let t;let r=await this.rawInfo(e);if(null===r||r.deleted)return Promise.resolve(null);if(r.options&&r.options.link){let e=r.options.link.name||"";if(""===e)throw Error("link is a bucket");return(r.options.link.bucket!==this.name?await rs.create(this.js,r.options.link.bucket):this).get(e)}if(!r.digest.startsWith(tH))return Promise.reject(Error(`unknown digest type: ${r.digest}`));let s=eK(r.digest.substring(8));if(null===s)return Promise.reject(Error(`unable to parse digest: ${r.digest}`));let i=x(),n={info:new rt(r),error:i};if(0===r.size)return n.data=new ReadableStream({pull(e){e.enqueue(new Uint8Array(0)),e.close()}}),i.resolve(null),Promise.resolve(n);let o=V();o.orderedConsumer();let a=eG.create(),h=`$O.${this.name}.C.${r.nuid}`,c=await this.js.subscribe(h,o);return(async()=>{for await(let e of c)e.data.length>0&&(a.update(e.data),t.enqueue(e.data)),0===e.info.pending&&(function(e,t){let r="string"==typeof e?eK(e):e,s="string"==typeof t?eK(t):t;if(null===r||null===s||r.length!==s.length)return!1;for(let e=0;e<r.length;e++)if(r[e]!==s[e])return!1;return!0}(s,a.digest())?t.close():t.error(Error(`received a corrupt object, digests do not match received: ${r.digest} calculated ${s}`)),c.unsubscribe())})().then(()=>{i.resolve()}).catch(e=>{t.error(e),i.reject(e)}),n.data=new ReadableStream({start(e){t=e},cancel(){c.unsubscribe()}}),n}linkStore(e,t){if(!(t instanceof rs))return Promise.reject("bucket required");let{name:r,error:s}=this._checkNotEmpty(e);if(s)return Promise.reject(s);let i={name:r,options:{link:{bucket:t.name}}};return this._put(i,null)}async link(e,t){let{name:r,error:s}=this._checkNotEmpty(e);if(s)return Promise.reject(s);if(t.deleted)return Promise.reject(Error("src object is deleted"));if(t.isLink())return Promise.reject(Error("src object is a link"));let i=await this.rawInfo(e);if(null!==i&&!i.deleted)return Promise.reject(Error("an object already exists with that name"));let n={bucket:t.bucket,name:t.name},o={name:r,bucket:t.bucket,options:{link:n}};return await this.js.publish(this._metaSubject(e),JSON.stringify(o)),Promise.resolve(await this.info(e))}async delete(e){let t=await this.rawInfo(e);if(null===t)return Promise.resolve({purged:0,success:!1});t.deleted=!0,t.size=0,t.chunks=0,t.digest="";let r=R(),s=j();return s.set(eI.RollupHdr,eI.RollupValueSubject),await this.js.publish(this._metaSubject(t.name),r.encode(t),{headers:s}),this.jsm.streams.purge(this.stream,{filter:this._chunkSubject(t.nuid)})}async update(e,t={}){let r=await this.rawInfo(e);if(null===r)return Promise.reject(Error("object not found"));if(r.deleted)return Promise.reject(Error("cannot update meta for a deleted object"));t.name=t.name??r.name;let{name:s,error:i}=this._checkNotEmpty(t.name);if(i)return Promise.reject(i);if(e!==t.name){let e=await this.info(t.name);if(e&&!e.deleted)return Promise.reject(Error("an object already exists with that name"))}t.name=s;let n=Object.assign({},r,rr(t)),o=await this.js.publish(this._metaSubject(n.name),JSON.stringify(n));return e!==t.name&&await this.jsm.streams.purge(this.stream,{filter:this._metaSubject(e)}),Promise.resolve(o)}async watch(e={}){e.includeHistory=e.includeHistory??!1,e.ignoreDeletes=e.ignoreDeletes??!1;let t=!1,r=new z,s=this._metaSubjectAll();try{await this.jsm.streams.getMessage(this.stream,{last_by_subj:s})}catch(e){"404"===e.code?(r.push(null),t=!0):r.stop(e)}let i=R(),n=V();n.orderedConsumer(),e.includeHistory?n.deliverLastPerSubject():(t=!0,n.deliverNew()),n.callback((s,n)=>{if(s){r.stop(s);return}if(null!==n){let s=i.decode(n.data);s.deleted&&!0===e.ignoreDeletes||r.push(s),n.info?.pending!==0||t||(t=!0,r.push(null))}});let o=await this.js.subscribe(s,n);return r._data=o,r.iterClosed.then(()=>{o.unsubscribe()}),o.closed.then(()=>{r.stop()}).catch(e=>{r.stop(e)}),r}_chunkSubject(e){return`$O.${this.name}.C.${e}`}_metaSubject(e){return`$O.${this.name}.M.${X.encode(e)}`}_metaSubjectAll(){return`$O.${this.name}.M.>`}async init(e={}){try{var t;this.stream=(t=this.name,tF(t),`${tD}${t}`)}catch(e){return Promise.reject(e)}let r=e?.ttl||0;delete e.ttl;let s=Object.assign({max_age:r},e);s.name=this.stream,s.num_replicas=e.replicas??1,s.allow_direct=!0,s.allow_rollup_hdrs=!0,s.discard=eE.New,s.subjects=[`$O.${this.name}.C.>`,`$O.${this.name}.M.>`],e.placement&&(s.placement=e.placement),e.metadata&&(s.metadata=e.metadata),"boolean"==typeof e.compression&&(s.compression=e.compression?ek.S2:ek.None);try{await this.jsm.streams.info(s.name)}catch(e){"stream not found"===e.message&&await this.jsm.streams.add(s)}}static async create(e,t,r={}){let s=new rs(t,await e.jetstreamManager(),e);return await s.init(r),Promise.resolve(s)}}class ri{js;constructor(e){this.js=e}kv(e,t={}){let{ok:r,min:s}=this.js.nc.features.get(Q.JS_KV);return r?t.bindOnly?tL.bind(this.js,e,t):tL.create(this.js,e,t):Promise.reject(Error(`kv is only supported on servers ${s} or better`))}os(e,t={}){if("function"!=typeof crypto?.subtle?.digest)return Promise.reject(Error("objectstore: unable to calculate hashes - crypto.subtle.digest with sha256 support is required"));let{ok:r,min:s}=this.js.nc.features.get(Q.JS_OBJECTSTORE);return r?rs.create(this.js,e,t):Promise.reject(Error(`objectstore is only supported on servers ${s} or better`))}}class rn extends eX{consumers;streams;consumerAPI;streamAPI;constructor(e,t){super(e,t),this.consumerAPI=new e2(e,t),this.streamAPI=new t4(e,t),this.consumers=new t3(this.consumerAPI),this.streams=new re(this.streamAPI)}jetstreamManager(e){void 0===e&&(e=this.opts.checkAPI);let t=Object.assign({},this.opts,{checkAPI:e});return this.nc.jetstreamManager(t)}get apiPrefix(){return this.prefix}get views(){return new ri(this)}async publish(e,t=n,r){let s;(r=r||{}).expect=r.expect||{};let i=r?.headers||j();r&&(r.msgID&&i.set(en.MsgIdHdr,r.msgID),r.expect.lastMsgID&&i.set(en.ExpectedLastMsgIdHdr,r.expect.lastMsgID),r.expect.streamName&&i.set(en.ExpectedStreamHdr,r.expect.streamName),"number"==typeof r.expect.lastSequence&&i.set(en.ExpectedLastSeqHdr,`${r.expect.lastSequence}`),"number"==typeof r.expect.lastSubjectSequence&&i.set(en.ExpectedLastSubjectSequenceHdr,`${r.expect.lastSubjectSequence}`));let o=r.timeout||this.timeout,a={};o&&(a.timeout=o),r&&(a.headers=i);let{retries:h,retry_delay:c}=r;h=h||1,c=c||250;for(let r=0;r<h;r++)try{s=await this.nc.request(e,t,a);break}catch(e){if("503"===e.code&&r+1<h)await E(c);else throw e}let u=this.parseJsResponse(s);if(""===u.stream)throw m.errorForCode(eg.JetStreamInvalidAck);return u.duplicate=!!u.duplicate&&u.duplicate,u}async pull(e,t,r=0){q(e),U(t);let s=this.timeout;r>s&&(s=r);let i={batch:1,no_wait:0===(r=r<0?0:O(r)),expires:r},n=await this.nc.request(`${this.prefix}.CONSUMER.MSG.NEXT.${e}.${t}`,this.jc.encode(i),{noMux:!0,timeout:s}),o=H(n);if(o)throw o;return tZ(n,this.timeout)}fetch(e,t,r={}){q(e),U(t);let s=null,i=(r.max_bytes??0)>0,n=0,o=i?r.max_bytes:0,a=null,h={};if(h.batch=r.batch||1,o){let e=this.nc.features.get(Q.JS_PULL_MAX_BYTES);if(!e.ok)throw Error(`max_bytes is only supported on servers ${e.min} or better`);h.max_bytes=o}h.no_wait=r.no_wait||!1,h.no_wait&&h.expires&&(h.expires=0);let c=r.expires||0;if(c&&(h.expires=O(c)),0===c&&!1===h.no_wait)throw Error("expires or no_wait is required");let u=r.idle_heartbeat||0;u&&(h.idle_heartbeat=O(u),!0===r.delay_heartbeat&&(h.idle_heartbeat=O(4*u)));let l=new z,d=h.batch,f=0;l.protocolFilterFn=(e,t=!1)=>!D(e.msg)||(a?.work(),!1),l.dispatchedFn=e=>{e&&(i&&(n+=e.data.length),f++,(!s||0!==e.info.pending)&&(1===l.getPending()&&0===e.info.pending||d===f||o>0&&n>=o)&&l.stop())};let p=y(this.nc.options.inboxPrefix),g=this.nc.subscribe(p,{max:r.batch,callback:(e,t)=>{(null===e&&(e=H(t)),null!==e)?(s&&(s.cancel(),s=null),"string"==typeof e.code)?l.stop(null===rd(e)?void 0:e):l.stop(e):(a?.work(),l.received++,l.push(tZ(t,this.timeout)))}});return c&&(s=v(c)).catch(()=>{g.isClosed()||(g.drain().catch(()=>{}),s=null),a&&a.cancel()}),(async()=>{try{u&&(a=new G(u,e=>(l.push(()=>{l.err=new m(`${eS.IdleHeartbeatMissed}: ${e}`,eg.JetStreamIdleHeartBeat)}),!0)))}catch(e){}await g.closed,null!==s&&(s.cancel(),s=null),a&&a.cancel(),l.stop()})().catch(),this.nc.publish(`${this.prefix}.CONSUMER.MSG.NEXT.${e}.${t}`,this.jc.encode(h),{reply:p}),l}async pullSubscribe(e,t=V()){let r=await this._processOptions(e,t);if(r.ordered)throw Error("pull subscribers cannot be be ordered");if(r.config.deliver_subject)throw Error("consumer info specifies deliver_subject - pull consumers cannot have deliver_subject set");let s=r.config.ack_policy;if(s===eP.None||s===eP.All)throw Error("ack policy for pull consumers must be explicit");let i=this._buildTypedSubscriptionOpts(r),n=new rl(this,r.deliver,i);n.info=r;try{await this._maybeCreateConsumer(r)}catch(e){throw n.unsubscribe(),e}return n}async subscribe(e,t=V()){let r=await this._processOptions(e,t);if(!r.isBind&&!r.config.deliver_subject)throw Error("push consumer requires deliver_subject");let s=this._buildTypedSubscriptionOpts(r),i=new ru(this,r.deliver,s);i.info=r;try{await this._maybeCreateConsumer(r)}catch(e){throw i.unsubscribe(),e}return i._maybeSetupHbMonitoring(),i}async _processOptions(e,t=V()){let r=W(t)?t.getOpts():t;if(r.isBind=!!W(t)&&t.isBind,r.flow_control={heartbeat_count:0,fc_count:0,consumer_restarts:0},r.ordered){if(r.ordered_consumer_sequence={stream_seq:0,delivery_seq:0},r.config.ack_policy!==eP.NotSet&&r.config.ack_policy!==eP.None)throw new m("ordered consumer: ack_policy can only be set to 'none'",eg.ApiError);if(r.config.durable_name&&r.config.durable_name.length>0)throw new m("ordered consumer: durable_name cannot be set",eg.ApiError);if(r.config.deliver_subject&&r.config.deliver_subject.length>0)throw new m("ordered consumer: deliver_subject cannot be set",eg.ApiError);if(void 0!==r.config.max_deliver&&r.config.max_deliver>1)throw new m("ordered consumer: max_deliver cannot be set",eg.ApiError);if(r.config.deliver_group&&r.config.deliver_group.length>0)throw new m("ordered consumer: deliver_group cannot be set",eg.ApiError);r.config.deliver_subject=y(this.nc.options.inboxPrefix),r.config.ack_policy=eP.None,r.config.max_deliver=1,r.config.flow_control=!0,r.config.idle_heartbeat=r.config.idle_heartbeat||O(5e3),r.config.ack_wait=O(792e5),r.config.mem_storage=!0,r.config.num_replicas=1}if(r.config.ack_policy===eP.NotSet&&(r.config.ack_policy=eP.All),r.api=this,r.config=r.config||{},r.stream=r.stream?r.stream:await this.findStream(e),r.attached=!1,r.config.durable_name)try{let t=await this.consumerAPI.info(r.stream,r.config.durable_name);if(t){if(t.config.filter_subject&&t.config.filter_subject!==e)throw Error("subject does not match consumer");let s=r.config.deliver_group??"";if(""===s&&!0===t.push_bound)throw Error("duplicate subscription");let i=t.config.deliver_group??"";if(s!==i){if(""===i)throw Error("durable requires no queue group");throw Error(`durable requires queue group '${i}'`)}r.last=t,r.config=t.config,r.attached=!0,r.config.durable_name||(r.name=t.name)}}catch(e){if("404"!==e.code)throw e}return r.attached||void 0!==r.config.filter_subject||void 0!==r.config.filter_subjects||(r.config.filter_subject=e),r.deliver=r.config.deliver_subject||y(this.nc.options.inboxPrefix),r}_buildTypedSubscriptionOpts(e){var t,r;let s={};return s.adapter=(t=void 0===e.callbackFn,r=this.timeout,t?(e,t)=>{if(e)return[e,null];let s=H(t);return null!==s?[rd(s),null]:[null,tZ(t,r)]}:(e,t)=>e||(e=H(t))?[e,null]:[null,tZ(t,r)]),s.ingestionFilterFn=rn.ingestionFn(e.ordered),s.protocolFilterFn=(e,t=!1)=>!B(e.msg)||(t||e.msg.respond(),!1),e.mack||e.config.ack_policy===eP.None||(s.dispatchedFn=rf),e.callbackFn&&(s.callback=e.callbackFn),s.max=e.max||0,s.queue=e.queue,s}async _maybeCreateConsumer(e){if(e.attached)return;if(e.isBind)throw Error(`unable to bind - durable consumer ${e.config.durable_name} doesn't exist in ${e.stream}`);e.config=Object.assign({deliver_policy:eA.All,ack_policy:eP.Explicit,ack_wait:O(3e4),replay_policy:eO.Instant},e.config);let t=await this.consumerAPI.add(e.stream,e.config);if(Array.isArray(e.config.filter_subjects&&!Array.isArray(t.config.filter_subjects)))throw Error("jetstream server doesn't support consumers with multiple filter subjects");e.name=t.name,e.config=t.config,e.last=t}static ingestionFn(e){return(t,r)=>{if(!t)return{ingest:!1,protocol:!1};if(H(t.msg)||r.monitor?.work(),D(t.msg)){let s=!e||r._checkHbOrderConsumer(t.msg);return!e&&r.info.flow_control.heartbeat_count++,{ingest:s,protocol:!0}}return B(t.msg)?(r.info.flow_control.fc_count++,{ingest:!0,protocol:!0}):{ingest:!e||r._checkOrderedConsumer(t),protocol:!1}}}}class ro{options;protocol;draining;listeners;_services;constructor(e){this.draining=!1,this.options=function(e){let t=`${w}:${e4()}`;if((e=e||{servers:[t]}).servers=e.servers||[],"string"==typeof e.servers&&(e.servers=[e.servers]),e.servers.length>0&&e.port)throw new m("port and servers options are mutually exclusive",eg.InvalidOption);0===e.servers.length&&e.port&&(e.servers=[`${w}:${e.port}`]),e.servers&&0===e.servers.length&&(e.servers=[t]);let r=S({maxPingOut:2,maxReconnectAttempts:10,noRandomize:!1,pedantic:!1,pingInterval:null,reconnect:!0,reconnectJitter:100,reconnectJitterTLS:1e3,reconnectTimeWait:null,tls:void 0,verbose:!1,waitOnFirstConnect:!1,ignoreAuthErrorAbort:!1},e);if(r.authenticator=function(e){var t,r,s;let i=[];return"function"==typeof e.authenticator&&i.push(e.authenticator),Array.isArray(e.authenticator)&&i.push(...e.authenticator),e.token&&i.push((t=e.token,()=>({auth_token:"function"==typeof t?t():t}))),e.user&&i.push((r=e.user,s=e.pass,()=>({user:"function"==typeof r?r():r,pass:"function"==typeof s?s():s}))),0===i.length?()=>{}:e=>{let t={};return i.forEach(r=>{let s=r(e)||{};t=Object.assign(t,s)}),t}}(r),["reconnectDelayHandler","authenticator"].forEach(e=>{if(r[e]&&"function"!=typeof r[e])throw new m(`${e} option should be a function`,eg.NotFunction)}),r.reconnectDelayHandler||(r.reconnectDelayHandler=()=>{let e=r.tls?r.reconnectJitterTLS:r.reconnectJitter;return e&&(e=Math.floor(Math.random()*++e)),r.reconnectTimeWait+e}),r.inboxPrefix)try{y(r.inboxPrefix)}catch(e){throw new m(e.message,eg.ApiError)}if(void 0===r.resolve&&(r.resolve="function"==typeof e8()),r.resolve&&"function"!=typeof e8())throw new m("'resolve' is not supported on this client",eg.InvalidOption);return r}(e),this.listeners=[]}static connect(e={}){return new Promise((t,r)=>{let s=new ro(e);tA.connect(s.options,s).then(e=>{s.protocol=e,async function(){for await(let t of e.status())s.listeners.forEach(e=>{e.push(t)})}(),t(s)}).catch(e=>{r(e)})})}closed(){return this.protocol.closed}async close(){await this.protocol.close()}_check(e,t,r){if(this.isClosed())throw m.errorForCode(eg.ConnectionClosed);if(t&&this.isDraining()||r&&this.protocol.noMorePublishing)throw m.errorForCode(eg.ConnectionDraining);if(0===(e=e||"").length)throw m.errorForCode(eg.BadSubject)}publish(e,t,r){this._check(e,!1,!0),this.protocol.publish(e,t,r)}publishMessage(e){return this.publish(e.subject,e.data,{reply:e.reply,headers:e.headers})}respondMessage(e){return!!e.reply&&(this.publish(e.reply,e.data,{reply:e.reply,headers:e.headers}),!0)}subscribe(e,t={}){this._check(e,!0,!1);let r=new tE(this.protocol,e,t);return this.protocol.subscribe(r),r}_resub(e,t,r){this._check(t,!0,!1),e.max=r,r&&(e.max=r+e.received),this.protocol.resub(e,t)}requestMany(e,t=n,r={maxWait:1e3,maxMessages:-1}){let s=!this.protocol.options.noAsyncTraces;try{this._check(e,!0,!0)}catch(e){return Promise.reject(e)}if(r.strategy=r.strategy||e_.Timer,r.maxWait=r.maxWait||1e3,r.maxWait<1)return Promise.reject(new m("timeout",eg.InvalidOption));let i=new z;function o(e){i.push(()=>{i.stop(e)})}function a(e,t){e||null===t?o(null===e?void 0:e):i.push(t)}if(r.noMux){let n=s?Error().stack:null,h="number"==typeof r.maxMessages&&r.maxMessages>0?r.maxMessages:-1,c=this.subscribe(y(this.options.inboxPrefix),{callback:(e,t)=>{if(t?.data?.length===0&&t?.headers?.status===eg.NoResponders&&(e=m.errorForCode(eg.NoResponders)),e){n&&(e.stack+=`

${n}`),u(e);return}a(null,t),r.strategy===e_.Count&&0==--h&&u(),r.strategy===e_.JitterTimer&&(d(),l=setTimeout(()=>{u()},300)),r.strategy===e_.SentinelMsg&&t&&0===t.data.length&&u()}});c.requestSubject=e,c.closed.then(()=>{o()}).catch(e=>{i.stop(e)});let u=e=>{e&&i.push(()=>{throw e}),d(),c.drain().then(()=>{o()}).catch(e=>{o()})};i.iterClosed.then(()=>{d(),c?.unsubscribe()}).catch(e=>{d(),c?.unsubscribe()});try{this.publish(e,t,{reply:c.getSubject()})}catch(e){u(e)}let l=setTimeout(()=>{u()},r.maxWait),d=()=>{l&&clearTimeout(l)}}else{r.callback=a,i.iterClosed.then(()=>{s.cancel()}).catch(e=>{s.cancel(e)});let s=new eW(this.protocol.muxSubscriptions,e,r);this.protocol.request(s);try{this.publish(e,t,{reply:`${this.protocol.muxSubscriptions.baseInbox}${s.token}`,headers:r.headers})}catch(e){s.cancel(e)}}return Promise.resolve(i)}request(e,t,r={timeout:1e3,noMux:!1}){try{this._check(e,!0,!0)}catch(e){return Promise.reject(e)}let s=!this.protocol.options.noAsyncTraces;if(r.timeout=r.timeout||1e3,r.timeout<1)return Promise.reject(new m("timeout",eg.InvalidOption));if(!r.noMux&&r.reply)return Promise.reject(new m("reply can only be used with noMux",eg.InvalidOption));if(r.noMux){let i=r.reply?r.reply:y(this.options.inboxPrefix),n=x(),o=s?Error():null,a=this.subscribe(i,{max:1,timeout:r.timeout,callback:(e,t)=>{e?(o&&e.code!==eg.Timeout&&(e.stack+=`

${o.stack}`),a.unsubscribe(),n.reject(e)):(e=T(t))?(o&&(e.stack+=`

${o.stack}`),n.reject(e)):n.resolve(t)}});return a.requestSubject=e,this.protocol.publish(e,t,{reply:i,headers:r.headers}),n}{let i=new eY(this.protocol.muxSubscriptions,e,r,s);this.protocol.request(i);try{this.publish(e,t,{reply:`${this.protocol.muxSubscriptions.baseInbox}${i.token}`,headers:r.headers})}catch(e){i.cancel(e)}let n=Promise.race([i.timer,i.deferred]);return n.catch(()=>{i.cancel()}),n}}flush(){return this.isClosed()?Promise.reject(m.errorForCode(eg.ConnectionClosed)):this.protocol.flush()}drain(){return this.isClosed()?Promise.reject(m.errorForCode(eg.ConnectionClosed)):this.isDraining()?Promise.reject(m.errorForCode(eg.ConnectionDraining)):(this.draining=!0,this.protocol.drain())}isClosed(){return this.protocol.isClosed()}isDraining(){return this.draining}getServer(){let e=this.protocol.getServer();return e?e.listen:""}status(){let e=new z;return e.iterClosed.then(()=>{let t=this.listeners.indexOf(e);this.listeners.splice(t,1)}),this.listeners.push(e),e}get info(){return this.protocol.isClosed()?void 0:this.protocol.info}async context(){return(await this.request("$SYS.REQ.USER.INFO")).json((e,t)=>"time"===e?new Date(Date.parse(t)):t)}stats(){return{inBytes:this.protocol.inBytes,outBytes:this.protocol.outBytes,inMsgs:this.protocol.inMsgs,outMsgs:this.protocol.outMsgs}}async jetstreamManager(e={}){let t=new t7(this,e);if(!1!==e.checkAPI)try{await t.getAccountInfo()}catch(e){throw e.code===eg.NoResponders&&(e.code=eg.JetStreamNotEnabled),e}return t}jetstream(e={}){return new rn(this,e)}getServerVersion(){let e=this.info;return e?eQ(e.version):void 0}async rtt(){if(!this.protocol._closed&&!this.protocol.connected)throw m.errorForCode(eg.Disconnect);let e=Date.now();return await this.flush(),Date.now()-e}get features(){return this.protocol.features}get services(){return this._services||(this._services=new ra(this)),this._services}reconnect(){return this.isClosed()?Promise.reject(m.errorForCode(eg.ConnectionClosed)):this.isDraining()?Promise.reject(m.errorForCode(eg.ConnectionDraining)):this.protocol.reconnect()}}class ra{nc;constructor(e){this.nc=e}add(e){try{return new tk(this.nc,e).start()}catch(e){return Promise.reject(e)}}client(e,t){return new tj(this.nc,e,t)}}class rh{bucket;sm;prefixLen;constructor(e,t,r){this.bucket=e,this.prefixLen=t,this.sm=r}get key(){return this.sm.subject.substring(this.prefixLen)}get value(){return this.sm.data}get delta(){return 0}get created(){return this.sm.time}get revision(){return this.sm.seq}get operation(){return this.sm.header.get(tN)||"PUT"}get length(){let e=this.sm.header.get(eI.MessageSizeHdr)||"";return""!==e?parseInt(e,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class rc{bucket;key;sm;constructor(e,t,r){this.bucket=e,this.key=t,this.sm=r}get value(){return this.sm.data}get created(){return new Date(k(this.sm.info.timestampNanos))}get revision(){return this.sm.seq}get operation(){return this.sm.headers?.get(tN)||"PUT"}get delta(){return this.sm.info.pending}get length(){let e=this.sm.headers?.get(eI.MessageSizeHdr)||"";return""!==e?parseInt(e,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class ru extends e5{js;monitor;constructor(e,t,r){super(e.nc,t,r),this.js=e,this.monitor=null,this.sub.closed.then(()=>{this.monitor&&this.monitor.cancel()})}set info(e){this.sub.info=e}get info(){return this.sub.info}_resetOrderedConsumer(e){if(null===this.info||this.sub.isClosed())return;let t=y(this.js.nc.options.inboxPrefix);this.js.nc._resub(this.sub,t);let r=this.info;r.config.name=d.next(),r.ordered_consumer_sequence.delivery_seq=0,r.flow_control.heartbeat_count=0,r.flow_control.fc_count=0,r.flow_control.consumer_restarts++,r.deliver=t,r.config.deliver_subject=t,r.config.deliver_policy=eA.StartSequence,r.config.opt_start_seq=e;let s={};s.stream_name=this.info.stream,s.config=r.config;let i=`${r.api.prefix}.CONSUMER.CREATE.${r.stream}`;this.js._request(i,s,{retries:-1}).then(e=>{this.sub.info.last=e,this.info.config=e.config,this.info.name=e.name}).catch(t=>{let s=new m(`unable to recreate ordered consumer ${r.stream} at seq ${e}`,eg.RequestError,t);this.sub.callback(s,{})})}_maybeSetupHbMonitoring(){let e=this.info?.config?.idle_heartbeat||0;e&&this._setupHbMonitoring(k(e))}_setupHbMonitoring(e,t=0){let r={cancelAfter:0,maxOut:2};t&&(r.cancelAfter=t);let s=this.sub;this.monitor=new G(e,e=>{let t=function(e,t,r){let s=j(409,t),i=new $({hdr:1,sid:0,size:0},n,{});return i._headers=s,i._subject=r,i}(0,`${eS.IdleHeartbeatMissed}: ${e}`,this.sub.subject);if(this.info?.ordered){if(!this.js.nc.protocol.connected)return!1;let e=this.info?.ordered_consumer_sequence?.stream_seq||0;return this._resetOrderedConsumer(e+1),this.monitor?.restart(),!1}return this.sub.callback(null,t),!s.noIterator},r)}_checkHbOrderConsumer(e){let t=e.headers.get(eI.ConsumerStalledHdr);""!==t&&this.js.nc.publish(t);let r=parseInt(e.headers.get(eI.LastConsumerSeqHdr),10),s=this.info.ordered_consumer_sequence;return this.info.flow_control.heartbeat_count++,r!==s.delivery_seq&&this._resetOrderedConsumer(s.stream_seq+1),!1}_checkOrderedConsumer(e){let t=this.info.ordered_consumer_sequence,r=e.info.streamSequence,s=e.info.deliverySequence;return s!=t.delivery_seq+1?(this._resetOrderedConsumer(t.stream_seq+1),!1):(t.delivery_seq=s,t.stream_seq=r,!0)}async destroy(){this.isClosed()||await this.drain();let e=this.sub.info,t=e.config.durable_name||e.name,r=`${e.api.prefix}.CONSUMER.DELETE.${e.stream}.${t}`;await e.api._request(r)}async consumerInfo(){let e=this.sub.info,t=e.config.durable_name||e.name,r=`${e.api.prefix}.CONSUMER.INFO.${e.stream}.${t}`,s=await e.api._request(r);return e.last=s,s}}class rl extends ru{constructor(e,t,r){super(e,t,r)}pull(e={batch:1}){let{stream:t,config:r,name:s}=this.sub.info,i=r.durable_name??s,n={};if(n.batch=e.batch||1,n.no_wait=e.no_wait||!1,(e.max_bytes??0)>0){let t=this.js.nc.features.get(Q.JS_PULL_MAX_BYTES);if(!t.ok)throw Error(`max_bytes is only supported on servers ${t.min} or better`);n.max_bytes=e.max_bytes}let o=0;e.expires&&e.expires>0&&(o=e.expires,n.expires=O(o));let a=0;if(e.idle_heartbeat&&e.idle_heartbeat>0&&(a=e.idle_heartbeat,n.idle_heartbeat=O(a)),a&&0===o)throw Error("idle_heartbeat requires expires");if(a>o)throw Error("expires must be greater than idle_heartbeat");if(this.info){this.monitor&&this.monitor.cancel(),o&&a&&(this.monitor?this.monitor._change(a,o):this._setupHbMonitoring(a,o));let e=this.info.api,r=`${e.prefix}.CONSUMER.MSG.NEXT.${t}.${i}`,s=this.sub.subject;e.nc.publish(r,e.jc.encode(n),{reply:s})}}}function rd(e){if(null!==e)switch(e.code){case eg.JetStream404NoMessages:case eg.JetStream408RequestTimeout:break;case eg.JetStream409:if(e.code===eg.JetStream409&&void 0!==[eS.MaxBatchExceeded,eS.MaxExpiresExceeded,eS.MaxBytesExceeded,eS.MaxMessageSizeExceeded,eS.PushConsumer,eS.IdleHeartbeatMissed,eS.ConsumerDeleted].find(t=>-1!==e.message.indexOf(t)))return e;break;default:return e}return null}function rf(e){e&&e.ack()}class rp{msg;di;didAck;timeout;constructor(e,t){this.msg=e,this.didAck=!1,this.timeout=t}get subject(){return this.msg.subject}get sid(){return this.msg.sid}get data(){return this.msg.data}get headers(){return this.msg.headers}get info(){return this.di||(this.di=function(e){let t=e.split(".");if(9===t.length&&t.splice(2,0,"_",""),t.length<11||"$JS"!==t[0]||"ACK"!==t[1])throw Error("not js message");let r={};return r.domain="_"===t[2]?"":t[2],r.account_hash=t[3],r.stream=t[4],r.consumer=t[5],r.deliveryCount=parseInt(t[6],10),r.redeliveryCount=r.deliveryCount,r.redelivered=r.deliveryCount>1,r.streamSequence=parseInt(t[7],10),r.deliverySequence=parseInt(t[8],10),r.timestampNanos=parseInt(t[9],10),r.pending=parseInt(t[10],10),r}(this.reply)),this.di}get redelivered(){return this.info.deliveryCount>1}get reply(){return this.msg.reply||""}get seq(){return this.info.streamSequence}doAck(e){this.didAck||(this.didAck=!this.isWIP(e),this.msg.respond(e))}isWIP(e){return 4===e.length&&e[0]===tV[0]&&e[1]===tV[1]&&e[2]===tV[2]&&e[3]===tV[3]}async ackAck(e){(e=e||{}).timeout=e.timeout||this.timeout;let t=x();if(this.didAck)t.resolve(!1);else if(this.didAck=!0,this.msg.reply){let r=this.msg.publisher,s=!r.options?.noAsyncTraces,i=new eY(r.muxSubscriptions,this.msg.reply,{timeout:e.timeout},s);r.request(i);try{r.publish(this.msg.reply,tG,{reply:`${r.muxSubscriptions.baseInbox}${i.token}`})}catch(e){i.cancel(e)}try{await Promise.race([i.timer,i.deferred]),t.resolve(!0)}catch(e){i.cancel(e),t.reject(e)}}else t.resolve(!1);return t}ack(){this.doAck(tG)}nak(e){let t=tK;e&&(t=M().encode(`-NAK ${JSON.stringify({delay:O(e)})}`)),this.doAck(t)}working(){this.doAck(tV)}next(e,t={batch:1}){let r={};r.batch=t.batch||1,r.no_wait=t.no_wait||!1,t.expires&&t.expires>0&&(r.expires=O(t.expires));let s=R().encode(r),i=Z.concat(tW,tX,s);this.msg.respond(i,e?{reply:e}:void 0)}term(e=""){let t=tY;e?.length>0&&(t=M().encode(`+TERM ${e}`)),this.doAck(t)}json(){return this.msg.json()}string(){return this.msg.string()}}Symbol.asyncIterator}};