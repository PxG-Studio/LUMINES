"use strict";exports.id=7176,exports.ids=[7176],exports.modules={5110:(e,r,t)=>{t.d(r,{SQ:()=>T,PZ:()=>A});var n=t(5427),a=t(4292),i=t(81274),o=t(55547),s=t(6091),d=t(60114);let u=null,l=0;async function _(){let e=d.OB.NEXT_PUBLIC_NOCTURNA_ID_URL||"https://nocturnaID.org",r=`${e}/.well-known/jwks.json`;try{let e=await fetch(r,{cache:"no-store"});if(!e.ok)throw Error(`Failed to fetch JWKS: ${e.status} ${e.statusText}`);return await e.json()}catch(e){throw console.error("Error fetching JWKS:",e),Error("Failed to fetch JWKS from nocturnaID.org")}}async function c(){let e=Date.now();return u&&e<l||(u=await _(),l=e+36e5),u}async function p(e){return(await c()).keys.find(r=>r.kid===e)||null}async function A(e){try{let r=n.U(e);if(!r.kid)return console.error("JWT missing kid in header"),null;let t=await p(r.kid);if(!t)return console.error(`JWK not found for kid: ${r.kid}`),null;let o=await a.nO(t,r.alg||"RS256"),s=d.OB.NEXT_PUBLIC_NOCTURNA_ID_URL||"https://nocturnaID.org",u=d.OB.NOCTURNA_JWT_AUDIENCE||"lumines.nocturna.network",{payload:l}=await i._(e,o,{issuer:s,audience:u,algorithms:["RS256"]}),_={sub:l.sub,email:l.email,roles:l.roles||[],iat:l.iat,exp:l.exp,iss:l.iss,aud:l.aud};if(!_.sub||!_.email)return console.error("JWT missing required claims (sub or email)"),null;return _}catch(e){if(e instanceof o.fy)return console.error("JWT token expired"),null;if(e instanceof o.uv)return console.error("JWT token invalid:",e.message),null;if(e instanceof o.nx)return console.error("JWT signature verification failed"),null;return console.error("JWT verification error:",e),null}}async function T(e,r=["user"],t="15m"){let n=new TextEncoder().encode(d.OB.NOCTURNA_JWT_SECRET||"change-me-in-production"),a=d.OB.NOCTURNA_JWT_AUDIENCE||"lumines.nocturna.network",i=d.OB.NOCTURNA_JWT_ISSUER||"lumines.nocturna.network";return await new s.N({sub:e,roles:r}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(t).setIssuer(i).setAudience(a).sign(n)}},60114:(e,r,t)=>{t.d(r,{EN:()=>s,OB:()=>o,sQ:()=>d,xw:()=>u});var n=t(91585),a=t(26033);let i=n.Ry({NODE_ENV:n.Km(["development","production","test"]).default("development"),NEXT_PUBLIC_APP_URL:n.Z_().url().optional(),NEXT_PUBLIC_API_BASE:n.Z_().url().optional(),NEXT_PUBLIC_LUMENFORGE_DOMAIN:n.Z_().default("lumenforge.io"),NEXT_PUBLIC_NOCTURNA_ID_URL:n.Z_().url().optional(),DATABASE_URL:n.Z_().url().optional(),DATABASE_HOST:n.Z_().default("192.168.86.27"),DATABASE_PORT:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("5432"),DATABASE_NAME:n.Z_().default("lumines"),DATABASE_USER:n.Z_().optional(),DATABASE_PASSWORD:n.Z_().optional(),DATABASE_POOL_MIN:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("2"),DATABASE_POOL_MAX:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("10"),REDIS_URL:n.Z_().url().optional(),REDIS_HOST:n.Z_().default("192.168.86.27"),REDIS_PORT:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("6379"),REDIS_PASSWORD:n.Z_().optional(),REDIS_DB:n.Z_().transform(Number).pipe(n.Rx().int().min(0).max(15)).default("0"),REDIS_TTL:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("3600"),NATS_URL:n.Z_().url().optional(),NATS_HOST:n.Z_().default("192.168.86.27"),NATS_PORT:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("4222"),NATS_CLUSTER:n.Z_().default("lumines-cluster"),NATS_USER:n.Z_().optional(),NATS_PASSWORD:n.Z_().optional(),REGISTRY_URL:n.Z_().url().optional(),REGISTRY_HOST:n.Z_().default("192.168.86.27"),REGISTRY_PORT:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("5000"),REGISTRY_USER:n.Z_().optional(),REGISTRY_PASSWORD:n.Z_().optional(),K8S_NAMESPACE:n.Z_().default("lumines"),K8S_CONTROL_NODE_IP:n.Z_().ip().default("192.168.86.114"),K8S_COMPUTE_NODE_IP:n.Z_().ip().default("192.168.86.115"),PORT_LANDING:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("3000"),PORT_SLATE:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("3001"),PORT_IGNITION:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("3002"),PORT_SPARK:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("3003"),PORT_IGNIS:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("3004"),PORT_WAYPOINT:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("3005"),NOCTURNA_JWT_SECRET:n.Z_().optional(),NOCTURNA_JWT_AUDIENCE:n.Z_().default("lumines.nocturna.network"),NOCTURNA_JWT_ISSUER:n.Z_().default("lumines.nocturna.network"),NEXTAUTH_SECRET:n.Z_().optional(),NEXTAUTH_URL:n.Z_().url().optional(),GOOGLE_CLIENT_ID:n.Z_().optional(),GOOGLE_CLIENT_SECRET:n.Z_().optional(),GITHUB_CLIENT_ID:n.Z_().optional(),GITHUB_CLIENT_SECRET:n.Z_().optional(),SPARK_AI_ENDPOINT:n.Z_().url().optional(),SPARK_AI_API_KEY:n.Z_().optional(),SPARK_ANTHROPIC_API_KEY:n.Z_().optional(),RATE_LIMIT_FREE:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("10"),RATE_LIMIT_PRO:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("100"),RATE_LIMIT_ENTERPRISE:n.Z_().transform(Number).pipe(n.Rx().int().positive()).default("1000")}),o=function(){try{return i.parse(process.env)}catch(e){if(e instanceof a.jm){let r=e.errors.filter(e=>"invalid_type"===e.code&&"undefined"===e.received).map(e=>e.path.join(".")).join(", "),t=e.errors.filter(e=>"invalid_type"!==e.code).map(e=>`${e.path.join(".")}: ${e.message}`).join("\n  ");throw Error(["âŒ Environment configuration validation failed!","",r?`Missing required variables:
  ${r}
`:"",t?`Invalid variable values:
  ${t}
`:"","See .env.example for required variables."].filter(Boolean).join("\n"))}throw e}}();o.NEXT_PUBLIC_APP_URL||(o.K8S_CONTROL_NODE_IP,o.PORT_LANDING),o.K8S_COMPUTE_NODE_IP,o.PORT_SLATE,o.K8S_CONTROL_NODE_IP,o.PORT_IGNITION,o.K8S_COMPUTE_NODE_IP,o.PORT_SPARK,o.K8S_CONTROL_NODE_IP,o.PORT_IGNIS,o.K8S_COMPUTE_NODE_IP,o.PORT_WAYPOINT;let s=()=>{if(o.DATABASE_URL)return o.DATABASE_URL;if(!o.DATABASE_USER||!o.DATABASE_PASSWORD)throw Error("Either DATABASE_URL or both DATABASE_USER and DATABASE_PASSWORD must be provided");return`postgresql://${o.DATABASE_USER}:${o.DATABASE_PASSWORD}@${o.DATABASE_HOST}:${o.DATABASE_PORT}/${o.DATABASE_NAME}`},d=()=>{if(o.REDIS_URL)return o.REDIS_URL;let e=o.REDIS_PASSWORD?`:${o.REDIS_PASSWORD}@`:"";return`redis://${e}${o.REDIS_HOST}:${o.REDIS_PORT}/${o.REDIS_DB}`},u=()=>{if(o.NATS_URL)return o.NATS_URL;let e=o.NATS_USER&&o.NATS_PASSWORD?`${o.NATS_USER}:${o.NATS_PASSWORD}@`:"";return`nats://${e}${o.NATS_HOST}:${o.NATS_PORT}`}},64199:(e,r,t)=>{t.d(r,{prisma:()=>o});var n={};t.r(n);var a=t(53524),i=t(60114);(0,i.EN)(),i.OB.DATABASE_HOST,i.OB.DATABASE_PORT,i.OB.DATABASE_NAME,i.OB.DATABASE_USER,i.OB.DATABASE_PASSWORD,i.OB.DATABASE_POOL_MIN,i.OB.DATABASE_POOL_MAX,i.OB.NODE_ENV;let o=globalThis.prisma??new a.PrismaClient({datasources:{db:{url:(0,n.getDatabaseUrl)()}},log:["error"]})},41567:(e,r,t)=>{t.d(r,{Gi:()=>d,SX:()=>u,Vq:()=>a,WJ:()=>i,b_:()=>s,nI:()=>_,rN:()=>o,yu:()=>l});var n=t(64199);let a={findById:async e=>n.prisma.user.findUnique({where:{id:e},select:{id:!0,email:!0,name:!0,avatar:!0,roles:!0,nocturnaId:!0,jwtSubject:!0,createdAt:!0,updatedAt:!0,lastLoginAt:!0}}),findByEmail:async e=>n.prisma.user.findUnique({where:{email:e},select:{id:!0,email:!0,name:!0,avatar:!0,roles:!0,nocturnaId:!0,jwtSubject:!0,createdAt:!0,updatedAt:!0,lastLoginAt:!0}}),findByNocturnaId:async e=>n.prisma.user.findUnique({where:{nocturnaId:e}}),create:async e=>n.prisma.user.create({data:e}),update:async(e,r)=>n.prisma.user.update({where:{id:e},data:r})},i={findAll:async e=>n.prisma.project.findMany({where:e?{userId:e}:void 0,include:{user:!0,template:!0,_count:{select:{components:!0,builds:!0,deployments:!0}}},orderBy:{updatedAt:"desc"}}),findById:async e=>n.prisma.project.findUnique({where:{id:e},include:{user:!0,template:!0,components:!0,builds:{take:10,orderBy:{createdAt:"desc"}},deployments:{take:10,orderBy:{createdAt:"desc"}}}}),findBySlug:async e=>n.prisma.project.findUnique({where:{slug:e},include:{user:!0}}),create:async e=>n.prisma.project.create({data:e,include:{user:!0}}),update:async(e,r)=>n.prisma.project.update({where:{id:e},data:r}),delete:async e=>n.prisma.project.delete({where:{id:e}})},o={findAll:async e=>n.prisma.component.findMany({where:e?{projectId:e}:void 0,include:{user:!0,project:!0},orderBy:{createdAt:"desc"}}),findByProjectId:async e=>n.prisma.component.findMany({where:{projectId:e},orderBy:{createdAt:"desc"}}),findById:async e=>n.prisma.component.findUnique({where:{id:e},include:{user:!0,project:!0}}),create:async e=>n.prisma.component.create({data:e,include:{user:!0,project:!0}}),update:async(e,r)=>n.prisma.component.update({where:{id:e},data:r}),delete:async e=>n.prisma.component.delete({where:{id:e}})},s={findAll:async()=>n.prisma.designToken.findMany({orderBy:[{category:"asc"},{name:"asc"}]}),findByCategory:async e=>n.prisma.designToken.findMany({where:{category:e},orderBy:{name:"asc"}}),findByGroup:async e=>n.prisma.designToken.findMany({where:{group:e},orderBy:{name:"asc"}}),findById:async e=>n.prisma.designToken.findUnique({where:{id:e}}),create:async e=>n.prisma.designToken.create({data:e}),update:async(e,r)=>n.prisma.designToken.update({where:{id:e},data:r}),upsert:async(e,r,t)=>n.prisma.designToken.upsert({where:{name_category:{name:e,category:r}},update:t,create:t})},d={findAll:async e=>n.prisma.build.findMany({where:e?{projectId:e}:void 0,include:{project:!0,user:!0},orderBy:{createdAt:"desc"}}),findByProjectId:async e=>n.prisma.build.findMany({where:{projectId:e},orderBy:{createdAt:"desc"},take:50}),findById:async e=>n.prisma.build.findUnique({where:{id:e},include:{project:!0,user:!0}}),create:async e=>n.prisma.build.create({data:e,include:{project:!0}}),update:async(e,r)=>n.prisma.build.update({where:{id:e},data:r})},u={findAll:async e=>n.prisma.deployment.findMany({where:e?{projectId:e}:void 0,include:{project:!0,user:!0},orderBy:{createdAt:"desc"}}),findByProjectId:async e=>n.prisma.deployment.findMany({where:{projectId:e},orderBy:{createdAt:"desc"},take:50}),findById:async e=>n.prisma.deployment.findUnique({where:{id:e},include:{project:!0,user:!0}}),create:async e=>n.prisma.deployment.create({data:e,include:{project:!0}}),update:async(e,r)=>n.prisma.deployment.update({where:{id:e},data:r})},l={findAll:async e=>n.prisma.template.findMany({where:e?{engine:e}:void 0,orderBy:{createdAt:"desc"}}),findBySlug:async e=>n.prisma.template.findUnique({where:{slug:e}}),findById:async e=>n.prisma.template.findUnique({where:{id:e}}),create:async e=>n.prisma.template.create({data:e}),update:async(e,r)=>n.prisma.template.update({where:{id:e},data:r})},_={create:async e=>n.prisma.event.create({data:e}),findBySubsystem:async(e,r=100)=>n.prisma.event.findMany({where:{subsystem:e},orderBy:{createdAt:"desc"},take:r}),findByProjectId:async(e,r=100)=>n.prisma.event.findMany({where:{projectId:e},orderBy:{createdAt:"desc"},take:r})}},17176:(e,r,t)=>{t.d(r,{PZ:()=>o,YR:()=>s,jl:()=>i});var n=t(41567),a=t(5110);function i(e){let r=e.headers.get("authorization");return r&&r.startsWith("Bearer ")?r.substring(7):null}async function o(e){return(0,a.PZ)(e)}async function s(e){let r=i(e);if(!r)return{request:e,error:{status:401,message:"Missing or invalid authorization header"}};let t=await o(r);if(!t)return{request:e,error:{status:401,message:"Invalid or expired token"}};let a=await n.Vq.findByNocturnaId(t.sub);return a||(a=await n.Vq.create({email:t.email,nocturnaId:t.sub,jwtSubject:t.sub,roles:t.roles})),e.user={id:a.id,email:a.email,roles:a.roles,nocturnaId:a.nocturnaId},{request:e}}}};