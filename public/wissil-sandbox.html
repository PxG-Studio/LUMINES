<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>WISSIL Sandbox</title>
</head>
<body>
<script>
  // Capture console logs & forward to parent
  const send = (type, payload) => {
    parent.postMessage({ wissil: true, type, payload }, "*");
  };

  // Intercept console methods
  const originalLog = console.log;
  const originalError = console.error;
  const originalWarn = console.warn;
  const originalInfo = console.info;
  const originalDebug = console.debug;

  console.log = (...args) => {
    originalLog.apply(console, args);
    send("log", args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(" "));
  };

  console.error = (...args) => {
    originalError.apply(console, args);
    send("error", args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(" "));
  };

  console.warn = (...args) => {
    originalWarn.apply(console, args);
    send("warn", args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(" "));
  };

  console.info = (...args) => {
    originalInfo.apply(console, args);
    send("log", args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(" "));
  };

  console.debug = (...args) => {
    originalDebug.apply(console, args);
    send("log", args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(" "));
  };

  // Global error handler
  window.onerror = (msg, url, line, col, err) => {
    const errorMsg = err ? err.toString() : String(msg);
    const location = line !== undefined ? ` @ ${line}:${col || 0}` : "";
    send("runtime-error", errorMsg + location);
    return false;
  };

  // Unhandled promise rejection
  window.addEventListener("unhandledrejection", (event) => {
    const errorMsg = event.reason ? String(event.reason) : "Unhandled Promise Rejection";
    send("runtime-error", errorMsg);
  });

  // Receive bundle from parent
  window.addEventListener("message", (event) => {
    const { wissil, type, bundle } = event.data;
    if (!wissil) return;

    if (type === "execute") {
      try {
        // Reset previous globals (clean slate for each run)
        const protectedKeys = new Set([
          "window", "self", "globalThis",
          "console", "postMessage", "onmessage", "parent",
          "document", "location", "navigator", "history",
          "localStorage", "sessionStorage", "indexedDB"
        ]);

        // Clean up custom properties
        for (const k of Object.keys(window)) {
          if (!protectedKeys.has(k)) {
            try {
              delete window[k];
            } catch (e) {
              // Ignore deletion errors
            }
          }
        }

        // Execute code inside closure for isolation
        const fn = new Function(bundle);
        fn();

        send("ready", "Execution complete");
      } catch (err) {
        const errorMsg = err instanceof Error ? err.toString() : String(err);
        send("runtime-error", errorMsg);
      }
    }

    if (type === "reset") {
      // Reset sandbox state
      location.reload();
    }
  });

  // Signal ready to parent
  send("ready", "Sandbox initialized");
</script>
</body>
</html>

